<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Calculator Dashboard</title>
    <link rel="icon" type="image/png" href="static/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
          /* Modern Color Palette */
          --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          --danger-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          --warning-gradient: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);

          /* Glass Morphism */
          --glass-bg: rgba(255, 255, 255, 0.95);
          --glass-border: rgba(255, 255, 255, 0.2);
          --glass-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
          --glass-shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.15);

          /* Spacing */
          --border-radius-sm: 12px;
          --border-radius-md: 16px;
          --border-radius-lg: 20px;
          --border-radius-xl: 24px;

          /* Transitions */
          --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: "Inter", sans-serif;
        }

        body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          background-attachment: fixed;
          min-height: 100vh;
          color: #333;
          position: relative;
          overflow-x: hidden;
        }

        /* Modern animated background */
        body::before {
          content: '';
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background:
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
          animation: backgroundFloat 20s ease-in-out infinite;
          pointer-events: none;
          z-index: -1;
        }

        @keyframes backgroundFloat {
          0%, 100% { transform: translateY(0px) rotate(0deg); }
          33% { transform: translateY(-20px) rotate(1deg); }
          66% { transform: translateY(10px) rotate(-1deg); }
        }

        .dashboard-container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 24px;
          position: relative;
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }

        ::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 10px;
          transition: var(--transition-smooth);
        }

        ::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Smooth scroll behavior */
        html {
          scroll-behavior: smooth;
        }

        /* Header Styles */
        .dashboard-header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          padding: 32px;
          margin-bottom: 32px;
          box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.5) inset;
          position: relative;
          overflow: hidden;
        }

        .dashboard-header::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), transparent);
        }

        .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 16px;
        }

        .dashboard-title {
          font-size: 2.5rem;
          font-weight: 800;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 200% 200%;
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          margin-bottom: 8px;
          animation: gradientShift 4s ease-in-out infinite;
          letter-spacing: -0.02em;
        }

        @keyframes gradientShift {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
        }

        .dashboard-subtitle {
          color: #666;
          font-size: 1.1rem;
        }

        .header-right {
          display: flex;
          align-items: center;
          gap: 16px;
        }

        /* Dark Theme Variables */
        :root {
          --bg-primary: #ffffff;
          --bg-secondary: #f8f9fa;
          --text-primary: #333333;
          --text-secondary: #666666;
          --border-color: #e9ecef;
          --shadow-light: rgba(0, 0, 0, 0.1);
          --shadow-medium: rgba(0, 0, 0, 0.15);
          --card-bg: rgba(255, 255, 255, 0.95);
          --glass-bg: rgba(255, 255, 255, 0.95);
          --clock-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --clock-text: #ffffff;
          --clock-shadow: rgba(102, 126, 234, 0.3);
        }

        [data-theme="dark"] {
          --bg-primary: #1a1a1a;
          --bg-secondary: #2d2d2d;
          --text-primary: #ffffff;
          --text-secondary: #cccccc;
          --border-color: #404040;
          --shadow-light: rgba(0, 0, 0, 0.3);
          --shadow-medium: rgba(0, 0, 0, 0.5);
          --card-bg: rgba(45, 45, 45, 0.95);
          --glass-bg: rgba(45, 45, 45, 0.95);
          --clock-bg: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
          --clock-text: #ffffff;
          --clock-shadow: rgba(74, 85, 104, 0.5);
        }

        /* Apply theme variables */
        body {
          background: var(--bg-primary);
          color: var(--text-primary);
          transition: all 0.3s ease;
        }

        .dashboard-header {
          background: var(--glass-bg);
          border: 1px solid var(--border-color);
        }

        .dashboard-title {
          color: var(--text-primary);
        }

        .dashboard-subtitle {
          color: var(--text-secondary);
        }

        /* Update other elements for theme support */
        .calculator-card, .input-card, .reminder-item {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        .card-header {
          background: var(--clock-bg);
          color: var(--clock-text);
        }

        .card-content {
          background: var(--card-bg);
          color: var(--text-primary);
        }

        .btn {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        .btn:hover {
          background: var(--bg-secondary);
        }

        .tab-btn {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        .tab-btn.active {
          background: var(--clock-bg);
          color: var(--clock-text);
        }

        .history-card {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        input, select, textarea {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        input:focus, select:focus, textarea:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Modern Flip Clock Styles */
        .modern-clock-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 8px;
          margin-right: 16px;
          text-align: center;
        }

        .modern-flip-clock {
          background: var(--card-bg);
          border-radius: 16px;
          padding: 16px 20px;
          box-shadow:
            0 8px 32px var(--shadow-medium),
            0 1px 0 rgba(255, 255, 255, 0.1) inset;
          border: 1px solid var(--border-color);
          backdrop-filter: blur(20px);
        }

        .time-display {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
        }

        .flip-digit-group {
          display: flex;
          gap: 4px;
        }

        .flip-digit {
          position: relative;
          width: 32px;
          height: 44px;
          perspective: 1000px;
        }

        .flip-digit-inner {
          position: relative;
          width: 100%;
          height: 100%;
          text-align: center;
          transition: transform 0.6s ease-in-out;
          transform-style: preserve-3d;
        }

        .flip-digit.flipping .flip-digit-inner {
          transform: rotateX(180deg);
        }

        .flip-digit-front, .flip-digit-back {
          position: absolute;
          width: 100%;
          height: 100%;
          backface-visibility: hidden;
          background: var(--clock-bg);
          color: var(--clock-text);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.4rem;
          font-weight: 700;
          font-family: 'Courier New', monospace;
          box-shadow:
            0 4px 12px var(--clock-shadow),
            0 1px 0 rgba(255, 255, 255, 0.2) inset;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flip-digit-back {
          transform: rotateX(180deg);
        }

        .time-separator {
          font-size: 1.6rem;
          font-weight: 700;
          color: var(--text-primary);
          margin: 0 6px;
          animation: pulse 2s infinite;
          font-family: 'Courier New', monospace;
        }

        @keyframes pulse {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0.4; }
        }

        .am-pm-indicator {
          background: var(--clock-bg);
          color: var(--clock-text);
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.9rem;
          font-weight: 600;
          margin-left: 8px;
          box-shadow: 0 2px 8px var(--clock-shadow);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .clock-details {
          text-align: center;
          font-size: 0.75rem;
          color: var(--text-secondary);
        }

        .timezone-info {
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 2px;
        }

        .date-info {
          font-size: 0.7rem;
        }

        /* Theme Toggle Button */
        .theme-toggle-btn {
          background: var(--card-bg);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
          padding: 10px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 40px;
          height: 40px;
          box-shadow: 0 4px 12px var(--shadow-light);
          backdrop-filter: blur(20px);
        }

        .theme-toggle-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px var(--shadow-medium);
        }

        .timetable-btn {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          padding: 14px 24px;
          border: none;
          border-radius: 16px;
          text-decoration: none;
          font-weight: 600;
          font-size: 0.95rem;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          gap: 10px;
          cursor: pointer;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .timetable-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.6s;
        }

        .timetable-btn:hover::before {
          left: 100%;
        }

        .timetable-btn:hover {
          background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        /* Header Stacking Styles */
        .clock-countdown-stack {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
        }

        .theme-logout-stack {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
        }

        /* Exam Countdown Styles */
        .exam-countdown {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
          color: white;
          padding: 10px 16px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
          animation: pulse 2s infinite;
          min-width: 180px;
          text-align: center;
        }

        .countdown-content {
          text-align: center;
        }

        .countdown-title {
          font-size: 0.7rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          opacity: 0.9;
          margin-bottom: 2px;
        }

        .countdown-subject {
          font-size: 0.85rem;
          font-weight: 700;
          margin-bottom: 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .countdown-timer {
          font-size: 0.75rem;
          font-weight: 500;
          opacity: 0.95;
        }

        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.02); }
        }

        .logout-btn {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
          padding: 10px 16px;
          border: none;
          border-radius: 12px;
          text-decoration: none;
          font-weight: 600;
          font-size: 0.85rem;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          gap: 8px;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .logout-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.6s;
        }

        .logout-btn:hover::before {
          left: 100%;
        }

        .logout-btn:hover {
          background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        /* Smart Reminders Styles */
        .reminders-header {
          text-align: center;
          margin-bottom: 32px;
        }

        .reminders-header h2 {
          font-size: 2.2rem;
          font-weight: 700;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          margin-bottom: 8px;
        }

        .feature-description {
          color: #666;
          font-size: 1.1rem;
          max-width: 600px;
          margin: 0 auto;
        }

        .message-input-section,
        .reminder-form-section,
        .reminders-display-section {
          margin-bottom: 32px;
        }

        .input-card {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.5) inset;
          overflow: hidden;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-card:hover {
          transform: translateY(-5px);
          box-shadow:
            0 30px 60px rgba(0, 0, 0, 0.15),
            0 1px 0 rgba(255, 255, 255, 0.5) inset;
        }

        .card-header {
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          padding: 20px 24px;
          border-bottom: 1px solid #e9ecef;
        }

        .card-header h3 {
          font-size: 1.3rem;
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
        }

        .card-header p {
          color: #666;
          font-size: 0.95rem;
          margin: 0;
        }

        .card-content {
          padding: 24px;
        }

        .form-grid {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 20px;
          margin-bottom: 20px;
        }

        .form-grid .full-width {
          grid-column: 1 / -1;
        }

        .input-group {
          display: flex;
          flex-direction: column;
        }

        .input-group label {
          font-weight: 500;
          color: #333;
          margin-bottom: 8px;
          font-size: 0.95rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
          padding: 16px 20px;
          border: 2px solid #e9ecef;
          border-radius: var(--border-radius-md);
          font-size: 1rem;
          transition: var(--transition-smooth);
          font-family: inherit;
          background: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(10px);
          position: relative;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
          outline: none;
          border-color: #667eea;
          box-shadow:
            0 0 0 4px rgba(102, 126, 234, 0.1),
            0 8px 25px rgba(102, 126, 234, 0.15);
          transform: translateY(-2px);
          background: rgba(255, 255, 255, 0.95);
        }

        .input-group input:hover,
        .input-group select:hover,
        .input-group textarea:hover {
          border-color: #b8c5f2;
          transform: translateY(-1px);
        }

        .input-group textarea {
          resize: vertical;
          min-height: 100px;
        }

        /* Time input specific styling */
        .input-group input[type="time"] {
          max-width: 200px;
        }

        /* Help text styling */
        .input-help {
          font-size: 0.85rem;
          color: #666;
          margin-top: 4px;
          font-style: italic;
        }

        /* 12-hour time input styling */
        .time-input-container {
          display: flex;
          align-items: center;
          gap: 6px;
          flex-wrap: nowrap;
        }

        .time-select {
          padding: 6px 8px;
          border: 2px solid #e1e5e9;
          border-radius: 6px;
          background: white;
          font-size: 13px;
          color: #333;
          min-width: 50px;
          transition: all 0.3s ease;
        }

        .time-select:focus {
          outline: none;
          border-color: #6c5ce7;
          box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.1);
        }

        .time-separator {
          font-weight: bold;
          color: #666;
          font-size: 14px;
          margin: 0 2px;
        }

        /* Time and description layout */
        .time-description-row {
          display: flex;
          gap: 16px;
          align-items: flex-start;
        }

        .time-description-row .input-group {
          flex: 0 0 auto;
          min-width: 200px;
        }

        .time-description-row .input-group.description-group {
          flex: 1;
        }

        @media (max-width: 768px) {
          .time-description-row {
            flex-direction: column;
            gap: 12px;
          }

          .time-description-row .input-group {
            min-width: auto;
          }
        }

        .button-group {
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
        }

        .btn {
          padding: 14px 24px;
          border: none;
          border-radius: var(--border-radius-md);
          font-weight: 600;
          cursor: pointer;
          transition: var(--transition-smooth);
          display: flex;
          align-items: center;
          gap: 10px;
          text-decoration: none;
          font-size: 0.95rem;
          position: relative;
          overflow: hidden;
          outline: none;
        }

        .btn:focus-visible {
          box-shadow:
            0 0 0 3px rgba(102, 126, 234, 0.3),
            0 8px 25px rgba(0, 0, 0, 0.15);
          transform: translateY(-2px);
        }

        .btn:active {
          transform: translateY(0px);
          transition: transform 0.1s;
        }

        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.6s;
        }

        .btn-primary:hover::before {
          left: 100%;
        }

        .btn-primary:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.6s;
        }

        .btn-success:hover::before {
          left: 100%;
        }

        .btn-success:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
          background: #f8f9fa;
          color: #666;
          border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
          background: #e9ecef;
          color: #333;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          flex-wrap: wrap;
          gap: 16px;
        }

        .section-header h3 {
          font-size: 1.4rem;
          font-weight: 600;
          color: #333;
          margin: 0;
        }

        .header-actions {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .storage-status {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 20px;
          font-size: 0.85rem;
          color: #666;
          cursor: help;
        }

        .storage-status.online {
          background: #d4edda;
          border-color: #c3e6cb;
          color: #155724;
        }

        .storage-status.offline {
          background: #fff3cd;
          border-color: #ffeaa7;
          color: #856404;
        }

        .storage-status.error {
          background: #f8d7da;
          border-color: #f5c6cb;
          color: #721c24;
        }

        .reminders-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 20px;
        }

        .reminder-item {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          border-left: 5px solid;
          position: relative;
          overflow: hidden;
        }

        .reminder-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .reminder-item:hover {
          transform: translateY(-8px);
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .reminder-item.exam {
          border-left-color: #dc3545;
          background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
          box-shadow: 0 4px 16px rgba(220, 53, 69, 0.1);
        }

        .reminder-item.exam:hover {
          box-shadow: 0 8px 24px rgba(220, 53, 69, 0.2);
          border-left-color: #c82333;
        }

        .reminder-item.assignment {
          border-left-color: #007bff;
          background: linear-gradient(135deg, #f0f8ff 0%, #ffffff 100%);
          box-shadow: 0 4px 16px rgba(0, 123, 255, 0.1);
        }

        .reminder-item.assignment:hover {
          box-shadow: 0 8px 24px rgba(0, 123, 255, 0.2);
          border-left-color: #0056b3;
        }

        .reminder-item.project {
          border-left-color: #28a745;
          background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
          box-shadow: 0 4px 16px rgba(40, 167, 69, 0.1);
        }

        .reminder-item.project:hover {
          box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);
          border-left-color: #1e7e34;
        }

        .reminder-item.lab {
          border-left-color: #6f42c1;
          background: linear-gradient(135deg, #f8f5ff 0%, #ffffff 100%);
          box-shadow: 0 4px 16px rgba(111, 66, 193, 0.1);
        }

        .reminder-item.lab:hover {
          box-shadow: 0 8px 24px rgba(111, 66, 193, 0.2);
          border-left-color: #5a2d91;
        }

        .reminder-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
        }

        .reminder-type-badge {
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.85rem;
          font-weight: 500;
          color: white;
        }

        .reminder-type-badge.exam {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .reminder-type-badge.assignment {
          background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .reminder-type-badge.project {
          background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .reminder-type-badge.lab {
          background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);
        }

        /* Enhanced visual indicators for reminder types - removed duplicate icons */

        /* Filter Options Styling */
        .reminder-filters {
          background: white;
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          display: flex;
          gap: 20px;
          align-items: center;
          flex-wrap: wrap;
        }

        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 8px;
          min-width: 150px;
        }

        .filter-group label {
          font-weight: 600;
          color: #333;
          font-size: 0.9rem;
        }

        .filter-group select {
          padding: 10px 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          background: white;
          font-size: 0.9rem;
          cursor: pointer;
          transition: all 0.3s;
        }

        .filter-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-group select:hover {
          border-color: #667eea;
        }

        .clear-filters-btn {
          padding: 10px 16px;
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 600;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 8px;
          margin-top: 24px;
        }

        .clear-filters-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .clear-filters-btn:active {
          transform: translateY(0);
        }

        /* Filter responsive design */
        @media (max-width: 768px) {
          .reminder-filters {
            flex-direction: column;
            align-items: stretch;
          }

          .filter-group {
            min-width: auto;
          }

          .clear-filters-btn {
            margin-top: 16px;
            align-self: center;
          }
        }

        /* Priority indicators based on countdown */
        .reminder-countdown.overdue {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
          animation: pulse 2s infinite;
        }

        .reminder-countdown.overdue_today {
          background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
          color: white;
          animation: pulse 1.5s infinite;
          font-weight: 600;
          border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .reminder-countdown.due_today {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
        }

        .reminder-countdown.due_tomorrow {
          background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
          color: #333;
        }

        .reminder-countdown.due_now {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
          color: white;
          animation: pulse 1s infinite;
          font-weight: 600;
        }

        .reminder-countdown.due_soon {
          background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
          color: white;
        }

        .reminder-countdown.due_this_week {
          background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
          color: white;
        }

        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }

        /* Priority indicators */
        .reminder-item.priority-critical {
          border-left-width: 6px;
          animation: glow 2s infinite alternate;
        }

        .reminder-item.priority-urgent {
          border-left-width: 5px;
        }

        .reminder-item.priority-high {
          border-left-width: 4px;
        }

        @keyframes glow {
          from { box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3); }
          to { box-shadow: 0 8px 24px rgba(220, 53, 69, 0.6); }
        }

        /* Priority indicator */
        .priority-indicator {
          font-size: 1.2rem;
          margin-left: auto;
        }

        .priority-indicator.critical {
          animation: pulse 1s infinite;
        }

        .priority-indicator.urgent {
          animation: pulse 2s infinite;
        }

        /* Due date display */
        .reminder-due-date {
          color: #666;
          font-size: 0.9rem;
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .reminder-due-date i {
          color: #999;
        }

        /* Reminder Statistics */
        .reminder-stats {
          margin-bottom: 24px;
          background: white;
          border-radius: 16px;
          padding: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 16px;
        }

        .stat-item {
          text-align: center;
          padding: 16px 12px;
          border-radius: 12px;
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          transition: all 0.3s;
        }

        .stat-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-item.critical {
          background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
          border-color: #dc3545;
        }

        .stat-item.urgent {
          background: linear-gradient(135deg, #fff8f0 0%, #ffffff 100%);
          border-color: #fd7e14;
        }

        .stat-item.overdue {
          background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
          border-color: #dc3545;
        }

        .stat-item.due-today {
          background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
          border-color: #ffc107;
        }

        .stat-item.total {
          background: linear-gradient(135deg, #f0f8ff 0%, #ffffff 100%);
          border-color: #007bff;
        }

        .stat-number {
          font-size: 2rem;
          font-weight: 700;
          margin-bottom: 4px;
        }

        .stat-item.critical .stat-number {
          color: #dc3545;
        }

        .stat-item.urgent .stat-number {
          color: #fd7e14;
        }

        .stat-item.overdue .stat-number {
          color: #dc3545;
        }

        .stat-item.due-today .stat-number {
          color: #ffc107;
        }

        .stat-item.total .stat-number {
          color: #007bff;
        }

        .stat-label {
          font-size: 0.9rem;
          font-weight: 500;
          color: #666;
        }

        /* Email Settings */
        .email-settings-section {
          margin-bottom: 32px;
        }

        .settings-header {
          background: white;
          border-radius: 16px;
          padding: 20px 24px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: all 0.3s;
        }

        .settings-header:hover {
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .settings-header h3 {
          font-size: 1.3rem;
          font-weight: 600;
          color: #333;
          margin: 0;
        }

        .toggle-btn {
          background: none;
          border: none;
          color: #666;
          font-size: 1.2rem;
          cursor: pointer;
          transition: transform 0.3s;
        }

        .toggle-btn.active {
          transform: rotate(180deg);
        }

        .settings-content {
          background: white;
          border-radius: 0 0 16px 16px;
          margin-top: -16px;
          padding: 0 24px 24px 24px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .settings-card {
          padding-top: 20px;
        }

        .setting-item {
          display: flex;
          align-items: center;
          gap: 16px;
          margin-bottom: 20px;
        }

        .setting-info {
          flex: 1;
        }

        .setting-title {
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
        }

        .setting-description {
          font-size: 0.9rem;
          color: #666;
        }

        /* Toggle Switch */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 34px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: #667eea;
        }

        input:checked + .slider:before {
          transform: translateX(26px);
        }

        /* Notification Options */
        .notification-options {
          margin: 20px 0;
        }

        .notification-options h4 {
          font-size: 1.1rem;
          font-weight: 600;
          color: #333;
          margin-bottom: 12px;
        }

        .option-grid {
          display: grid;
          gap: 12px;
        }

        .checkbox-label {
          display: flex;
          align-items: center;
          gap: 12px;
          cursor: pointer;
          font-size: 0.95rem;
          color: #333;
        }

        .checkbox-label input[type="checkbox"] {
          width: 18px;
          height: 18px;
          accent-color: #667eea;
        }

        .settings-actions {
          display: flex;
          gap: 12px;
          margin-top: 20px;
          flex-wrap: wrap;
        }

        .reminder-title {
          font-size: 1.2rem;
          font-weight: 600;
          color: #333;
          margin-bottom: 8px;
          line-height: 1.3;
        }

        .reminder-description {
          color: #666;
          font-size: 0.95rem;
          line-height: 1.4;
          margin-bottom: 16px;
        }

        .reminder-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 12px;
        }

        .reminder-countdown {
          font-weight: 500;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.9rem;
        }

        .reminder-countdown.upcoming {
          background: #e3f2fd;
          color: #1976d2;
        }

        .reminder-countdown.due_today {
          background: #fff3e0;
          color: #f57c00;
        }

        .reminder-countdown.due_tomorrow {
          background: #fff3e0;
          color: #f57c00;
        }

        .reminder-countdown.overdue {
          background: #ffebee;
          color: #d32f2f;
        }

        .reminder-countdown.no_date {
          background: #f5f5f5;
          color: #757575;
        }

        .reminder-actions {
          display: flex;
          gap: 8px;
        }

        .reminder-action-btn {
          width: 36px;
          height: 36px;
          border: none;
          border-radius: 8px;
          background: #f8f9fa;
          color: #666;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .reminder-action-btn:hover {
          background: #667eea;
          color: white;
          transform: translateY(-2px);
        }

        .reminder-action-btn.delete:hover {
          background: #dc3545;
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #666;
          grid-column: 1 / -1;
        }

        .empty-icon {
          font-size: 3rem;
          margin-bottom: 16px;
          opacity: 0.3;
        }

        .loading-state {
          text-align: center;
          padding: 60px 20px;
          color: #666;
          grid-column: 1 / -1;
        }

        .loading-state i {
          font-size: 3rem;
          margin-bottom: 20px;
          color: #667eea;
          animation: modernSpin 2s linear infinite;
        }

        @keyframes modernSpin {
          0% { transform: rotate(0deg) scale(1); }
          50% { transform: rotate(180deg) scale(1.1); }
          100% { transform: rotate(360deg) scale(1); }
        }

        /* Modern Pulse Animation */
        .pulse {
          animation: modernPulse 2s ease-in-out infinite;
        }

        @keyframes modernPulse {
          0%, 100% {
            transform: scale(1);
            opacity: 1;
          }
          50% {
            transform: scale(1.05);
            opacity: 0.8;
          }
        }

        /* Expense Tracker Styles */
        .expense-tracker-container {
          max-width: 1200px;
          margin: 0 auto;
        }

        .expense-header {
          text-align: center;
          margin-bottom: 32px;
        }

        .expense-header h2 {
          font-size: 2.2rem;
          font-weight: 700;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          margin-bottom: 8px;
        }

        /* Budget Alerts */
        .budget-alerts-section {
          margin-bottom: 24px;
        }

        .alerts-container {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .budget-alert {
          padding: 16px 20px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          gap: 12px;
          font-weight: 500;
          animation: slideInDown 0.5s ease-out;
        }

        .budget-alert.danger {
          background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%);
          border: 2px solid #f44336;
          color: #c62828;
        }

        .budget-alert.warning {
          background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
          border: 2px solid #ff9800;
          color: #e65100;
        }

        .budget-alert i {
          font-size: 1.2rem;
        }

        @keyframes slideInDown {
          from {
            opacity: 0;
            transform: translateY(-20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* Expense Stats */
        .expense-stats-section {
          margin-bottom: 32px;
        }

        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 24px;
        }

        .stat-card {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          gap: 16px;
        }

        .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
          font-size: 2.5rem;
          width: 60px;
          height: 60px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 16px;
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .stat-content {
          flex: 1;
        }

        .stat-value {
          font-size: 1.8rem;
          font-weight: 700;
          color: #333;
          margin-bottom: 4px;
        }

        .stat-label {
          font-size: 0.9rem;
          color: #666;
          font-weight: 500;
        }

        .stat-card.total-expenses .stat-icon {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .stat-card.monthly-expenses .stat-icon {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
        }

        .stat-card.budget-remaining .stat-icon {
          background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
          color: white;
        }

        .stat-card.expense-count .stat-icon {
          background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
          color: white;
        }

        /* Add/Budget Sections */
        .add-expense-section,
        .budget-management-section {
          margin-bottom: 32px;
        }

        /* Expense Filters */
        .expense-filters {
          background: white;
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 24px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          display: flex;
          gap: 20px;
          align-items: end;
          flex-wrap: wrap;
        }

        /* Expenses Grid */
        .expenses-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 20px;
        }

        /* Expense Chart Styles */
        .expense-chart-container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          padding: 24px;
          margin-top: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .chart-content {
          display: flex;
          gap: 30px;
          align-items: flex-start;
        }

        .chart-wrapper {
          flex: 0 0 400px; /* Fixed width for chart */
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .chart-legend {
          flex: 1;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
          min-width: 400px;
        }

        .legend-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.8);
          border-radius: 12px;
          font-size: 0.95rem;
          border: 1px solid rgba(0, 0, 0, 0.05);
          transition: all 0.3s ease;
        }

        .legend-item:hover {
          background: rgba(255, 255, 255, 1);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .legend-color {
          width: 20px;
          height: 20px;
          border-radius: 6px;
          flex-shrink: 0;
          border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .legend-details {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .legend-text {
          font-weight: 600;
          color: #333;
          font-size: 0.95rem;
        }

        .legend-amount {
          font-weight: 700;
          color: #667eea;
          font-size: 1rem;
        }

        .legend-percentage {
          font-size: 0.85rem;
          color: #666;
          font-weight: 500;
        }

        /* Responsive Chart Layout */
        @media (max-width: 1024px) {
          .chart-content {
            gap: 25px;
          }

          .chart-wrapper {
            flex: 0 0 350px;
          }

          .chart-legend {
            min-width: 350px;
          }
        }

        @media (max-width: 768px) {
          .chart-content {
            flex-direction: column;
            gap: 20px;
          }

          .chart-wrapper {
            flex: none;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
          }

          .chart-legend {
            min-width: auto;
            grid-template-columns: 1fr 1fr; /* Keep 2 columns on tablet */
            gap: 10px;
          }

          .legend-item {
            padding: 10px 14px;
          }

          .legend-color {
            width: 18px;
            height: 18px;
          }

          .legend-text {
            font-size: 0.9rem;
          }

          .legend-amount {
            font-size: 0.95rem;
          }
        }

        @media (max-width: 600px) {
          .chart-legend {
            grid-template-columns: 1fr; /* Single column on small screens */
          }
        }

        @media (max-width: 480px) {
          .chart-wrapper {
            max-width: 300px;
          }

          .legend-item {
            padding: 8px 12px;
            gap: 10px;
          }

          .legend-color {
            width: 16px;
            height: 16px;
          }

          .legend-text {
            font-size: 0.85rem;
          }

          .legend-amount {
            font-size: 0.9rem;
          }

          .legend-percentage {
            font-size: 0.8rem;
          }
        }

        /* Chat Styles */
        .chat-container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          padding: 24px;
          margin: 20px 0;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        /* Team Styles */
        .team-card {
          background: rgba(255, 255, 255, 0.9);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
          border: 1px solid rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }

        .team-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .team-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .team-name {
          font-size: 1.2rem;
          font-weight: 600;
          color: #333;
          margin: 0;
        }

        .team-role {
          background: #667eea;
          color: white;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .team-role.owner {
          background: #28a745;
        }

        .team-description {
          color: #666;
          margin-bottom: 12px;
          font-size: 0.95rem;
        }

        .team-members {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 16px;
        }

        .team-member-count {
          color: #667eea;
          font-weight: 500;
        }

        .team-actions {
          display: flex;
          gap: 8px;
        }

        .team-actions .btn {
          padding: 6px 12px;
          font-size: 0.85rem;
        }

        /* Friends Invite Container */
        .friends-invite-container {
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 12px;
        }

        .friend-invite-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 12px;
          border-radius: 8px;
          margin-bottom: 8px;
          transition: background-color 0.2s ease;
        }

        .friend-invite-item:hover {
          background: #f8f9fa;
        }

        .friend-invite-checkbox {
          width: 18px;
          height: 18px;
          accent-color: #667eea;
        }

        .friend-invite-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background: #667eea;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 0.9rem;
        }

        .friend-invite-details {
          flex: 1;
        }

        .friend-invite-name {
          font-weight: 500;
          color: #333;
          margin: 0;
        }

        .friend-invite-username {
          font-size: 0.85rem;
          color: #666;
          margin: 0;
        }

        /* Team Invitation Styles */
        .team-invitation-card {
          background: rgba(255, 255, 255, 0.9);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
          border-left: 4px solid #667eea;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .invitation-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
        }

        .invitation-info h4 {
          margin: 0 0 4px 0;
          color: #333;
          font-size: 1.1rem;
        }

        .invitation-info p {
          margin: 0;
          color: #666;
          font-size: 0.9rem;
        }

        .invitation-actions {
          display: flex;
          gap: 8px;
        }

        .invitation-actions .btn {
          padding: 6px 16px;
          font-size: 0.85rem;
        }

        /* Team Details Modal Styles */
        .team-info {
          background: #f8f9fa;
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 20px;
        }

        .team-info p {
          margin: 8px 0;
          color: #333;
        }

        .team-members-list h4 {
          color: #333;
          margin-bottom: 16px;
          font-size: 1.1rem;
        }

        .members-container {
          max-height: 300px;
          overflow-y: auto;
        }

        .member-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 8px;
          background: rgba(255, 255, 255, 0.8);
          border: 1px solid #e9ecef;
        }

        .member-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #667eea;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 1rem;
        }

        .member-info h5 {
          margin: 0 0 4px 0;
          color: #333;
          font-size: 1rem;
        }

        .member-info p {
          margin: 0;
          color: #666;
          font-size: 0.9rem;
        }

        /* Team Chat Styles */
        .team-chat-messages {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 16px;
          overflow-y: auto;
          flex: 1;
          margin-bottom: 16px;
        }

        .chat-message {
          margin-bottom: 16px;
          max-width: 70%;
        }

        .chat-message.own-message {
          margin-left: auto;
          text-align: right;
        }

        .chat-message.other-message {
          margin-right: auto;
          text-align: left;
        }

        .message-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
          font-size: 0.8rem;
          color: #666;
        }

        .own-message .message-header {
          flex-direction: row-reverse;
        }

        .sender-name {
          font-weight: 600;
          color: #333;
        }

        .message-time {
          color: #999;
          font-size: 0.75rem;
        }

        .message-content {
          background: white;
          padding: 12px 16px;
          border-radius: 18px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          display: inline-block;
          max-width: 100%;
        }

        .own-message .message-content {
          background: #667eea;
          color: white;
        }

        .message-text {
          margin: 0;
          word-wrap: break-word;
        }

        .message-image img {
          border-radius: 8px;
          cursor: pointer;
          transition: transform 0.2s;
        }

        .message-image img:hover {
          transform: scale(1.02);
        }

        .message-file {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .file-icon {
          font-size: 1.5rem;
        }

        .file-info {
          flex: 1;
        }

        .file-link {
          color: inherit;
          text-decoration: none;
          font-weight: 600;
        }

        .file-link:hover {
          text-decoration: underline;
        }

        .file-caption {
          margin: 4px 0 0 0;
          font-size: 0.9rem;
          opacity: 0.8;
        }

        .message-voice audio {
          width: 100%;
          max-width: 300px;
        }

        .empty-chat {
          text-align: center;
          color: #666;
          padding: 40px 20px;
        }

        .empty-chat i {
          font-size: 3rem;
          margin-bottom: 16px;
          opacity: 0.5;
        }

        .loading-messages {
          text-align: center;
          color: #666;
          padding: 20px;
        }

        .error-message {
          text-align: center;
          color: #dc3545;
          padding: 20px;
        }

        .team-chat-input-container {
          border-top: 1px solid #e9ecef;
          padding-top: 16px;
          background: white;
          position: relative;
          z-index: 10;
        }

        /* Old file upload options styles - now integrated into single line */

        .input-group {
          display: flex;
          gap: 8px;
          align-items: center;
          width: 100%;
        }

        .input-group .form-control {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid #ddd;
          border-radius: 25px;
          outline: none;
          background: white;
          color: #333;
          font-size: 14px;
          min-height: 44px;
        }

        .input-group .form-control:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
          background: white;
        }

        .input-group .form-control::placeholder {
          color: #999;
          opacity: 1;
        }

        .input-group .btn {
          padding: 12px 20px;
          border-radius: 25px;
          white-space: nowrap;
          min-height: 44px;
        }

        /* Specific styling for team chat input */
        #teamChatInput {
          background: white !important;
          color: #333 !important;
          border: 2px solid #ddd !important;
          font-size: 14px !important;
          line-height: 1.4 !important;
        }

        #teamChatInput:focus {
          background: white !important;
          color: #333 !important;
          border-color: #667eea !important;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
        }

        #teamChatInput::placeholder {
          color: #999 !important;
          opacity: 1 !important;
        }

        /* Single-line chat input layout */
        .chat-input-row {
          display: flex;
          align-items: center;
          gap: 8px;
          background: #f8f9fa;
          border-radius: 25px;
          padding: 6px;
          border: 1px solid #e9ecef;
        }

        .chat-action-btn {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border: none;
          background: transparent;
          color: #666;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s ease;
          font-size: 16px;
        }

        .chat-action-btn:hover {
          background: rgba(102, 126, 234, 0.1);
          color: #667eea;
        }

        .chat-input-field {
          flex: 1;
          border: none;
          background: transparent;
          padding: 8px 12px;
          font-size: 14px;
          color: #333;
          outline: none;
          min-height: 24px;
        }

        .chat-input-field::placeholder {
          color: #999;
          opacity: 1;
        }

        .chat-send-btn {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border: none;
          background: #667eea;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s ease;
          font-size: 14px;
        }

        .chat-send-btn:hover {
          background: #5a6fd8;
          transform: scale(1.05);
        }

        .chat-send-btn:active {
          transform: scale(0.95);
        }

        /* Message actions and file actions */
        .message-actions {
          display: flex;
          gap: 4px;
          margin-left: auto;
          opacity: 1;
          transition: opacity 0.2s ease;
        }

        .chat-message:hover .message-actions {
          opacity: 1;
        }

        .action-btn {
          width: 28px;
          height: 28px;
          border: 1px solid #ddd;
          border-radius: 50%;
          background: white;
          color: #666;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s ease;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .action-btn:hover {
          background: rgba(0, 0, 0, 0.2);
          color: #333;
        }

        .edit-btn:hover {
          background: rgba(0, 123, 255, 0.2);
          color: #007bff;
        }

        .delete-btn:hover {
          background: rgba(220, 53, 69, 0.2);
          color: #dc3545;
        }

        .file-actions, .voice-actions {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-top: 4px;
        }

        .download-btn {
          padding: 4px 8px;
          border: none;
          border-radius: 4px;
          background: rgba(102, 126, 234, 0.1);
          color: #667eea;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s ease;
        }

        .download-btn:hover {
          background: rgba(102, 126, 234, 0.2);
          color: #5a6fd8;
        }

        .message-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 4px;
          width: 100%;
        }

        .chat-message .message-header {
          display: flex !important;
          align-items: center !important;
          justify-content: space-between !important;
        }

        .chat-message .message-actions {
          display: flex !important;
          gap: 4px !important;
          margin-left: auto !important;
        }

        .chat-message .action-btn {
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          width: 28px !important;
          height: 28px !important;
          background: white !important;
          border: 1px solid #ddd !important;
          border-radius: 50% !important;
          cursor: pointer !important;
          font-size: 12px !important;
        }

        .edit-message-input {
          width: 100% !important;
          padding: 8px !important;
          border: 1px solid #ddd !important;
          border-radius: 4px !important;
          font-size: 14px !important;
          background: white !important;
          color: #333 !important;
        }

        .edit-actions {
          margin-top: 8px !important;
          display: flex !important;
          gap: 8px !important;
        }

        /* Scroll to bottom button */
        .scroll-to-bottom-btn {
          position: absolute;
          bottom: 20px;
          right: 20px;
          width: 48px;
          height: 48px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
          z-index: 10;
        }

        .scroll-to-bottom-btn:hover {
          background: #5a6fd8;
          transform: scale(1.1);
        }

        .new-message-indicator {
          position: absolute;
          top: -8px;
          right: -8px;
          background: #dc3545;
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
        }

        .chat-content {
          margin-top: 20px;
          min-height: 400px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        /* Friend Request Styles */
        .friend-search-section {
          background: rgba(255, 255, 255, 0.7);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 24px;
          border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .search-container {
          margin-bottom: 16px;
        }

        .search-input-group {
          display: flex;
          gap: 8px;
          max-width: 400px;
        }

        .search-input {
          flex: 1;
          padding: 12px 16px;
          border: 2px solid rgba(102, 126, 234, 0.2);
          border-radius: 8px;
          font-size: 0.95rem;
          background: rgba(255, 255, 255, 0.9);
          transition: all 0.3s ease;
        }

        .search-input:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
          padding: 12px 16px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 0.95rem;
        }

        .search-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-results {
          margin-top: 16px;
        }

        .user-result {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 8px;
          margin-bottom: 8px;
          border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .user-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 1.1rem;
        }

        .user-details h5 {
          margin: 0;
          font-size: 1rem;
          font-weight: 600;
          color: #333;
        }

        .user-details p {
          margin: 0;
          font-size: 0.85rem;
          color: #666;
        }

        .requests-content {
          display: grid;
          gap: 24px;
        }

        .requests-section {
          background: rgba(255, 255, 255, 0.7);
          border-radius: 12px;
          padding: 20px;
          border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-title {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 16px;
          padding-bottom: 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-title h4 {
          margin: 0;
          font-size: 1.1rem;
          font-weight: 600;
          color: #333;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .count-badge {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 600;
          min-width: 20px;
          text-align: center;
        }

        .requests-list {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .request-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .request-actions {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 12px;
          border: none;
          border-radius: 6px;
          font-size: 0.85rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .accept-btn {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
        }

        .decline-btn {
          background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
          color: white;
        }

        .cancel-btn {
          background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
          color: white;
        }

        .action-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .empty-state-small {
          text-align: center;
          padding: 20px;
          color: #666;
          font-style: italic;
        }

        .status-badge {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .status-pending {
          background: #fff3cd;
          color: #856404;
        }

        .status-accepted {
          background: #d4edda;
          color: #155724;
        }

        .expense-item {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          border-left: 5px solid;
          position: relative;
          overflow: hidden;
        }

        .expense-item:hover {
          transform: translateY(-8px);
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .expense-item.food { border-left-color: #ff6b6b; }
        .expense-item.transport { border-left-color: #4ecdc4; }
        .expense-item.education { border-left-color: #45b7d1; }
        .expense-item.entertainment { border-left-color: #f9ca24; }
        .expense-item.shopping { border-left-color: #f0932b; }
        .expense-item.health { border-left-color: #eb4d4b; }
        .expense-item.bills { border-left-color: #6c5ce7; }
        .expense-item.other { border-left-color: #a0a0a0; }

        .expense-header-row {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
        }

        .expense-amount {
          font-size: 1.5rem;
          font-weight: 700;
          color: #333;
        }

        .expense-category-badge {
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.85rem;
          font-weight: 500;
          color: white;
        }

        .expense-category-badge.food { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .expense-category-badge.transport { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); }
        .expense-category-badge.education { background: linear-gradient(135deg, #45b7d1 0%, #3742fa 100%); }
        .expense-category-badge.entertainment { background: linear-gradient(135deg, #f9ca24 0%, #f0932b 100%); }
        .expense-category-badge.shopping { background: linear-gradient(135deg, #f0932b 0%, #eb4d4b 100%); }
        .expense-category-badge.health { background: linear-gradient(135deg, #eb4d4b 0%, #c0392b 100%); }
        .expense-category-badge.bills { background: linear-gradient(135deg, #6c5ce7 0%, #5f27cd 100%); }
        .expense-category-badge.other { background: linear-gradient(135deg, #a0a0a0 0%, #7f8c8d 100%); }

        .expense-description {
          color: #666;
          font-size: 0.95rem;
          line-height: 1.4;
          margin-bottom: 16px;
        }

        .expense-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 12px;
        }

        .expense-date {
          color: #666;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .expense-actions {
          display: flex;
          gap: 8px;
        }

        .expense-action-btn {
          width: 36px;
          height: 36px;
          border: none;
          border-radius: 8px;
          background: #f8f9fa;
          color: #666;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .expense-action-btn:hover {
          background: #667eea;
          color: white;
          transform: translateY(-2px);
        }

        .expense-action-btn.delete:hover {
          background: #dc3545;
        }

        /* Budget Breakdown Styles */
        .budget-breakdown-section {
          margin-bottom: 32px;
        }

        .budget-sort-controls {
          display: flex;
          align-items: center;
          gap: 12px;
          background: rgba(255, 255, 255, 0.9);
          padding: 12px 16px;
          border-radius: 12px;
          border: 1px solid #e9ecef;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sort-label {
          font-size: 0.9rem;
          font-weight: 500;
          color: #666;
          margin: 0;
        }

        .sort-select {
          padding: 8px 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          background: white;
          color: #333;
          font-size: 0.9rem;
          cursor: pointer;
          transition: all 0.3s ease;
          min-width: 150px;
        }

        .sort-select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sort-order-btn {
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1rem;
        }

        .sort-order-btn:hover {
          background: #5a67d8;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .section-title {
          flex: 1;
        }

        .section-title h3 {
          margin-bottom: 4px;
        }

        .section-title p {
          margin: 0;
          font-size: 0.9rem;
          color: #666;
        }

        .budget-breakdown-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 16px;
        }

        .budget-breakdown-card {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          padding: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        .budget-breakdown-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .sort-indicator {
          display: inline-flex;
          align-items: center;
          background: rgba(102, 126, 234, 0.1);
          color: #667eea;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          margin-left: 8px;
          border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .sort-indicator i {
          margin-right: 4px;
        }

        .percentage-used {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white !important;
          padding: 4px 10px;
          border-radius: 12px;
          font-weight: 600;
          display: inline-block;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Rank badges removed as requested */

        /* Responsive adjustments for budget cards */
        @media (max-width: 768px) {
          .budget-breakdown-grid {
            grid-template-columns: 1fr;
          }

          .budget-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            padding-right: 0;
          }

          .budget-category {
            max-width: 100%;
          }

          .budget-status {
            align-self: flex-end;
            margin-left: 0;
          }

          /* No badge styles needed */

          .budget-sort-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
          }

          .sort-select {
            min-width: auto;
            width: 100%;
          }

          .sort-order-btn {
            align-self: center;
            width: 36px;
            height: 36px;
          }
        }

        .budget-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .budget-category {
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: 600;
          color: #333;
          flex: 1;
        }

        .budget-status {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
          white-space: nowrap;
        }

        .budget-status.safe {
          background: #d4edda;
          color: #155724;
        }

        .budget-status.warning {
          background: #fff3cd;
          color: #856404;
        }

        .budget-status.danger {
          background: #f8d7da;
          color: #721c24;
        }

        .budget-progress {
          margin-bottom: 12px;
        }

        .budget-progress-bar {
          width: 100%;
          height: 8px;
          background: #f1f3f4;
          border-radius: 4px;
          overflow: hidden;
        }

        .budget-progress-fill {
          height: 100%;
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .budget-progress-fill.safe {
          background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }

        .budget-progress-fill.warning {
          background: linear-gradient(90deg, #ffc107 0%, #e0a800 100%);
        }

        .budget-progress-fill.danger {
          background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }

        .budget-amounts {
          display: flex;
          justify-content: space-between;
          font-size: 0.9rem;
        }

        .budget-spent {
          color: #666;
        }

        .budget-limit {
          color: #333;
          font-weight: 600;
        }

        /* Notification Styles */
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 16px 20px;
          border-radius: 12px;
          color: white;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 12px;
          z-index: 10000;
          animation: slideInRight 0.3s ease-out;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
          backdrop-filter: blur(10px);
          min-width: 300px;
        }

        .notification-success {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .notification-error {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .notification-info {
          background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .notification-close {
          background: none;
          border: none;
          color: white;
          font-size: 1.2rem;
          cursor: pointer;
          margin-left: auto;
          padding: 0;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        @keyframes slideInRight {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        /* Tab Navigation */
        .tab-navigation {
          display: flex;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          padding: 12px;
          margin-bottom: 32px;
          box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.5) inset;
          overflow-x: auto;
          position: relative;
        }

        .tab-navigation::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        }

        .tab-btn {
          flex: 1;
          background: none;
          border: none;
          padding: 18px 24px;
          border-radius: 16px;
          font-weight: 600;
          font-size: 0.95rem;
          color: #666;
          cursor: pointer;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          white-space: nowrap;
          min-width: 160px;
          position: relative;
          overflow: hidden;
        }

        .tab-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
          opacity: 0;
          transition: opacity 0.3s;
        }

        .tab-btn:hover::before {
          opacity: 1;
        }

        .tab-btn:hover {
          color: #333;
          transform: translateY(-2px);
        }

        .tab-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
          transform: translateY(-2px);
        }

        .tab-btn.active::before {
          opacity: 0;
        }

        /* App Layout */
        .app-layout {
          display: flex;
          min-height: calc(100vh - 120px);
          gap: 20px;
          align-items: flex-start;
        }

        /* Sidebar Styles */
        .sidebar {
          width: 320px;
          min-width: 320px;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          display: flex;
          flex-direction: column;
          position: sticky;
          top: 20px;
          height: fit-content;
          max-height: calc(100vh - 140px);
          overflow-y: auto;
          overflow-x: hidden;
        }

        .sidebar-header {
          padding: 20px;
          border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .user-profile {
          display: flex;
          align-items: flex-start;
          gap: 12px;
        }

        .user-avatar {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 1.4rem;
          flex-shrink: 0;
        }

        .user-info {
          flex: 1;
          min-width: 0;
          max-width: 220px;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .user-name {
          font-weight: 600;
          color: #333;
          font-size: 1rem;
          margin: 0;
          line-height: 1.2;
          word-wrap: break-word;
          white-space: normal;
        }

        .user-email {
          font-size: 0.8rem;
          color: #666;
          margin: 0;
          line-height: 1.2;
          word-wrap: break-word;
          white-space: normal;
        }

        .sidebar-nav {
          flex: 1;
          padding: 16px 0;
        }

        .nav-section {
          margin-bottom: 16px;
        }

        .nav-section-title {
          font-size: 0.75rem;
          font-weight: 600;
          color: #999;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          padding: 0 20px 8px;
          margin-bottom: 6px;
        }

        .nav-btn {
          width: calc(100% - 20px);
          background: transparent;
          border: none;
          padding: 14px 16px;
          color: #666;
          font-weight: 500;
          font-size: 0.95rem;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          gap: 12px;
          text-align: left;
          position: relative;
          white-space: nowrap;
          overflow: visible;
          min-height: 48px;
          border-radius: 10px;
          margin: 2px 10px;
          box-sizing: border-box;
        }

        .nav-btn::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 4px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .nav-btn:hover {
          background: rgba(102, 126, 234, 0.1);
          color: #667eea;
          transform: none;
        }

        .nav-btn:hover span {
          opacity: 1;
          color: #667eea;
          visibility: visible;
        }

        .nav-btn:hover i {
          opacity: 1;
          color: #667eea;
          visibility: visible;
        }

        .nav-btn.active:hover {
          background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.active:hover span,
        .nav-btn.active:hover i {
          color: white !important;
        }

        .nav-btn.active span,
        .nav-btn.active i {
          color: white !important;
          position: relative;
          z-index: 2;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          font-weight: 600;
        }

        .nav-btn.active span {
          overflow: visible !important;
          white-space: nowrap !important;
          text-overflow: unset !important;
          width: auto !important;
          flex: 1 !important;
          display: block !important;
          text-align: left !important;
          max-width: none !important;
        }

        .nav-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          color: white !important;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          transform: translateY(-2px);
          position: relative;
          overflow: hidden;
          border: 2px solid rgba(255, 255, 255, 0.2);
          width: calc(100% - 20px) !important;
          min-width: 280px;
          padding: 14px 16px !important;
        }

        .nav-btn.active::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
          transition: left 0.6s;
          animation: shimmer 2.5s infinite;
          z-index: 1;
          border-radius: 10px;
        }

        @keyframes shimmer {
          0% { left: -100%; }
          50% { left: 100%; }
          100% { left: 100%; }
        }

        .nav-btn i {
          font-size: 1.1rem;
          width: 20px;
          text-align: center;
          flex-shrink: 0;
          display: inline-block;
          opacity: 1;
          visibility: visible;
          transition: all 0.3s ease;
        }

        .nav-btn span {
          flex: 1;
          overflow: visible;
          white-space: nowrap;
          min-width: 0;
          font-size: 1rem;
          font-weight: 500;
          letter-spacing: 0.02em;
          display: inline-block;
          line-height: 1.4;
          opacity: 1;
          transition: all 0.3s ease;
          width: 100%;
          text-align: left;
        }

        .sidebar-footer {
          padding: 16px;
          border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-footer .theme-btn {
          color: #667eea !important;
          width: calc(100% - 20px);
          margin: 0 10px 8px 10px;
        }

        .sidebar-footer .theme-btn:hover {
          background: rgba(102, 126, 234, 0.1) !important;
        }

        .sidebar-footer .logout-btn {
          color: #dc3545 !important;
          width: calc(100% - 20px);
          margin: 0 10px;
        }

        .sidebar-footer .logout-btn:hover {
          background: rgba(220, 53, 69, 0.1) !important;
        }

        /* Main Content Wrapper */
        .main-content-wrapper {
          flex: 1;
          min-width: 0;
          overflow: hidden;
        }

        /* Tab Content */
        .tab-content {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          padding: 32px;
          box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.5) inset;
          min-height: 600px;
          position: relative;
          overflow: hidden;
        }

        .tab-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        }

        .tab-pane {
          display: none;
        }

        .tab-pane.active {
          display: block;
        }

        /* Timetable Styles */
        .timetable-container {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
          transform: none !important;
          direction: ltr !important;
        }

        /* Global fix for text mirroring in timetable */
        .timetable-container,
        .timetable-container *,
        .timetable-header,
        .timetable-header *,
        .timetable-toggle,
        .timetable-toggle *,
        .toggle-btn,
        .toggle-btn * {
          transform: none !important;
          -webkit-transform: none !important;
          -moz-transform: none !important;
          -ms-transform: none !important;
          direction: ltr !important;
          unicode-bidi: normal !important;
          text-align: inherit !important;
          writing-mode: horizontal-tb !important;
          text-orientation: mixed !important;
        }

        /* Specific fix for button text */
        .toggle-btn {
          -webkit-font-feature-settings: normal !important;
          font-feature-settings: normal !important;
          -webkit-text-orientation: mixed !important;
          text-orientation: mixed !important;
          filter: none !important;
          -webkit-filter: none !important;
        }

        /* Additional fix for any CSS filters causing mirroring */
        #timetable, #timetable * {
          filter: none !important;
          -webkit-filter: none !important;
          transform: none !important;
          -webkit-transform: none !important;
        }

        /* Mobile Responsive for Header Stacks */
        @media (max-width: 768px) {
          .header {
            padding: 15px 20px;
            flex-direction: column;
            gap: 15px;
          }

          .header-left {
            text-align: center;
          }

          .header-right {
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
          }

          .clock-container {
            order: -1;
          }

          .clock-countdown-stack {
            gap: 6px;
          }

          .theme-logout-stack {
            gap: 6px;
          }

          .exam-countdown {
            min-width: 160px;
            padding: 8px 12px;
          }

          .theme-toggle-btn {
            width: 36px;
            height: 36px;
            padding: 8px;
          }

          .logout-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            gap: 6px;
          }

          /* Exam action buttons mobile responsive */
          .exam-actions {
            gap: 6px;
          }

          .edit-btn, .delete-btn {
            min-width: 32px;
            height: 32px;
            padding: 6px 8px;
            font-size: 0.8rem;
          }

          .exam-item {
            padding: 16px;
          }

          .exam-subject {
            font-size: 1.1rem;
          }
        }

        .timetable-header {
          background: white;
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .timetable-header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 16px;
        }

        .timetable-header-left {
          display: flex;
          align-items: center;
          gap: 16px;
        }

        .back-btn {
          background: #f8f9fa;
          color: #667eea;
          width: 44px;
          height: 44px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: all 0.3s;
          border: 2px solid #e9ecef;
          cursor: pointer;
        }

        .back-btn:hover {
          background: #667eea;
          color: white;
          transform: translateY(-2px);
        }

        .page-title {
          font-size: 1.8rem;
          font-weight: 700;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          margin-bottom: 4px;
        }

        .page-subtitle {
          color: #666;
          font-size: 1rem;
        }

        .timetable-header-right {
          display: flex;
          align-items: center;
          gap: 12px;
          transform: none !important;
          direction: ltr !important;
        }

        /* Timetable Toggle Styles */
        .timetable-toggle {
          display: flex;
          background: #f8f9fa;
          border-radius: 12px;
          padding: 4px;
          gap: 2px;
          transform: none;
          direction: ltr;
        }

        .toggle-btn {
          padding: 8px 16px;
          border: none;
          border-radius: 8px;
          background: transparent;
          color: #666;
          font-size: 0.85rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 6px;
          transform: none;
          direction: ltr;
          text-align: left;
        }

        .toggle-btn:hover {
          background: #e9ecef;
          color: #495057;
        }

        .toggle-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .toggle-btn i {
          font-size: 0.8rem;
          transform: none;
        }

        /* Fix any text mirroring issues */
        .toggle-btn, .toggle-btn * {
          transform: none !important;
          -webkit-transform: none !important;
          -moz-transform: none !important;
          -ms-transform: none !important;
          direction: ltr !important;
          unicode-bidi: normal !important;
        }

        /* Exam Schedule Styles */
        .exam-schedule-list {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .exam-item {
          background: white;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          border-left: 4px solid #667eea;
          transition: all 0.3s ease;
        }

        .exam-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .exam-item:hover .exam-actions {
          opacity: 1;
        }

        .exam-item.upcoming-exam {
          border-left-color: #28a745;
          background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }

        .exam-item.past-exam {
          border-left-color: #6c757d;
          background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
          opacity: 0.7;
        }

        .exam-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .exam-subject {
          font-size: 1.2rem;
          font-weight: 700;
          color: #2c3e50;
        }

        .exam-actions {
          display: flex;
          gap: 8px;
          opacity: 0.7;
          transition: opacity 0.3s ease;
        }

        .edit-btn, .delete-btn {
          background: rgba(255, 255, 255, 0.9);
          border: none;
          border-radius: 8px;
          padding: 8px 10px;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 36px;
          height: 36px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .edit-btn {
          color: #667eea;
        }

        .edit-btn:hover {
          background: #667eea;
          color: white;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .delete-btn {
          color: #dc3545;
        }

        .delete-btn:hover {
          background: #dc3545;
          color: white;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .exam-details {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .exam-date, .exam-time, .exam-location {
          display: flex;
          align-items: center;
          gap: 8px;
          color: #666;
          font-size: 0.9rem;
        }

        .exam-countdown {
          display: inline-block;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .exam-countdown.upcoming {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
        }

        .exam-countdown.past {
          background: #6c757d;
          color: white;
        }

        @media (max-width: 768px) {
          .exam-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
          }

          .exam-actions {
            align-self: flex-end;
          }
        }

        .add-btn {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          width: 44px;
          height: 44px;
          border: none;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 1.1rem;
        }

        .add-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* Day Navigation */
        .day-navigation {
          background: white;
          border-radius: 16px;
          padding: 24px;
          margin-bottom: 20px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          display: flex;
          align-items: center;
          justify-content: space-between;
        }

        .nav-btn {
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          width: 48px;
          height: 48px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s;
          color: #667eea;
          font-size: 1.2rem;
        }

        /* Removed conflicting nav-btn hover style */

        .day-info {
          text-align: center;
          flex: 1;
        }

        .day-name {
          font-size: 2rem;
          font-weight: 700;
          color: #333;
          margin-bottom: 4px;
        }

        .day-date {
          font-size: 1.1rem;
          color: #667eea;
          font-weight: 500;
        }

        /* Timetable Content */
        .timetable-content {
          background: white;
          border-radius: 16px;
          padding: 24px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          min-height: 400px;
        }

        .schedule-container {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .empty-schedule {
          text-align: center;
          padding: 60px 20px;
          color: #666;
        }

        .empty-icon {
          font-size: 3rem;
          margin-bottom: 16px;
          opacity: 0.3;
        }

        .empty-schedule p {
          margin-bottom: 20px;
          font-size: 1.1rem;
        }

        /* Schedule Items */
        .schedule-item {
          border-radius: 16px;
          padding: 20px;
          color: white;
          display: flex;
          align-items: center;
          gap: 16px;
          cursor: pointer;
          transition: all 0.3s;
          position: relative;
          overflow: hidden;
        }

        .schedule-item:hover {
          transform: translateY(-4px);
          box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }

        .schedule-item::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
          pointer-events: none;
        }

        .schedule-number {
          background: rgba(255, 255, 255, 0.2);
          width: 40px;
          height: 40px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 1.1rem;
          flex-shrink: 0;
        }

        .schedule-content {
          flex: 1;
          display: flex;
          gap: 20px;
          align-items: center;
        }

        .schedule-time {
          min-width: 80px;
        }

        .time-start {
          font-size: 1.1rem;
          font-weight: 600;
          margin-bottom: 2px;
        }

        .time-end {
          font-size: 0.9rem;
          opacity: 0.9;
        }

        .schedule-details {
          flex: 1;
        }

        .subject-name {
          font-size: 1.3rem;
          font-weight: 700;
          margin-bottom: 4px;
        }

        .teacher-name {
          font-size: 1rem;
          opacity: 0.9;
          margin-bottom: 8px;
        }

        .room-info {
          font-size: 0.9rem;
          opacity: 0.8;
          display: flex;
          align-items: center;
          gap: 4px;
          margin-bottom: 4px;
        }

        .class-type {
          display: inline-block;
          background: rgba(255, 255, 255, 0.2);
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .schedule-actions {
          display: flex;
          gap: 8px;
          opacity: 0;
          transition: opacity 0.3s;
        }

        .schedule-item:hover .schedule-actions {
          opacity: 1;
        }

        .action-btn {
          background: rgba(255, 255, 255, 0.2);
          border: none;
          width: 32px;
          height: 32px;
          border-radius: 8px;
          color: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s;
          font-size: 0.9rem;
        }

        .action-btn:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: scale(1.1);
        }

        .delete-btn:hover {
          background: rgba(220, 53, 69, 0.8);
        }

        /* Modal Styles */
        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(4px);
          align-items: center;
          justify-content: center;
          padding: 20px;
        }

        .modal-content {
          background: white;
          border-radius: 16px;
          width: 100%;
          max-width: 500px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
          from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }

        .modal-header {
          padding: 24px 24px 0 24px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        }

        .modal-header h3 {
          font-size: 1.3rem;
          font-weight: 600;
          color: #333;
        }

        .modal-close {
          background: #f8f9fa;
          border: none;
          width: 32px;
          height: 32px;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #666;
          transition: all 0.3s;
        }

        .modal-close:hover {
          background: #e9ecef;
          color: #333;
        }

        .modal-body {
          padding: 0 24px 24px 24px;
        }

        /* Form Styles */
        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
          margin-bottom: 16px;
        }

        .form-group {
          margin-bottom: 16px;
        }

        .form-group label {
          display: block;
          margin-bottom: 6px;
          font-weight: 500;
          color: #333;
        }

        .form-group input,
        .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 14px;
          transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
          margin-top: 24px;
        }

        /* Formula Info */
        .formula-info {
          background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
          padding: 16px;
          border-radius: 12px;
          margin-bottom: 24px;
          text-align: center;
          font-weight: 500;
          color: #333;
        }

        /* Calculator Grid */
        .calculator-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
        }

        .calculator-card {
          background: var(--glass-bg);
          backdrop-filter: blur(20px);
          border: 1px solid var(--glass-border);
          border-radius: var(--border-radius-xl);
          overflow: hidden;
          transition: var(--transition-smooth);
          position: relative;
        }

        .calculator-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        }

        .calculator-card:hover {
          transform: translateY(-5px);
          box-shadow: var(--glass-shadow-hover);
        }

        .card-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 16px 20px;
        }

        .card-header h3 {
          font-size: 1.1rem;
          font-weight: 600;
        }

        .card-content {
          padding: 20px;
        }

        /* Semester Container */
        .semester-container {
          max-height: 400px;
          overflow-y: auto;
          margin-bottom: 20px;
        }

        .semester-item {
          background: white;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 16px;
          margin-bottom: 12px;
        }

        .semester-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .semester-title {
          font-weight: 600;
          color: #333;
        }

        .remove-semester {
          background: #dc3545;
          color: white;
          border: none;
          padding: 6px 8px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.8rem;
        }

        .semester-inputs {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        /* Input Styles */
        .input-group {
          margin-bottom: 16px;
        }

        .input-group label {
          display: block;
          margin-bottom: 6px;
          font-weight: 500;
          color: #333;
        }

        .input-group input,
        .input-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 14px;
          transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }

        /* Button Styles */
        .btn {
          padding: 12px 20px;
          border: none;
          border-radius: 8px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          text-decoration: none;
          font-size: 14px;
        }

        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
          background: #28a745;
          color: white;
        }

        .btn-success:hover {
          background: #218838;
          transform: translateY(-2px);
        }

        .btn-outline {
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
        }

        .btn-outline:hover {
          background: #667eea;
          color: white;
        }

        .action-buttons {
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
        }

        /* Results Container */
        .results-container {
          min-height: 300px;
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #666;
        }

        .loading-state {
          text-align: center;
          padding: 60px 20px;
          color: #666;
        }

        .loading-state i {
          font-size: 2rem;
          margin-bottom: 16px;
          color: #667eea;
        }

        /* CGPA Results */
        .cgpa-result-card {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          color: white;
          padding: 24px;
          border-radius: 12px;
          text-align: center;
          margin-bottom: 20px;
        }

        .cgpa-value {
          font-size: 3rem;
          font-weight: 700;
          margin: 8px 0;
        }

        .cgpa-scale {
          font-size: 0.9rem;
          opacity: 0.9;
        }

        .gpa-scales {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
          margin-bottom: 20px;
        }

        .cgpa-scale-selector {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 24px;
          border: 2px solid #e9ecef;
        }

        .scale-info {
          margin-top: 8px;
          padding: 8px 12px;
          background: #e3f2fd;
          border-radius: 6px;
          border-left: 4px solid #2196f3;
        }

        .scale-info small {
          color: #1976d2;
          font-weight: 500;
        }

        .gpa-scale-card {
          background: white;
          padding: 16px;
          border-radius: 8px;
          text-align: center;
          border: 1px solid #e9ecef;
        }

        .scale-value {
          font-size: 1.5rem;
          font-weight: 600;
          color: #667eea;
          margin-bottom: 4px;
        }

        .scale-label {
          font-size: 0.9rem;
          color: #666;
          margin-bottom: 4px;
        }

        .scale-formula {
          font-size: 0.8rem;
          color: #999;
        }

        /* Attendance Results */
        .attendance-result-card {
          padding: 24px;
          border-radius: 12px;
          text-align: center;
          margin-bottom: 20px;
          color: white;
        }

        .attendance-result-card.safe {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .attendance-result-card.at-risk {
          background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        .attendance-percentage {
          font-size: 3rem;
          font-weight: 700;
          margin: 8px 0;
        }

        .recommendation-card {
          padding: 16px;
          border-radius: 8px;
          margin-top: 16px;
        }

        .recommendation-card.safe {
          background: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
        }

        .recommendation-card.at-risk {
          background: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
        }

        /* Holidays Styles */
        .holidays-header {
          margin-bottom: 24px;
        }

        .holiday-controls {
          display: flex;
          align-items: end;
          gap: 15px;
          margin-top: 15px;
        }

        .holiday-controls .input-group {
          margin-bottom: 0;
        }

        .holiday-controls select {
          min-width: 120px;
        }

        .holidays-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
        }

        .holiday-card {
          background: white;
          border: 1px solid #e9ecef;
          border-radius: 12px;
          padding: 20px;
          transition: all 0.3s;
          position: relative;
        }

        .holiday-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .holiday-card.today {
          border-color: #dc3545;
          background: #fff5f5;
        }

        .holiday-card.upcoming {
          border-color: #28a745;
        }

        .holiday-card.past {
          opacity: 0.6;
        }

        .holiday-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
        }

        .holiday-date {
          font-size: 0.9rem;
          font-weight: 600;
          color: #667eea;
        }

        .holiday-type {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .holiday-type.national {
          background: #e3f2fd;
          color: #1976d2;
        }

        .holiday-type.state {
          background: #e8f5e8;
          color: #2e7d32;
        }

        .holiday-type.religious {
          background: #fff3e0;
          color: #f57c00;
        }

        .holiday-type.festival {
          background: #f3e5f5;
          color: #7b1fa2;
        }

        .holiday-name {
          font-size: 1.1rem;
          font-weight: 600;
          margin-bottom: 8px;
          color: #333;
        }

        .holiday-description {
          font-size: 0.9rem;
          color: #666;
          margin-bottom: 12px;
          line-height: 1.4;
        }

        .holiday-countdown {
          font-size: 0.9rem;
          font-weight: 600;
          padding: 6px 12px;
          border-radius: 6px;
          display: inline-block;
        }

        .holiday-countdown.today {
          background: #dc3545;
          color: white;
        }

        .holiday-countdown.upcoming {
          background: #28a745;
          color: white;
        }

        /* History Styles */
        .history-container {
          display: flex;
          flex-direction: column;
          gap: 32px;
        }

        .history-section {
          background: #f8f9fa;
          border-radius: 12px;
          padding: 24px;
        }

        .section-header {
          margin-bottom: 20px;
          padding-bottom: 12px;
          border-bottom: 2px solid #e9ecef;
        }

        .section-header h3 {
          font-size: 1.2rem;
          color: #333;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .history-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 16px;
        }

        .history-card {
          background: white;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 16px;
          border-left: 4px solid #667eea;
        }

        .history-card.cgpa {
          border-left-color: #667eea;
        }

        .history-card.attendance {
          border-left-color: #28a745;
        }

        .history-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .delete-history-btn {
          background: rgba(220, 53, 69, 0.1);
          border: 1px solid rgba(220, 53, 69, 0.3);
          color: #dc3545;
          padding: 6px 8px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 0.8rem;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .delete-history-btn:hover {
          background: #dc3545;
          color: white;
          transform: scale(1.05);
        }

        .history-date {
          font-size: 0.8rem;
          color: #666;
        }

        .history-value {
          font-size: 1.5rem;
          font-weight: 600;
          margin-bottom: 4px;
        }

        .history-value.cgpa {
          color: #667eea;
        }

        .history-value.attendance {
          color: #28a745;
        }

        .history-details {
          font-size: 0.9rem;
          color: #666;
        }

        /* Flash Messages */
        #flashMessages {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
        }

        .flash-message {
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 8px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          min-width: 300px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          animation: slideIn 0.3s ease-out;
        }

        .flash-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }

        .flash-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }

        .flash-close {
          background: none;
          border: none;
          font-size: 1.2rem;
          cursor: pointer;
          color: inherit;
          opacity: 0.7;
        }

        .flash-close:hover {
          opacity: 1;
        }

        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        /* Modern Utility Classes */
        .glass-card {
          background: var(--glass-bg);
          backdrop-filter: blur(20px);
          border: 1px solid var(--glass-border);
          border-radius: var(--border-radius-xl);
          box-shadow: var(--glass-shadow);
          transition: var(--transition-smooth);
        }

        .glass-card:hover {
          box-shadow: var(--glass-shadow-hover);
          transform: translateY(-5px);
        }

        .modern-gradient-text {
          background: var(--primary-gradient);
          background-size: 200% 200%;
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          animation: gradientShift 4s ease-in-out infinite;
        }

        .floating-element {
          animation: modernFloat 6s ease-in-out infinite;
        }

        /* Event Calendar Styles */
        .calendar-date {
          position: relative;
          min-height: 70px;
          padding: 10px;
          border: 1px solid #e9ecef;
          cursor: pointer;
          transition: all 0.3s ease;
          background: white;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }

        .calendar-date:hover {
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          border-color: #6c5ce7;
        }

        .calendar-date.today {
          background: white;
          color: #2d3436;
          font-weight: bold;
          border: 3px solid #0984e3;
          box-shadow: 0 0 0 2px rgba(9, 132, 227, 0.2), 0 4px 12px rgba(9, 132, 227, 0.15);
        }

        .calendar-date.today:hover {
          background: #f8f9fa;
          transform: translateY(-2px);
          box-shadow: 0 0 0 2px rgba(9, 132, 227, 0.3), 0 6px 16px rgba(9, 132, 227, 0.2);
        }

        .calendar-date.has-events {
          border: 2px solid #00b894;
          background: linear-gradient(135deg, #f1f9f7 0%, #e8f5f0 100%);
        }

        .calendar-date.has-events:hover {
          background: linear-gradient(135deg, #e8f5f0 0%, #d1f2eb 100%);
          border-color: #00a085;
        }

        .calendar-date.today.has-events {
          background: linear-gradient(135deg, #f1f9f7 0%, #e8f5f0 100%);
          border: 3px solid #0984e3;
          box-shadow: 0 0 0 2px rgba(9, 132, 227, 0.2), 0 0 0 4px rgba(0, 184, 148, 0.2), 0 4px 12px rgba(9, 132, 227, 0.15);
        }

        .calendar-date.other-month {
          opacity: 0.3;
          background: #f8f9fa;
        }

        .calendar-date.other-month:hover {
          opacity: 0.6;
        }

        .date-number {
          font-weight: 600;
          font-size: 18px;
          line-height: 1;
          color: #2d3436;
          text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .calendar-date.today .date-number {
          color: #0984e3;
          font-weight: 700;
          font-size: 20px;
        }

        .event-indicator {
          position: absolute;
          bottom: 4px;
          right: 4px;
          background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
          color: white;
          border-radius: 12px;
          min-width: 20px;
          height: 20px;
          font-size: 11px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          padding: 0 6px;
          box-shadow: 0 2px 6px rgba(0, 184, 148, 0.3);
        }

        /* Event Indicator Color Variations */
        .event-indicator-blue {
          background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
          box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }

        .event-indicator-green {
          background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
          box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }

        .event-indicator-red {
          background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
          box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
        }

        .event-indicator-purple {
          background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
          box-shadow: 0 2px 6px rgba(156, 39, 176, 0.3);
        }

        .event-indicator-orange {
          background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
          box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }

        .event-indicator-pink {
          background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
          box-shadow: 0 2px 6px rgba(233, 30, 99, 0.3);
        }

        .calendar-date.today .event-indicator {
          border: 2px solid white;
        }

        /* Event Details Panel */
        .event-item {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 8px;
          border-left: 4px solid #2196f3;
        }

        /* Event Color Variations */
        .event-item.event-color-blue {
          border-left-color: #2196f3;
          background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .event-item.event-color-green {
          border-left-color: #4caf50;
          background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        }

        .event-item.event-color-red {
          border-left-color: #f44336;
          background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
        }

        .event-item.event-color-purple {
          border-left-color: #9c27b0;
          background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
        }

        .event-item.event-color-orange {
          border-left-color: #ff9800;
          background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
        }

        .event-item.event-color-pink {
          border-left-color: #e91e63;
          background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%);
        }

        .event-title {
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
        }

        .event-time {
          color: #666;
          font-size: 0.9em;
          margin-bottom: 4px;
        }

        .event-description {
          color: #555;
          font-size: 0.9em;
          margin-bottom: 4px;
        }

        .event-type {
          display: inline-block;
          background: #e3f2fd;
          color: #1976d2;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 0.8em;
          text-transform: capitalize;
        }

        /* Event Type Color Variations */
        .event-type-blue {
          background: #e3f2fd;
          color: #1976d2;
        }

        .event-type-green {
          background: #e8f5e8;
          color: #2e7d32;
        }

        .event-type-red {
          background: #ffebee;
          color: #c62828;
        }

        .event-type-purple {
          background: #f3e5f5;
          color: #7b1fa2;
        }

        .event-type-orange {
          background: #fff3e0;
          color: #ef6c00;
        }

        .event-type-pink {
          background: #fce4ec;
          color: #c2185b;
        }

        .event-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 8px;
        }

        .event-actions {
          display: flex;
          gap: 4px;
          opacity: 0;
          transition: opacity 0.2s ease;
        }

        .event-item:hover .event-actions {
          opacity: 1;
        }

        .btn-icon {
          background: none;
          border: none;
          padding: 4px 6px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s ease;
        }

        .btn-icon.edit-btn {
          color: #0984e3;
        }

        .btn-icon.edit-btn:hover {
          background: #e3f2fd;
          color: #0652dd;
        }

        .btn-icon.delete-btn {
          color: #e17055;
        }

        .btn-icon.delete-btn:hover {
          background: #ffeaa7;
          color: #d63031;
        }

        /* CGPA Analysis Modal Styles */
        .modal-xl {
          max-width: 95vw;
          width: 95vw;
        }

        .cgpa-summary-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .summary-card {
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          border-radius: 12px;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 16px;
          border-left: 4px solid #6c5ce7;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .summary-card.primary {
          border-left-color: #6c5ce7;
          background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .summary-card.success {
          border-left-color: #00b894;
          background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        }

        .summary-card.info {
          border-left-color: #0984e3;
          background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
        }

        .summary-icon {
          font-size: 2rem;
          opacity: 0.8;
        }

        .summary-value {
          font-size: 2rem;
          font-weight: 700;
          color: #2d3436;
          line-height: 1;
        }

        .summary-label {
          font-size: 0.9rem;
          color: #636e72;
          margin-top: 4px;
        }

        .summary-scale {
          font-size: 0.8rem;
          color: #74b9ff;
          font-weight: 500;
        }

        .scale-conversions {
          margin-bottom: 30px;
        }

        .scale-conversions h6 {
          color: #2d3436;
          margin-bottom: 16px;
          font-weight: 600;
        }

        .conversion-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
        }

        .conversion-card {
          background: white;
          border-radius: 8px;
          padding: 16px;
          text-align: center;
          border: 2px solid #e9ecef;
          transition: all 0.3s ease;
        }

        .conversion-card:hover {
          border-color: #6c5ce7;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(108, 92, 231, 0.15);
        }

        .conversion-value {
          font-size: 1.5rem;
          font-weight: 700;
          color: #6c5ce7;
          margin-bottom: 8px;
        }

        .conversion-label {
          font-size: 0.9rem;
          color: #2d3436;
          font-weight: 600;
          margin-bottom: 4px;
        }

        .conversion-formula {
          font-size: 0.75rem;
          color: #636e72;
          font-style: italic;
        }

        .charts-section {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 30px;
          margin-bottom: 30px;
        }

        .chart-container {
          background: white;
          border-radius: 12px;
          padding: 20px;
          border: 1px solid #e9ecef;
        }

        .chart-container h6 {
          color: #2d3436;
          margin-bottom: 16px;
          font-weight: 600;
        }

        .semester-details {
          background: white;
          border-radius: 12px;
          padding: 20px;
          border: 1px solid #e9ecef;
        }

        .semester-details h6 {
          color: #2d3436;
          margin-bottom: 16px;
          font-weight: 600;
        }

        .table-responsive {
          border-radius: 8px;
          overflow: hidden;
        }

        .table {
          margin-bottom: 0;
        }

        .table th {
          background: #f8f9fa;
          color: #2d3436;
          font-weight: 600;
          border: none;
          padding: 12px;
        }

        .table td {
          padding: 12px;
          border-color: #e9ecef;
        }

        .performance-badge {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
        }

        .performance-excellent {
          background: #d1f2eb;
          color: #00b894;
        }

        .performance-good {
          background: #e3f2fd;
          color: #0984e3;
        }

        .performance-average {
          background: #fff3e0;
          color: #ff9800;
        }

        .performance-poor {
          background: #ffebee;
          color: #f44336;
        }

        /* Clickable History Cards */
        .history-card.clickable {
          cursor: pointer;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        .history-card.clickable:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: #6c5ce7;
        }

        .history-card.clickable::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(108, 92, 231, 0.1), transparent);
          transition: left 0.5s ease;
        }

        .history-card.clickable:hover::before {
          left: 100%;
        }

        .click-hint {
          margin-top: 8px;
          padding: 6px 8px;
          background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
          color: white;
          border-radius: 6px;
          font-size: 0.75rem;
          text-align: center;
          opacity: 0;
          transform: translateY(10px);
          transition: all 0.3s ease;
        }

        .history-card.clickable:hover .click-hint {
          opacity: 1;
          transform: translateY(0);
        }

        .click-hint i {
          margin-right: 4px;
        }

        /* Semester Header */
        .semester-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .semester-header h6 {
          margin: 0;
        }

        /* Add Semester Modal Styles */
        .semester-preview {
          margin-top: 20px;
          padding: 16px;
          background: #f8f9fa;
          border-radius: 8px;
          border-left: 4px solid #6c5ce7;
        }

        .semester-preview h6 {
          margin-bottom: 12px;
          color: #2d3436;
        }

        .preview-card {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        .preview-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          background: white;
          border-radius: 6px;
          border: 1px solid #e9ecef;
        }

        .preview-label {
          font-weight: 600;
          color: #636e72;
          font-size: 0.9rem;
        }

        .preview-value {
          font-weight: 700;
          color: #2d3436;
        }

        /* Chart container improvements */
        .chart-container canvas {
          max-height: 300px;
        }

        /* Mobile responsive for semester header */
        @media (max-width: 768px) {
          .semester-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
          }

          .semester-header .btn {
            width: 100%;
          }

          .preview-card {
            grid-template-columns: 1fr;
          }
        }

        @keyframes modernFloat {
          0%, 100% { transform: translateY(0px) rotate(0deg); }
          33% { transform: translateY(-10px) rotate(1deg); }
          66% { transform: translateY(5px) rotate(-1deg); }
        }

        .shimmer {
          position: relative;
          overflow: hidden;
        }

        .shimmer::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
          0% { left: -100%; }
          100% { left: 100%; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .dashboard-container {
            padding: 12px;
          }

          .header-content {
            flex-direction: column;
            text-align: center;
          }

          .modern-clock-container {
            order: -1;
            margin-bottom: 16px;
            margin-right: 0;
          }

          .modern-flip-clock {
            padding: 12px 16px;
          }

          .flip-digit {
            width: 28px;
            height: 38px;
          }

          .flip-digit-front, .flip-digit-back {
            font-size: 1.2rem;
          }

          .time-separator {
            font-size: 1.4rem;
            margin: 0 4px;
          }

          .am-pm-indicator {
            padding: 6px 8px;
            font-size: 0.8rem;
            margin-left: 6px;
          }

          .clock-details {
            font-size: 0.7rem;
          }

          .dashboard-title {
            font-size: 1.5rem;
          }

          .tab-navigation {
            flex-direction: column;
          }

          .tab-btn {
            min-width: auto;
          }

          .calculator-grid {
            grid-template-columns: 1fr;
          }

          .semester-inputs {
            grid-template-columns: 1fr;
          }

          .input-row {
            grid-template-columns: 1fr;
          }

          .gpa-scales {
            grid-template-columns: 1fr;
          }

          .holidays-grid {
            grid-template-columns: 1fr;
          }

          .history-grid {
            grid-template-columns: 1fr;
          }

          .action-buttons {
            flex-direction: column;
          }

          .form-row {
            grid-template-columns: 1fr;
          }

          .modal-actions {
            flex-direction: column;
          }

          #flashMessages {
            left: 12px;
            right: 12px;
          }

          .flash-message {
            min-width: auto;
          }
        }

        /* Enhanced Mobile Styles for Better UX */
        @media (max-width: 768px) {
          /* App Layout Responsive */
          .app-layout {
            flex-direction: column;
          }

          .sidebar {
            width: 100%;
            min-width: 100%;
            position: relative;
            max-height: none;
            margin-bottom: 20px;
          }

          .sidebar-nav {
            padding: 16px 0;
          }

          .nav-section {
            margin-bottom: 16px;
          }

          .nav-btn {
            padding: 10px 16px;
            font-size: 0.9rem;
          }

          .main-content-wrapper {
            margin-left: 0;
          }

          .budget-breakdown-grid {
            grid-template-columns: 1fr;
          }

          .stats-grid {
            grid-template-columns: repeat(2, 1fr);
          }

          /* Navigation improvements */
          .nav-tabs {
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: none;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
          }

          .nav-tabs .nav-link {
            font-size: 0.8rem;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 8px;
            border: none;
            min-width: auto;
            flex: 1;
            text-align: center;
          }

          .nav-tabs .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            border: none;
          }

          /* Form improvements for mobile */
          .form-control {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px;
            border-radius: 8px;
          }

          .btn {
            padding: 12px 16px;
            font-size: 0.9rem;
            min-height: 44px; /* Touch-friendly */
            border-radius: 8px;
          }

          /* Modal improvements for mobile */
          .modal-dialog {
            margin: 8px;
            max-width: calc(100vw - 16px);
          }

          .modal-content {
            border-radius: 12px;
          }

          .modal-header {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
          }

          .modal-body {
            padding: 16px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
          }

          .modal-footer {
            padding: 16px;
            flex-direction: column;
            gap: 8px;
            border-top: 1px solid #e9ecef;
          }

          .modal-footer .btn {
            width: 100%;
            margin: 0;
          }

          /* Reminder cards mobile optimization */
          .reminder-card {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
          }

          .reminder-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
          }

          .reminder-title {
            font-size: 1rem;
            line-height: 1.3;
          }

          .reminder-actions {
            width: 100%;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
          }

          .reminder-actions .btn {
            font-size: 0.8rem;
            padding: 6px 12px;
            min-height: 36px;
          }

          /* Calendar mobile improvements */
          .calendar-date {
            min-height: 60px;
            padding: 6px;
            font-size: 0.9rem;
          }

          .date-number {
            font-size: 14px;
          }

          .event-indicator {
            min-width: 16px;
            height: 16px;
            font-size: 10px;
            bottom: 2px;
            right: 2px;
          }

          /* Event details panel mobile */
          .event-item {
            padding: 10px;
            margin-bottom: 8px;
          }

          .event-title {
            font-size: 0.9rem;
          }

          .event-actions .btn-icon {
            padding: 6px;
            font-size: 11px;
          }

          /* CGPA Analysis Modal Mobile */
          .modal-xl {
            max-width: 100vw;
            width: 100vw;
            margin: 0;
          }

          .cgpa-summary-cards {
            grid-template-columns: 1fr;
            gap: 12px;
          }

          .summary-card {
            padding: 16px;
            gap: 12px;
          }

          .summary-icon {
            font-size: 1.5rem;
          }

          .summary-value {
            font-size: 1.5rem;
          }

          .conversion-cards {
            grid-template-columns: 1fr;
            gap: 12px;
          }

          .charts-section {
            grid-template-columns: 1fr;
            gap: 20px;
          }

          .chart-container {
            padding: 16px;
          }

          .semester-details {
            padding: 16px;
          }

          .table th,
          .table td {
            padding: 8px 4px;
            font-size: 0.8rem;
          }
        }

        @media (max-width: 480px) {
          .dashboard-title {
            font-size: 1.3rem;
          }

          .tab-content {
            padding: 12px;
          }

          .card-content {
            padding: 12px;
          }

          .cgpa-value,
          .attendance-percentage {
            font-size: 1.8rem;
          }

          /* Ultra-small screen optimizations */
          .modern-flip-clock {
            transform: scale(0.8);
          }

          .nav-tabs .nav-link {
            font-size: 0.75rem;
            padding: 6px 8px;
          }

          .reminder-card {
            padding: 10px;
          }

          .calendar-date {
            min-height: 50px;
            padding: 4px;
          }

          .date-number {
            font-size: 12px;
          }

          .event-indicator {
            min-width: 14px;
            height: 14px;
            font-size: 9px;
          }

          .modal-content {
            margin: 10px;
          }

          /* Reminder responsive styles */
          .form-grid {
            grid-template-columns: 1fr;
            gap: 16px;
          }

          .reminders-grid {
            grid-template-columns: 1fr;
          }

          .reminder-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
          }

          .button-group {
            flex-direction: column;
          }

          .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
          }

          .reminders-header h2 {
            font-size: 1.8rem;
          }

          .card-content {
            padding: 16px;
          }

          .card-header {
            padding: 16px;
          }
        }

        /* Calendar Grid Styles */
        .calendar-weekdays {
          display: grid !important;
          grid-template-columns: repeat(7, 1fr) !important;
          gap: 0 !important;
          margin-bottom: 0;
          border: 1px solid #e9ecef;
          border-bottom: none;
        }

        .calendar-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 2px;
          background: #f1f3f4;
          padding: 2px 2px 0 2px;
          border-radius: 12px 12px 0 0;
        }

        .weekday {
          background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
          padding: 12px 8px;
          text-align: center;
          font-weight: 600;
          color: white;
          font-size: 0.9rem;
          border-radius: 8px 8px 0 0;
        }

        .calendar-dates-grid {
          display: grid !important;
          grid-template-columns: repeat(7, 1fr) !important;
          gap: 2px !important;
          background: #f1f3f4;
          padding: 2px;
          border-radius: 0 0 12px 12px;
          width: 100%;
          max-width: 100%;
        }

        .calendar-date {
          background: white;
          min-height: 120px;
          border-right: 1px solid #e9ecef;
          border-bottom: 1px solid #e9ecef;
          padding: 8px;
          position: relative;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .calendar-date:hover {
          background-color: #f8f9fa;
        }

        .calendar-date:last-child {
          border-right: none;
        }

        .date-number {
          font-weight: 600;
          font-size: 1.1rem;
          color: #333;
          margin-bottom: 4px;
        }

        .other-month {
          color: #ccc !important;
          background-color: #f8f9fa !important;
        }

        .other-month .date-number {
          color: #ccc !important;
          font-weight: 400 !important;
        }

        .today {
          background-color: #e3f2fd;
          border: 2px solid #2196f3;
        }

        .today .date-number {
          color: #1976d2;
          font-weight: 700;
        }

        .has-event {
          background-color: #fff3e0;
        }

        .event-indicator {
          position: absolute;
          bottom: 4px;
          left: 4px;
          right: 4px;
          background: #ff9800;
          color: white;
          font-size: 0.7rem;
          padding: 2px 4px;
          border-radius: 3px;
          text-align: center;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        /* Mode Button Styling */
        .mode-buttons {
          display: flex;
          gap: 0;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mode-btn {
          background: white;
          border: 1px solid #dee2e6;
          padding: 12px 20px;
          font-weight: 500;
          color: #495057;
          transition: all 0.2s ease;
          border-radius: 0;
          position: relative;
        }

        .mode-btn:first-child {
          border-top-left-radius: 8px;
          border-bottom-left-radius: 8px;
        }

        .mode-btn:last-child {
          border-top-right-radius: 8px;
          border-bottom-right-radius: 8px;
          border-left: none;
        }

        .mode-btn:hover {
          background: #f8f9fa;
          color: #495057;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .mode-btn.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-color: #667eea;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .mode-btn.active:hover {
          background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
          transform: translateY(-1px);
          box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .mode-btn i {
          margin-right: 8px;
        }

        @media (max-width: 768px) {
          .calendar-dates-grid {
            grid-template-columns: repeat(7, 1fr) !important;
          }

          .calendar-date {
            min-height: 80px;
            padding: 4px;
          }

          .date-number {
            font-size: 1rem;
          }

          .mode-btn {
            padding: 10px 16px;
            font-size: 0.9rem;
          }
        }

        /* Message Styles */
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Conversation List Styles */
        .conversation-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .conversation-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .conversation-item:hover {
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px);
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.95);
        }

        .conversation-item:hover::before {
            transform: scaleX(1);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .conversation-sender {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sender-info h5 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sender-info h5::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-left: 4px;
        }

        .message-time {
            font-size: 12px;
            color: #6c757d;
            display: block;
        }

        .last-message {
            font-size: 14px;
            color: #6c757d;
            margin-left: 56px;
            font-style: italic;
            line-height: 1.4;
            position: relative;
            padding-left: 16px;
            border-left: 2px solid rgba(102, 126, 234, 0.2);
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .unread-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #dc3545 100%);
            color: white;
            border-radius: 50%;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
            padding: 0 6px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }

        /* Conversation View Styles */
        .conversation-view {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .conversation-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .conversation-header-bar h4 {
            margin: 0;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-header-bar h4 i {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 50%;
            font-size: 16px;
        }

        .conversation-header-bar .btn {
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .conversation-header-bar .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            max-height: 500px;
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .message-bubble {
            max-width: 75%;
            display: flex;
            flex-direction: column;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-bubble.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble .message-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            color: rgba(0, 0, 0, 0.5);
            font-weight: 500;
        }

        .message-bubble.sent .message-info {
            flex-direction: row-reverse;
            text-align: right;
        }

        .message-bubble .sender {
            font-weight: 600;
            color: #667eea;
        }

        .message-bubble.sent .sender {
            color: #764ba2;
        }

        .message-bubble .message-text {
            background: white;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 14px;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-bubble.sent .message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .message-bubble.received .message-text {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .message-subject {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 6px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            backdrop-filter: blur(5px);
        }

        .message-bubble.sent .message-subject {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .empty-conversation {
            text-align: center;
            padding: 60px 20px;
            color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .empty-conversation i {
            font-size: 48px;
            color: rgba(102, 126, 234, 0.3);
            margin-bottom: 16px;
        }

        .empty-conversation h3 {
            margin: 0;
            color: #667eea;
            font-weight: 600;
        }

        .empty-conversation p {
            margin: 0;
            font-style: italic;
        }

        .empty-conversation .btn {
            margin-top: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .empty-conversation .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Message Date Divider */
        .message-date-divider {
            text-align: center;
            margin: 24px 0 16px 0;
            position: relative;
        }

        .message-date-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        }

        .message-date-divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .conversation-header-bar {
                padding: 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .conversation-header-bar h4 {
                font-size: 16px;
            }

            .conversation-header-bar .btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .messages-container {
                padding: 16px;
                max-height: 400px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .message-bubble .message-text {
                padding: 12px 16px;
                font-size: 13px;
            }
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="dashboard-title">🎓 Academia </h1>
                    <h2 class  = "dashboard-subtitle">Where Knowledge Meets Convenience</h2>
                    <p class="dashboard-subtitle">Welcome, {{ session.username }}!</p>
                </div>
                <div class="header-right">
                    <!-- Modern Flip Clock -->
                    <div class="modern-clock-container">
                        <div class="modern-flip-clock">
                            <div class="time-display">
                                <div class="flip-digit-group">
                                    <div class="flip-digit" id="hour1">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                    <div class="flip-digit" id="hour2">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="time-separator">:</div>
                                <div class="flip-digit-group">
                                    <div class="flip-digit" id="minute1">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                    <div class="flip-digit" id="minute2">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="time-separator">:</div>
                                <div class="flip-digit-group">
                                    <div class="flip-digit" id="second1">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                    <div class="flip-digit" id="second2">
                                        <div class="flip-digit-inner">
                                            <div class="flip-digit-front">0</div>
                                            <div class="flip-digit-back">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="am-pm-indicator" id="amPmIndicator">AM</div>
                            </div>
                            <div class="clock-details">
                                <div class="timezone-info" id="timezoneInfo">Loading...</div>
                                <div class="date-info" id="dateInfo">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Clock and Countdown Stack -->
                    <div class="clock-countdown-stack">
                        <!-- Exam Countdown Display -->
                        <div id="examCountdown" class="exam-countdown" style="display: none;">
                            <div class="countdown-content">
                                <div class="countdown-title">Next Exam</div>
                                <div class="countdown-subject" id="countdownSubject"></div>
                                <div class="countdown-timer" id="countdownTimer"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Removed theme and logout from header -->
                </div>
            </div>
        </header>

        <!-- App Layout Container -->
        <div class="app-layout">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="sidebarUserName">{{ session.student_name or session.username or 'Student' }}</div>
                            <div class="user-email" id="sidebarUserEmail">
                                {% if session.created_at and session.created_at != '' %}
                                    {% set created_date = session.created_at[:10] %}
                                    {% set date_parts = created_date.split('-') %}
                                    {% if date_parts|length == 3 %}
                                        Member since {{ date_parts[2] }}/{{ date_parts[1] }}/{{ date_parts[0] }}
                                    {% else %}
                                        Member since {{ created_date }}
                                    {% endif %}
                                {% else %}
                                    New Member
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Academic Tools</div>
                        <button class="nav-btn active" data-tab="reminders" type="button" onclick="switchTab('reminders')">
                            <i class="fas fa-bell"></i>
                            <span>Smart Reminders</span>
                        </button>
                        <button class="nav-btn" data-tab="cgpa" type="button" onclick="switchTab('cgpa')">
                            <i class="fas fa-graduation-cap"></i>
                            <span>CGPA Calculator</span>
                        </button>
                        <button class="nav-btn" data-tab="attendance" type="button" onclick="switchTab('attendance')">
                            <i class="fas fa-calendar-check"></i>
                            <span>Attendance</span>
                        </button>
                        <button class="nav-btn" data-tab="timetable" type="button" onclick="switchTab('timetable')">
                            <i class="fas fa-clock"></i>
                            <span>Timetable</span>
                        </button>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Organization</div>
                        <button class="nav-btn" data-tab="holidays" type="button" onclick="switchTab('holidays')">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Calendar</span>
                        </button>
                        <button class="nav-btn" data-tab="expenses" type="button" onclick="switchTab('expenses')">
                            <i class="fas fa-wallet"></i>
                            <span>Expenses</span>
                        </button>
                        <button class="nav-btn" data-tab="history" type="button" onclick="switchTab('history')">
                            <i class="fas fa-history"></i>
                            <span>History</span>
                        </button>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Chat</div>
                        <button class="nav-btn" data-tab="direct-messages" type="button" onclick="switchTab('direct-messages')">
                            <i class="fas fa-comment"></i>
                            <span>Direct Messages</span>
                        </button>
                        <button class="nav-btn" data-tab="team" type="button" onclick="switchTab('team')">
                            <i class="fas fa-users"></i>
                            <span>Team</span>
                        </button>
                        <button class="nav-btn" data-tab="requests" type="button" onclick="switchTab('requests')">
                            <i class="fas fa-user-plus"></i>
                            <span>Requests</span>
                        </button>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <button class="nav-btn theme-btn" onclick="toggleTheme()" type="button" title="Toggle Dark/Light Theme">
                        <i class="fas fa-moon" id="themeIcon"></i>
                        <span>Theme</span>
                    </button>
                    <a href="{{ url_for('logout') }}" class="nav-btn logout-btn" style="text-decoration: none; color: inherit;" onclick="clearUserSession()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="main-content-wrapper">
                <!-- Tab Contents -->
                <main class="tab-content">
            <!-- Smart Reminders Tab -->
            <div id="reminders" class="tab-pane active">
                <div class="reminders-header">
                    <h2><i class="fas fa-bell"></i> Smart Student Reminder System</h2>
                    <p class="feature-description">Paste messages from WhatsApp, emails, or any text to automatically create smart reminders!</p>
                </div>

                <!-- Your Reminders Section (moved to top) -->
                <div class="section-header">
                    <h3><i class="fas fa-list"></i> Your Reminders</h3>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="fixReminderTimes()" title="Fix reminder times from descriptions">
                            <i class="fas fa-clock"></i> Fix Times
                        </button>
                        <div id="storageStatus" class="storage-status" title="LocalStorage backup status">
                            <i class="fas fa-database"></i>
                            <span id="storageStatusText">Checking...</span>
                        </div>
                        <button onclick="showStorageStatus()" class="btn btn-secondary" type="button" title="Show storage details">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button onclick="loadReminders()" class="btn btn-primary" type="button">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Reminder Statistics (moved to top) -->
                <div id="reminderStats" class="reminder-stats" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-item critical">
                            <div class="stat-number" id="criticalCount">0</div>
                            <div class="stat-label">Critical</div>
                        </div>
                        <div class="stat-item urgent">
                            <div class="stat-number" id="urgentCount">0</div>
                            <div class="stat-label">Urgent</div>
                        </div>
                        <div class="stat-item overdue">
                            <div class="stat-number" id="overdueCount">0</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                        <div class="stat-item due-today">
                            <div class="stat-number" id="dueTodayCount">0</div>
                            <div class="stat-label">Due Today</div>
                        </div>
                        <div class="stat-item total">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>

                <!-- Filter Options (moved to top of reminders) -->
                <div class="reminder-filters">
                    <div class="filter-group">
                        <label for="categoryFilter">Category:</label>
                        <select id="categoryFilter" onchange="applyFilters()">
                            <option value="all">All</option>
                            <option value="assignment">📝 Assignment</option>
                            <option value="exam">📚 Exam</option>
                            <option value="project">🎯 Project</option>
                            <option value="lab">🧪 Lab</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="priorityFilter">Priority:</label>
                        <select id="priorityFilter" onchange="applyFilters()">
                            <option value="all">All</option>
                            <option value="critical">🔴 Critical</option>
                            <option value="urgent">🟠 Urgent</option>
                            <option value="overdue">🚨 Overdue</option>
                            <option value="due_today">📅 Due Today</option>
                            <option value="due_tomorrow">📆 Due Tomorrow</option>
                            <option value="upcoming">🗓️ Upcoming</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="clearFilters" onclick="clearAllFilters()" class="clear-filters-btn">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <div id="remindersContainer" class="reminders-grid">
                    <div class="empty-state">
                        <i class="fas fa-bell empty-icon"></i>
                        <p>No reminders yet. Add your first reminder below!</p>
                    </div>
                </div>

                <!-- Message Input Section -->
                <div class="message-input-section">
                    <div class="input-card">
                        <div class="card-header">
                            <h3><i class="fas fa-paste"></i> Paste Your Message</h3>
                            <p>Copy and paste messages from WhatsApp, emails, or any text containing assignment/exam information</p>
                        </div>
                        <div class="card-content">
                            <div class="input-group">
                                <label for="messageInput">Message Text</label>
                                <textarea id="messageInput" placeholder="Paste your message here...

Example:
'Hi students, your Data Structures assignment is due on 20th July 2025. Please submit before 11:59 PM.'

or

'Reminder: Machine Learning exam on 25/07/2025 at 10:00 AM in Hall A.'" rows="8" style="width: 100%; min-height: 150px; resize: vertical;"></textarea>
                            </div>
                            <div class="button-group">
                                <button onclick="parseMessage()" class="btn btn-primary" type="button">
                                    <i class="fas fa-magic"></i> Parse Message
                                </button>
                                <button onclick="clearMessage()" class="btn btn-secondary" type="button">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Reminder Form -->
                <div class="reminder-form-section">
                    <div class="input-card">
                        <div class="card-header">
                            <h3><i class="fas fa-edit"></i> Create Reminder</h3>
                            <p>Review parsed information or create a reminder manually</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="input-group">
                                    <label for="reminderTitle">Title *</label>
                                    <input type="text" id="reminderTitle" placeholder="e.g., Data Structures Assignment" required>
                                </div>
                                <div class="input-group">
                                    <label for="reminderType">Type</label>
                                    <select id="reminderType">
                                        <option value="assignment">📝 Assignment</option>
                                        <option value="exam">📚 Exam</option>
                                        <option value="project">🎯 Project</option>
                                        <option value="lab">🧪 Lab</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="reminderDate">Due Date</label>
                                    <input type="date" id="reminderDate">
                                </div>
                                <div class="time-description-row">
                                    <div class="input-group">
                                        <label for="reminderTime">⏰ Time (Optional)</label>
                                        <div class="time-input-container">
                                            <select id="reminderTimeHour" class="time-select">
                                                <option value="">Hr</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                                <option value="5">5</option>
                                                <option value="6">6</option>
                                                <option value="7">7</option>
                                                <option value="8">8</option>
                                                <option value="9">9</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                            </select>
                                            <span class="time-separator">:</span>
                                            <select id="reminderTimeMinute" class="time-select">
                                                <option value="">Min</option>
                                                <option value="00">00</option>
                                                <option value="15">15</option>
                                                <option value="30">30</option>
                                                <option value="45">45</option>
                                                <option value="59">59</option>
                                            </select>
                                            <select id="reminderTimeAmPm" class="time-select">
                                                <option value="">AM/PM</option>
                                                <option value="AM">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                        <input type="hidden" id="reminderTime">
                                        <small class="input-help">Leave empty for default time</small>
                                    </div>
                                    <div class="input-group description-group">
                                        <label for="reminderDescription">Description</label>
                                        <textarea id="reminderDescription" placeholder="Additional details about the reminder..." rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="button-group">
                                <button onclick="saveReminder()" class="btn btn-success" type="button">
                                    <i class="fas fa-save"></i> Save Reminder
                                </button>
                                <button onclick="resetReminderForm()" class="btn btn-secondary" type="button">
                                    <i class="fas fa-undo"></i> Reset Form
                                </button>
                                <button onclick="cleanupDuplicateReminders()" class="btn btn-warning" type="button">
                                    <i class="fas fa-broom"></i> Remove Duplicates
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Settings Section -->
                <div class="email-settings-section">
                    <div class="settings-header" onclick="toggleEmailSettings()">
                        <h3><i class="fas fa-envelope"></i> Email Notifications</h3>
                        <button type="button" class="toggle-btn">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div id="emailSettingsContent" class="settings-content" style="display: none;">
                        <div class="settings-card">
                            <div class="setting-item">
                                <label class="switch">
                                    <input type="checkbox" id="emailEnabled">
                                    <span class="slider"></span>
                                </label>
                                <div class="setting-info">
                                    <div class="setting-title">Enable Email Reminders</div>
                                    <div class="setting-description">Receive email notifications for upcoming deadlines</div>
                                </div>
                            </div>

                            <div id="emailOptions" style="display: none;">
                                <div class="input-group">
                                    <label for="emailAddress">Email Address</label>
                                    <input type="email" id="emailAddress" placeholder="your.email@example.com">
                                </div>

                                <div class="notification-options">
                                    <h4>Notification Timing</h4>
                                    <div class="option-grid">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="notify24h" checked>
                                            <span class="checkmark"></span>
                                            24 hours before due date
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="notify1h" checked>
                                            <span class="checkmark"></span>
                                            1 hour before due date
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="notifyOverdue" checked>
                                            <span class="checkmark"></span>
                                            When overdue
                                        </label>
                                    </div>
                                </div>

                                <div class="settings-actions">
                                    <button onclick="saveEmailSettings()" class="btn btn-success" type="button">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                    <button onclick="sendTestEmail()" class="btn btn-secondary" type="button">
                                        <i class="fas fa-paper-plane"></i> Send Test Email
                                    </button>
                                    <button onclick="checkEmailNotifications()" class="btn btn-warning" type="button">
                                        <i class="fas fa-bell"></i> Check Email Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reminders Display -->
                <div class="reminders-display-section">




                </div>
            </div>

            <!-- CGPA Calculator Tab -->
            <div id="cgpa" class="tab-pane">
                <div class="formula-info">
                    <strong>CGPA Formula:</strong> CGPA = Σ(SGPA × Credits) / Σ(Credits)
                </div>

                <div class="calculator-grid">
                    <div class="calculator-card">
                        <div class="card-header">
                            <h3>📝 Enter Semester Details</h3>
                        </div>
                        <div class="card-content">
                            <div class="cgpa-scale-selector">
                                <div class="input-group">
                                    <label>CGPA Scale</label>
                                    <select id="cgpaScale" onchange="updateCGPAScale()">
                                        <option value="10">10 Point Scale (Indian Universities)</option>
                                        <option value="5">5 Point Scale (German System)</option>
                                        <option value="4">4 Point Scale (US GPA)</option>
                                    </select>
                                </div>
                                <div class="scale-info" id="scaleInfo">
                                    <small>Range: 0.0 - 10.0 | Excellent: 9.0+, Good: 7.0-8.9, Average: 6.0-6.9</small>
                                </div>
                            </div>

                            <div id="semesterContainer" class="semester-container">
                                <div class="semester-item" data-semester="1">
                                    <div class="semester-header">
                                        <span class="semester-title">Semester 1</span>
                                        <button class="remove-semester" onclick="removeSemester(1)" style="display: none;" type="button">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="semester-inputs">
                                        <div class="input-group">
                                            <label>SGPA</label>
                                            <input type="number" step="0.01" min="0" max="10" placeholder="e.g., 8.37" class="sgpa-input">
                                        </div>
                                        <div class="input-group">
                                            <label>Credits</label>
                                            <input type="number" min="0" placeholder="e.g., 23" class="credits-input">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button onclick="addSemester()" class="btn btn-outline" type="button">
                                    <i class="fas fa-plus"></i> Add Semester
                                </button>
                                <button onclick="calculateCGPA()" class="btn btn-primary" type="button">
                                    <i class="fas fa-calculator"></i> Calculate CGPA
                                </button>
                                <button onclick="resetCGPA()" class="btn btn-outline" type="button">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-card">
                        <div class="card-header">
                            <h3>📈 Results</h3>
                        </div>
                        <div class="card-content">
                            <div id="cgpaResults" class="results-container">
                                <div class="empty-state">
                                    <i class="fas fa-calculator empty-icon"></i>
                                    <p>Enter your semester details and click "Calculate CGPA" to see your results</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-pane">
                <div class="formula-info">
                    <strong>Attendance Formula:</strong> Attendance % = (Classes Attended / Total Classes) × 100
                </div>
                
                <div class="calculator-grid">
                    <div class="calculator-card">
                        <div class="card-header">
                            <h3>📚 Attendance Details</h3>
                        </div>
                        <div class="card-content">
                            <div class="input-group">
                                <label>Subject Name</label>
                                <input type="text" id="subjectName" placeholder="e.g., Mathematics">
                            </div>
                            
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Classes Attended</label>
                                    <input type="number" id="attendedClasses" min="0" placeholder="e.g., 45">
                                </div>
                                <div class="input-group">
                                    <label>Total Classes</label>
                                    <input type="number" id="totalClasses" min="1" placeholder="e.g., 60">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Minimum Required Percentage</label>
                                <input type="number" id="minRequired" min="0" max="100" step="0.1" value="75">
                            </div>
                            
                            <div class="action-buttons">
                                <button onclick="calculateAttendance()" class="btn btn-primary" type="button">
                                    <i class="fas fa-chart-line"></i> Calculate
                                </button>
                                <button onclick="saveAttendanceRecord()" class="btn btn-success" type="button">
                                    <i class="fas fa-save"></i> Save Record
                                </button>
                                <button onclick="resetAttendance()" class="btn btn-outline" type="button">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-card">
                        <div class="card-header">
                            <h3>📊 Attendance Status</h3>
                        </div>
                        <div class="card-content">
                            <div id="attendanceResults" class="results-container">
                                <div class="empty-state">
                                    <i class="fas fa-book-open empty-icon"></i>
                                    <p>Enter your attendance details to see your status and recommendations</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="holidays" class="tab-pane">
                <div class="calendar-header">
                    <h2>📅 Calendar</h2>

                    <!-- Mode Selection -->
                    <div class="calendar-mode-selection">
                        <div class="mode-buttons">
                            <button onclick="switchCalendarMode('calendar')" id="calendarModeBtn" class="mode-btn active" type="button">
                                <i class="fas fa-calendar-alt"></i> Calendar
                            </button>
                            <button onclick="switchCalendarMode('holidays')" id="holidaysModeBtn" class="mode-btn" type="button">
                                <i class="fas fa-star"></i> Holidays
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Mode -->
                <div id="calendarMode" class="calendar-mode-content">
                    <!-- Calendar Header with Navigation and Add Event Button -->
                    <div class="calendar-header-row">
                        <div class="calendar-navigation">
                            <button onclick="previousMonth()" class="nav-btn" type="button">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="current-month-year">
                                <span id="currentMonthYear">July 2025</span>
                            </div>
                            <button onclick="nextMonth()" class="nav-btn" type="button">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="calendar-actions">
                            <button onclick="goToToday()" class="btn btn-secondary" type="button">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                            <button onclick="openAddEventModal()" class="btn btn-primary" type="button">
                                <i class="fas fa-plus"></i> Add Event
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-view">
                        <div class="calendar-weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                        </div>
                        <div id="calendarGrid" class="calendar-dates-grid">
                            <!-- Calendar dates will be generated here -->
                        </div>
                    </div>

                    <!-- Event Details Panel -->
                    <div id="eventDetailsPanel" class="event-details-panel" style="display: none;">
                        <div class="panel-header">
                            <h4 id="selectedDateTitle">Events for Selected Date</h4>
                            <button onclick="closeEventPanel()" class="close-btn" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="eventsList" class="events-list">
                            <!-- Events for selected date will appear here -->
                        </div>
                        <div class="panel-actions">
                            <button onclick="openAddEventModal()" class="btn btn-success" type="button">
                                <i class="fas fa-plus"></i> Add Event
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Holidays Mode -->
                <div id="holidaysMode" class="calendar-mode-content" style="display: none;">
                    <div class="holidays-controls">
                        <div class="input-group" style="margin-right: 15px;">
                            <label>Year</label>
                            <select id="holidayYear" onchange="loadHolidaysList()">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-right: 15px;">
                            <label>Type</label>
                            <select id="holidayType" onchange="loadHolidaysList()">
                                <option value="">All Types</option>
                                <option value="national">National</option>
                                <option value="state">State</option>
                                <option value="religious">Religious</option>
                                <option value="festival">Festival</option>
                            </select>
                        </div>
                        <button onclick="loadHolidaysList()" class="btn btn-primary" type="button">
                            <i class="fas fa-star"></i> Load Holidays
                        </button>
                    </div>

                    <div id="holidaysContainer" class="holidays-grid">
                        <div class="empty-state">
                            <i class="fas fa-star empty-icon"></i>
                            <p>Select a year and click "Load Holidays" to see holidays</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-pane">
                <div class="history-container">
                    <div class="history-section">
                        <div class="section-header">
                            <h3><i class="fas fa-calculator"></i> CGPA Calculations</h3>
                            <button onclick="loadHistory()" class="btn btn-primary" type="button">
                                <i class="fas fa-history"></i> Load History
                            </button>
                        </div>
                        <div id="cgpaHistory" class="history-grid">
                            <div class="empty-state">
                                <i class="fas fa-calculator empty-icon"></i>
                                <p>Click "Load History" to see your CGPA calculations</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-section">
                        <div class="section-header">
                            <h3><i class="fas fa-book-open"></i> Attendance Records</h3>
                        </div>
                        <div id="attendanceHistory" class="history-grid">
                            <div class="empty-state">
                                <i class="fas fa-book-open empty-icon"></i>
                                <p>Your attendance records will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timetable Tab -->
            <div id="timetable" class="tab-pane">
                <div class="timetable-container">
                    <!-- Timetable Header -->
                    <div class="timetable-header">
                        <div class="timetable-header-content">
                            <div class="timetable-header-left">
                                <div class="header-info">
                                    <h1 class="page-title">📅 My Timetable</h1>
                                    <p class="page-subtitle">{{ session.student_name or session.username }}</p>
                                </div>
                            </div>
                            <div class="timetable-header-right">
                                <!-- Timetable Type Toggle -->
                                <div class="timetable-toggle">
                                    <button class="toggle-btn active" id="normalTimetableBtn" onclick="switchTimetableType('normal')" type="button">
                                        <i class="fas fa-calendar-week"></i> Normal
                                    </button>
                                    <button class="toggle-btn" id="examTimetableBtn" onclick="switchTimetableType('exam')" type="button">
                                        <i class="fas fa-graduation-cap"></i> Exam
                                    </button>
                                </div>
                                <button class="add-btn" onclick="openAddModal()" type="button" id="addTimetableBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>


                    </div>

                    <!-- Day Navigation -->
                    <div class="day-navigation">
                        <button class="nav-btn prev-btn" onclick="changeDay(-1)" type="button">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="day-info">
                            <div class="day-name" id="currentDay">Monday</div>
                            <div class="day-date" id="currentDate">11 July</div>
                        </div>
                        
                        <button class="nav-btn next-btn" onclick="changeDay(1)" type="button">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Timetable Content -->
                    <div class="timetable-content">
                        <div id="scheduleContainer" class="schedule-container">
                            <!-- Schedule items will be loaded here -->
                            <div class="empty-schedule">
                                <i class="fas fa-calendar-plus empty-icon"></i>
                                <p>No classes scheduled for this day</p>
                                <button class="btn btn-primary" onclick="openAddModal()" type="button">
                                    <i class="fas fa-plus"></i> Add Class
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Tracker Tab -->
            <div id="expenses" class="tab-pane">
                <div class="expense-tracker-container">
                    <!-- Expense Tracker Header -->
                    <div class="expense-header">
                        <h2><i class="fas fa-wallet"></i> Smart Expense Tracker</h2>
                        <p class="feature-description">Track your expenses, set budgets, and get alerts when you're approaching your limits!</p>
                    </div>

                    <!-- Budget Alerts Section -->
                    <div id="budgetAlertsSection" class="budget-alerts-section" style="display: none;">
                        <div class="alerts-container" id="budgetAlertsContainer">
                            <!-- Budget alerts will be populated here -->
                        </div>
                    </div>

                    <!-- Expense Stats Dashboard -->
                    <div class="expense-stats-section">
                        <div class="stats-grid">
                            <div class="stat-card total-expenses">
                                <div class="stat-icon">💰</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="totalExpensesValue">₹0</div>
                                    <div class="stat-label">Total Expenses</div>
                                </div>
                            </div>
                            <div class="stat-card monthly-expenses">
                                <div class="stat-icon">📅</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="monthlyExpensesValue">₹0</div>
                                    <div class="stat-label">This Month</div>
                                </div>
                            </div>
                            <div class="stat-card expense-count">
                                <div class="stat-icon">📊</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="expenseCountValue">0</div>
                                    <div class="stat-label">Total Entries</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Breakdown Section -->
                    <div class="budget-breakdown-section">
                        <div class="section-header">
                            <div class="section-title">
                                <h3><i class="fas fa-chart-pie"></i> Budget Breakdown</h3>
                                <p>Track your spending limits by category</p>
                            </div>
                            <div class="budget-sort-controls">
                                <label for="budgetSortBy" class="sort-label">Sort by:</label>
                                <select id="budgetSortBy" class="sort-select" onchange="sortBudgetBreakdown()">
                                    <option value="percentage">Percentage Used</option>
                                    <option value="amount">Amount Spent</option>
                                    <option value="remaining">Amount Remaining</option>
                                    <option value="category">Category Name</option>
                                </select>
                                <button class="sort-order-btn" id="sortOrderBtn" onclick="toggleSortOrder()" title="Toggle sort order">
                                    <i class="fas fa-sort-amount-down"></i>
                                </button>
                            </div>
                        </div>
                        <div class="budget-breakdown-grid" id="budgetBreakdownGrid">
                            <div class="loading-state">
                                <i class="fas fa-spinner"></i>
                                <p>Loading budget breakdown...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Add Expense Section -->
                    <div class="add-expense-section">
                        <div class="input-card">
                            <div class="card-header">
                                <h3><i class="fas fa-plus-circle"></i> Add New Expense</h3>
                                <p>Record your expenses and track your spending</p>
                            </div>
                            <div class="card-content">
                                <form id="addExpenseForm">
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="expenseAmount">Amount (₹)</label>
                                            <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00" required>
                                        </div>
                                        <div class="input-group">
                                            <label for="expenseCategory">Category</label>
                                            <select id="expenseCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="food">🍕 Food & Dining</option>
                                                <option value="transport">🚗 Transportation</option>
                                                <option value="education">📚 Education</option>
                                                <option value="entertainment">🎬 Entertainment</option>
                                                <option value="shopping">🛍️ Shopping</option>
                                                <option value="health">🏥 Health & Medical</option>
                                                <option value="bills">💡 Bills & Utilities</option>
                                                <option value="other">📦 Other</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="expenseDate">Date</label>
                                            <input type="date" id="expenseDate" required>
                                        </div>
                                        <div class="input-group full-width">
                                            <label for="expenseDescription">Description</label>
                                            <input type="text" id="expenseDescription" placeholder="What did you spend on?" required>
                                        </div>
                                    </div>
                                    <div class="button-group">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Add Expense
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="clearExpenseForm()">
                                            <i class="fas fa-eraser"></i> Clear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Management Section -->
                    <div class="budget-management-section">
                        <div class="input-card">
                            <div class="card-header">
                                <h3><i class="fas fa-target"></i> Set Monthly Budget</h3>
                                <p>Set spending limits for different categories</p>
                            </div>
                            <div class="card-content">
                                <form id="setBudgetForm">
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="budgetCategory">Category</label>
                                            <select id="budgetCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="food">🍕 Food & Dining</option>
                                                <option value="transport">🚗 Transportation</option>
                                                <option value="education">📚 Education</option>
                                                <option value="entertainment">🎬 Entertainment</option>
                                                <option value="shopping">🛍️ Shopping</option>
                                                <option value="health">🏥 Health & Medical</option>
                                                <option value="bills">💡 Bills & Utilities</option>
                                                <option value="other">📦 Other</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="budgetAmount">Monthly Limit (₹)</label>
                                            <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="0.00" required>
                                        </div>
                                        <div class="input-group">
                                            <label for="budgetMonth">Month</label>
                                            <input type="month" id="budgetMonth" required>
                                        </div>
                                    </div>
                                    <div class="button-group">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-target"></i> Set Budget
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Expense Filters -->
                    <div class="expense-filters">
                        <div class="filter-group">
                            <label for="filterCategory">Filter by Category</label>
                            <select id="filterCategory">
                                <option value="">All Categories</option>
                                <option value="food">🍕 Food & Dining</option>
                                <option value="transport">🚗 Transportation</option>
                                <option value="education">📚 Education</option>
                                <option value="entertainment">🎬 Entertainment</option>
                                <option value="shopping">🛍️ Shopping</option>
                                <option value="health">🏥 Health & Medical</option>
                                <option value="bills">💡 Bills & Utilities</option>
                                <option value="other">📦 Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterMonth">Filter by Month</label>
                            <input type="month" id="filterMonth">
                        </div>
                        <div class="filter-group">
                            <label for="filterYear">Filter by Year</label>
                            <select id="filterYear">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <button type="button" class="clear-filters-btn" onclick="clearExpenseFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>

                    <!-- Expenses Display -->
                    <div class="expenses-display-section">
                        <div class="section-header">
                            <h3><i class="fas fa-list"></i> Your Expenses</h3>
                            <div class="header-actions">
                                <div class="storage-status" id="expenseStorageStatus">
                                    <i class="fas fa-cloud"></i> Firebase
                                </div>
                            </div>
                        </div>

                        <!-- Pie Chart Container (shown when All Categories selected) -->
                        <div class="expense-chart-container" id="expenseChartContainer" style="display: none;">
                            <div class="chart-content">
                                <div class="chart-wrapper">
                                    <canvas id="expensePieChart" width="400" height="400"></canvas>
                                </div>
                                <div class="chart-legend" id="chartLegend"></div>
                            </div>
                        </div>

                        <!-- Expenses Grid (shown when specific category selected) -->
                        <div class="expenses-grid" id="expensesGrid">
                            <div class="loading-state" id="expensesLoading">
                                <i class="fas fa-spinner"></i>
                                <p>Loading your expenses...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Direct Messages Tab -->
            <div id="direct-messages" class="tab-pane">
                <div class="chat-container">
                    <div class="section-header">
                        <h3><i class="fas fa-comment"></i> Direct Messages</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" type="button" onclick="openNewMessageModal()">
                                <i class="fas fa-plus"></i> New Message
                            </button>
                        </div>
                    </div>

                    <div class="chat-content">
                        <div class="empty-state">
                            <div class="empty-icon">💬</div>
                            <h3>No Direct Messages</h3>
                            <p>Start a conversation with your classmates and teachers!</p>
                            <button class="btn btn-primary" type="button" onclick="openNewMessageModal()">
                                <i class="fas fa-plus"></i> Start New Chat
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Tab -->
            <div id="team" class="tab-pane">
                <div class="chat-container">
                    <div class="section-header">
                        <h3><i class="fas fa-users"></i> Team</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" type="button" onclick="showCreateTeamModal()">
                                <i class="fas fa-plus"></i> Create Team
                            </button>
                        </div>
                    </div>

                    <div class="chat-content" id="teamContent">
                        <div class="empty-state" id="teamEmptyState">
                            <div class="empty-icon">👥</div>
                            <h3>No Teams</h3>
                            <p>Create or join teams to collaborate with your study groups!</p>
                            <button class="btn btn-primary" type="button" onclick="showCreateTeamModal()">
                                <i class="fas fa-plus"></i> Create Team
                            </button>
                        </div>

                        <div id="teamsList" style="display: none;">
                            <!-- Teams will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Team Invitations Section -->
                <div class="chat-container" id="teamInvitationsContainer" style="display: none;">
                    <div class="section-header">
                        <h3><i class="fas fa-envelope"></i> Team Invitations</h3>
                    </div>
                    <div class="chat-content" id="teamInvitationsContent">
                        <!-- Team invitations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="requests" class="tab-pane">
                <div class="chat-container">
                    <div class="section-header">
                        <h3><i class="fas fa-user-plus"></i> Friend Requests</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" type="button" onclick="openAddFriendModal()">
                                <i class="fas fa-search"></i> Find Friends
                            </button>
                        </div>
                    </div>

                    <!-- Search Section -->
                    <div class="friend-search-section">
                        <div class="search-container">
                            <div class="search-input-group">
                                <input type="text" id="friendSearchInput" placeholder="Enter username to search..." class="search-input">
                                <button type="button" class="search-btn" onclick="searchFriend()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="search-results"></div>
                    </div>

                    <!-- Requests Sections -->
                    <div class="requests-content">
                        <!-- Sent Requests (Pending) -->
                        <div class="requests-section">
                            <div class="section-title">
                                <h4><i class="fas fa-clock"></i> Sent Requests</h4>
                                <span class="count-badge" id="sentRequestsCount">0</span>
                            </div>
                            <div id="sentRequestsList" class="requests-list">
                                <div class="empty-state-small">
                                    <p>No pending requests</p>
                                </div>
                            </div>
                        </div>

                        <!-- Received Requests -->
                        <div class="requests-section">
                            <div class="section-title">
                                <h4><i class="fas fa-inbox"></i> Received Requests</h4>
                                <span class="count-badge" id="receivedRequestsCount">0</span>
                            </div>
                            <div id="receivedRequestsList" class="requests-list">
                                <div class="empty-state-small">
                                    <p>No incoming requests</p>
                                </div>
                            </div>
                        </div>

                        <!-- Friends List -->
                        <div class="requests-section">
                            <div class="section-title">
                                <h4><i class="fas fa-users"></i> Friends</h4>
                                <span class="count-badge" id="friendsCount">0</span>
                            </div>
                            <div id="friendsList" class="requests-list">
                                <div class="empty-state-small">
                                    <p>No friends yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Class</h3>
                <button class="modal-close" onclick="closeAddModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="classForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startTime">Start Time</label>
                            <input type="time" id="startTime" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time</label>
                            <input type="time" id="endTime" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectNameModal">Subject Name</label>
                        <input type="text" id="subjectNameModal" placeholder="e.g., Mathematics" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherName">Teacher Name</label>
                        <input type="text" id="teacherName" placeholder="e.g., Dr. Smith">
                    </div>
                    
                    <div class="form-group">
                        <label for="roomNumber">Room/Location</label>
                        <input type="text" id="roomNumber" placeholder="e.g., Room 101">
                    </div>
                    
                    <div class="form-group">
                        <label for="classType">Class Type</label>
                        <select id="classType">
                            <option value="lecture">Lecture</option>
                            <option value="lab">Lab</option>
                            <option value="tutorial">Tutorial</option>
                            <option value="seminar">Seminar</option>
                            <option value="practical">Practical</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeAddModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Class
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Exam Modal -->
    <div id="examModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="examModalTitle">Add New Exam</h3>
                <button class="modal-close" onclick="closeExamModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="examForm">
                    <div class="form-group">
                        <label for="examSubject">Subject</label>
                        <input type="text" id="examSubject" name="subject" required placeholder="Enter subject name">
                    </div>

                    <div class="form-group">
                        <label for="examDate">Exam Date</label>
                        <input type="date" id="examDate" name="date" required>
                    </div>

                    <div class="form-group">
                        <label for="examDay">Day</label>
                        <select id="examDay" name="day" required>
                            <option value="">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="examTime">Time</label>
                        <input type="time" id="examTime" name="time" required>
                    </div>

                    <div class="form-group">
                        <label for="examSession">Session</label>
                        <select id="examSession" name="session" required>
                            <option value="">Select Session</option>
                            <option value="FN">Forenoon (FN)</option>
                            <option value="AN">Afternoon (AN)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="examLocation">Location (Optional)</label>
                        <input type="text" id="examLocation" name="location" placeholder="Exam hall/room">
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeExamModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Exam
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Reminder Modal -->
    <div id="editReminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Reminder</h3>
                <button class="modal-close" onclick="closeEditReminderModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editReminderForm">
                    <div class="form-group">
                        <label for="editReminderTitle">Title *</label>
                        <input type="text" id="editReminderTitle" placeholder="e.g., Data Structures Assignment" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editReminderType">Type</label>
                            <select id="editReminderType">
                                <option value="assignment">📝 Assignment</option>
                                <option value="exam">📚 Exam</option>
                                <option value="project">🎯 Project</option>
                                <option value="lab">🧪 Lab</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editReminderDate">Due Date</label>
                            <input type="date" id="editReminderDate">
                        </div>
                        <div class="form-group">
                            <label for="editReminderTime">⏰ Time (Optional)</label>
                            <div class="time-input-container">
                                <select id="editReminderTimeHour" class="time-select">
                                    <option value="">Hr</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <span class="time-separator">:</span>
                                <select id="editReminderTimeMinute" class="time-select">
                                    <option value="">Min</option>
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                    <option value="59">59</option>
                                </select>
                                <select id="editReminderTimeAmPm" class="time-select">
                                    <option value="">AM/PM</option>
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                            <input type="hidden" id="editReminderTime">
                            <small class="input-help">Leave empty for default time</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editReminderDescription">Description</label>
                        <textarea id="editReminderDescription" placeholder="Additional details about the reminder..." rows="4"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeEditReminderModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Update Reminder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addEventModalLabel">📅 Add Calendar Event</h3>
                <button class="modal-close" onclick="closeAddEventModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" placeholder="e.g., Team Meeting" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventTime">Time (Optional)</label>
                            <input type="time" id="eventTime">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventType">Type</label>
                            <select id="eventType">
                                <option value="personal">Personal</option>
                                <option value="work">Work</option>
                                <option value="academic">Academic</option>
                                <option value="meeting">Meeting</option>
                                <option value="reminder">Reminder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventColor">Color</label>
                            <select id="eventColor">
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="purple">Purple</option>
                                <option value="orange">Orange</option>
                                <option value="pink">Pink</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="eventDescription">Description (Optional)</label>
                        <textarea id="eventDescription" rows="3" placeholder="Event details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddEventModal()" class="btn btn-secondary" type="button">Cancel</button>
                <button onclick="saveEvent()" class="btn btn-primary" type="button">
                    <i class="fas fa-save"></i> Save Event
                </button>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flashMessages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                        <button onclick="this.parentElement.remove()" class="flash-close" type="button">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- CGPA Analysis Modal -->
    <div id="cgpaAnalysisModal" class="modal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="cgpaAnalysisModalLabel">📊 CGPA Analysis & Trends</h3>
                <button class="modal-close" onclick="closeCGPAAnalysisModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- CGPA Summary Cards -->
                <div class="cgpa-summary-cards">
                    <div class="summary-card primary">
                        <div class="summary-icon">🎯</div>
                        <div class="summary-content">
                            <div class="summary-value" id="analysisCGPA">-</div>
                            <div class="summary-label">Overall CGPA</div>
                            <div class="summary-scale" id="analysisScale">10.0 Scale</div>
                        </div>
                    </div>
                    <div class="summary-card success">
                        <div class="summary-icon">📚</div>
                        <div class="summary-content">
                            <div class="summary-value" id="analysisTotalCredits">-</div>
                            <div class="summary-label">Total Credits</div>
                            <div class="summary-scale" id="analysisSemesters">- Semesters</div>
                        </div>
                    </div>
                    <div class="summary-card info">
                        <div class="summary-icon">📈</div>
                        <div class="summary-content">
                            <div class="summary-value" id="analysisAvgSGPA">-</div>
                            <div class="summary-label">Average SGPA</div>
                            <div class="summary-scale" id="analysisGradePoints">- Grade Points</div>
                        </div>
                    </div>
                </div>

                <!-- Scale Conversions -->
                <div class="scale-conversions">
                    <h6><i class="fas fa-exchange-alt"></i> Scale Conversions</h6>
                    <div class="conversion-cards">
                        <div class="conversion-card">
                            <div class="conversion-value" id="analysis4Scale">-</div>
                            <div class="conversion-label">4.0 Scale (US)</div>
                            <div class="conversion-formula">Formula: (CGPA - 5) × 4 / 5</div>
                        </div>
                        <div class="conversion-card">
                            <div class="conversion-value" id="analysis5Scale">-</div>
                            <div class="conversion-label">5.0 Scale</div>
                            <div class="conversion-formula">Formula: CGPA / 2</div>
                        </div>
                        <div class="conversion-card">
                            <div class="conversion-value" id="analysisPercentage">-</div>
                            <div class="conversion-label">Percentage</div>
                            <div class="conversion-formula">Formula: (CGPA - 0.5) × 10</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h6><i class="fas fa-chart-bar"></i> SGPA vs Credits by Semester</h6>
                        <canvas id="sgpaCreditsChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h6><i class="fas fa-chart-line"></i> SGPA Trend Over Semesters</h6>
                        <canvas id="sgpaTrendChart" width="400" height="200"></canvas>
                        <div class="chart-legend" style="margin-top: 15px; text-align: center; font-size: 0.85rem;">
                            <div style="margin-bottom: 10px; font-weight: bold; color: #2d3436;">Performance Gradient</div>

                            <!-- Gradient Bar -->
                            <div style="margin: 10px auto; width: 200px; height: 8px; border-radius: 4px; background: linear-gradient(to right, #e74c3c 0%, #e7a53c 33%, #ffff96 66%, #00b894 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>

                            <!-- Labels -->
                            <div style="display: flex; justify-content: space-between; width: 200px; margin: 5px auto; font-size: 0.75rem;">
                                <span style="color: #e74c3c; font-weight: bold;">Low</span>
                                <span style="color: #00b894; font-weight: bold;">High</span>
                            </div>

                            <!-- Performance Categories -->
                            <div style="display: flex; justify-content: center; align-items: center; gap: 12px; flex-wrap: wrap; margin-top: 10px;">
                                <span style="color: #e74c3c; font-size: 0.8rem;">● Needs Improvement</span>
                                <span style="color: #e7a53c; font-size: 0.8rem;">● Below Average</span>
                                <span style="color: #d4b000; font-size: 0.8rem; font-weight: bold;">● Good</span>
                                <span style="color: #00b894; font-size: 0.8rem;">● Excellent</span>
                            </div>

                            <div style="margin-top: 8px; font-size: 0.7rem; color: #636e72; font-style: italic;">
                                Colors automatically adjust based on your SGPA range
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Semester Details Table -->
                <div class="semester-details">
                    <div class="semester-header">
                        <h6><i class="fas fa-table"></i> Semester-wise Breakdown</h6>
                        <button type="button" class="btn btn-success btn-sm" onclick="openAddSemesterModal()">
                            <i class="fas fa-plus"></i> Add New Semester
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Semester</th>
                                    <th>SGPA</th>
                                    <th>Credits</th>
                                    <th>Grade Points</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="semesterDetailsTable">
                                <!-- Semester data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeCGPAAnalysisModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportCGPAAnalysis()">
                    <i class="fas fa-download"></i> Export Analysis
                </button>
            </div>
        </div>
    </div>

    <!-- Add New Semester Modal -->
    <div id="addSemesterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addSemesterModalLabel">📚 Add New Semester Result</h3>
                <button class="modal-close" onclick="closeAddSemesterModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addSemesterForm">
                    <div class="form-group">
                        <label for="newSemesterName">Semester Name</label>
                        <input type="text" id="newSemesterName" placeholder="e.g., Semester 5" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newSemesterSGPA">SGPA</label>
                            <input type="number" id="newSemesterSGPA" step="0.01" min="0" max="10" placeholder="e.g., 8.5" required>
                        </div>
                        <div class="form-group">
                            <label for="newSemesterCredits">Credits</label>
                            <input type="number" id="newSemesterCredits" step="1" min="1" placeholder="e.g., 20" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newSemesterScale">Scale</label>
                        <select id="newSemesterScale">
                            <option value="10">10.0 Scale</option>
                            <option value="5">5.0 Scale</option>
                            <option value="4">4.0 Scale</option>
                        </select>
                    </div>

                    <div class="semester-preview" id="semesterPreview" style="display: none;">
                        <h6>Preview:</h6>
                        <div class="preview-card">
                            <div class="preview-item">
                                <span class="preview-label">Semester:</span>
                                <span class="preview-value" id="previewSemester">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">SGPA:</span>
                                <span class="preview-value" id="previewSGPA">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">Credits:</span>
                                <span class="preview-value" id="previewCredits">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">Grade Points:</span>
                                <span class="preview-value" id="previewGradePoints">-</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAddSemesterModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewSemester()">
                    <i class="fas fa-plus"></i> Add Semester
                </button>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💬 New Message</h3>
                <button class="modal-close" onclick="closeNewMessageModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newMessageForm">
                    <div class="form-group">
                        <label for="messageRecipient">Send to:</label>
                        <select id="messageRecipient" required>
                            <option value="">Select a friend...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="messageSubject">Subject (optional):</label>
                        <input type="text" id="messageSubject" placeholder="e.g., Study Group Meeting">
                    </div>

                    <div class="form-group">
                        <label for="messageContent">Message:</label>
                        <textarea id="messageContent" rows="6" placeholder="Type your message here..." required></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeNewMessageModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👥 Create New Team</h3>
                <button class="modal-close" onclick="closeCreateTeamModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createTeamForm">
                    <div class="form-group">
                        <label for="teamName">Team Name *</label>
                        <input type="text" id="teamName" placeholder="e.g., Study Group Alpha" required>
                    </div>

                    <div class="form-group">
                        <label for="teamDescription">Description</label>
                        <textarea id="teamDescription" placeholder="Brief description of your team's purpose..." rows="3"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeCreateTeamModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-users"></i> Create Team
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Invitation Modal -->
    <div id="teamInvitationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📧 Invite Friends to Team</h3>
                <button class="modal-close" onclick="closeTeamInvitationModal()" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Team: <span id="inviteTeamName" style="font-weight: 600; color: #667eea;"></span></label>
                </div>

                <div class="form-group">
                    <label>Select Friends to Invite:</label>
                    <div id="friendsInviteList" class="friends-invite-container">
                        <!-- Friends list will be loaded here -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeTeamInvitationModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendTeamInvitations()">
                        <i class="fas fa-paper-plane"></i> Send Invitations
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Expense Tracker JavaScript -->
    <script>
        // Expense Tracker Variables
        let expenses = [];
        let budgets = {};
        let currentExpenseId = null;
        let budgetSortBy = 'percentage';
        let budgetSortOrder = 'desc'; // 'asc' or 'desc'
        let cachedBudgetBreakdown = null;

        // Save Current Tab State
        function saveCurrentTabState() {
            const activeTab = document.querySelector('.nav-btn.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                localStorage.setItem('currentTab', tabId);
                console.log('Saved current tab:', tabId);
            }
        }

        // Restore Tab State
        function restoreTabState() {
            // Always start with the default tab for new sessions
            if (sessionStorage.getItem('sessionInitialized') !== 'true') {
                console.log('New session detected, starting with default tab');
                sessionStorage.setItem('sessionInitialized', 'true');
                switchTab('reminders'); // Default tab
                return;
            }

            // Only restore tab state for the same session
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                console.log('Restoring tab:', savedTab);

                // Find and activate the saved tab
                const tabButton = document.querySelector(`[data-tab="${savedTab}"]`);
                if (tabButton) {
                    // Use the switchTab function to properly switch
                    switchTab(savedTab);
                    console.log('Tab restored to:', savedTab);
                } else {
                    console.log('Tab button not found for:', savedTab);
                    switchTab('reminders'); // Default to reminders if tab not found
                }
            } else {
                console.log('No saved tab found, using default');
                switchTab('reminders'); // Default tab
            }
        }

        // Clear user session data on logout
        function clearUserSession() {
            console.log('Clearing user session data');
            localStorage.removeItem('currentTab');
            sessionStorage.removeItem('sessionInitialized');

            // Clear other user-specific data
            localStorage.removeItem('smart_reminders_backup');
            localStorage.removeItem('timetable_backup');
            localStorage.removeItem('last_sync_timestamp');
            localStorage.removeItem('expenses_filter');
            localStorage.removeItem('expenses_year');

            // We keep theme preference as it's device-specific, not user-specific
            console.log('User session data cleared');
        }

        // Auto-save tab state when tabs change
        function setupTabStatePersistence() {
            const tabButtons = document.querySelectorAll('[data-tab]');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Save state after a short delay to ensure tab has switched
                    setTimeout(() => {
                        saveCurrentTabState();
                    }, 100);
                });
            });
        }

        // Initialize expense tracker when tab is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set current username for team management
            currentUsername = '{{ session.username }}';

            // Debug session data
            console.log('DEBUG Session Data:', {
                username: '{{ session.username }}',
                student_name: '{{ session.student_name }}',
                email: '{{ session.email }}',
                created_at: '{{ session.created_at }}',
                created_at_length: '{{ session.created_at|length }}'
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('expenseDate')) {
                document.getElementById('expenseDate').value = today;
            }

            // Set default budget month to current month
            const currentMonth = new Date().toISOString().slice(0, 7);
            if (document.getElementById('budgetMonth')) {
                document.getElementById('budgetMonth').value = currentMonth;
            }
            if (document.getElementById('filterMonth')) {
                document.getElementById('filterMonth').value = currentMonth;
            }

            // Add event listeners
            if (document.getElementById('addExpenseForm')) {
                document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpense);
            }
            if (document.getElementById('setBudgetForm')) {
                document.getElementById('setBudgetForm').addEventListener('submit', handleSetBudget);
            }
            if (document.getElementById('filterCategory')) {
                document.getElementById('filterCategory').addEventListener('change', filterExpenses);
            }
            if (document.getElementById('filterMonth')) {
                document.getElementById('filterMonth').addEventListener('change', filterExpenses);
            }
            if (document.getElementById('filterYear')) {
                document.getElementById('filterYear').addEventListener('change', filterExpenses);
            }

            // Setup tab state persistence
            setupTabStatePersistence();

            // Initialize sidebar navigation after a short delay to ensure DOM is ready
            setTimeout(() => {
                updateSidebarNavigation();

                // Check if this is a new login session
                const isNewLogin = !sessionStorage.getItem('sessionInitialized');
                if (isNewLogin) {
                    console.log('New login detected, initializing session');
                    sessionStorage.setItem('sessionInitialized', 'true');
                    // Always start with the default tab for new logins
                    switchTab('reminders');
                } else {
                    // Restore the last active tab only for existing sessions
                    restoreTabState();
                }
            }, 500);

            // Load data when expenses tab is activated
            const expensesTab = document.querySelector('[data-tab="expenses"]');
            if (expensesTab) {
                expensesTab.addEventListener('click', function() {
                    setTimeout(() => {
                        loadExpenses();
                        loadBudgets();
                        updateExpenseStats();
                        displayBudgetBreakdown();
                    }, 100);
                });
            }
        });

        // Update Sidebar Navigation
        function updateSidebarNavigation() {
            // User info is already populated from server-side template
            // Just update sidebar active states when tabs change
            updateSidebarActiveState();
        }

        // Function to update sidebar active states
        function updateSidebarActiveState() {
            // Find the currently active tab pane
            const activePane = document.querySelector('.tab-pane.active');
            if (activePane) {
                const activeTabId = activePane.id;

                // Remove active class from all sidebar nav buttons
                document.querySelectorAll('.nav-btn[data-tab]').forEach(btn => btn.classList.remove('active'));

                // Add active class to the corresponding sidebar button
                const activeButton = document.querySelector(`.nav-btn[data-tab="${activeTabId}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }

        // Add Expense Function
        async function handleAddExpense(e) {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;

            if (!amount || !category || !date || !description) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        category: category,
                        date: date,
                        description: description
                    })
                });

                const result = await response.json();

                if (result.success) {
                    clearExpenseForm();
                    await loadExpenses();
                    await updateExpenseStats();
                    await refreshExpenseDisplay(); // Refresh pie chart or grid
                    await displayBudgetBreakdown(); // Update budget breakdown
                    showNotification('Expense added successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to add expense', 'error');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                showNotification('Error adding expense', 'error');
            }
        }

        // Set Budget Function
        async function handleSetBudget(e) {
            e.preventDefault();

            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            const month = document.getElementById('budgetMonth').value;

            if (!category || !amount || !month) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/api/budgets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category,
                        amount: amount,
                        month: month
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('setBudgetForm').reset();
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    document.getElementById('budgetMonth').value = currentMonth;

                    // Refresh all budget-related data with proper sequencing
                    await refreshBudgetData();

                    // Also refresh the expense display (pie chart or grid)
                    await refreshExpenseDisplay();

                    // Additional fallback: Force refresh budget breakdown after a short delay
                    setTimeout(async () => {
                        console.log('Fallback budget breakdown refresh...');
                        await displayBudgetBreakdown();
                        await refreshExpenseDisplay();
                    }, 1000);

                    showNotification('Budget set successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to set budget', 'error');
                }
            } catch (error) {
                console.error('Error setting budget:', error);
                showNotification('Error setting budget', 'error');
            }
        }

        // Load Expenses
        async function loadExpenses() {
            try {
                const response = await fetch('/api/expenses');
                const result = await response.json();

                if (result.expenses) {
                    expenses = result.expenses;
                    populateYearFilter();
                    displayExpenses(expenses);
                    updateStorageStatus('online');
                } else {
                    showNotification(result.error || 'Failed to load expenses', 'error');
                    updateStorageStatus('error');
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
                updateStorageStatus('error');
            }
        }

        // Populate Year Filter
        function populateYearFilter() {
            const yearFilter = document.getElementById('filterYear');
            if (!yearFilter) return;

            const years = [...new Set(expenses.map(expense => new Date(expense.date).getFullYear()))].sort((a, b) => b - a);

            // Clear existing options except "All Years"
            yearFilter.innerHTML = '<option value="">All Years</option>';

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        // Load Budgets
        async function loadBudgets() {
            try {
                const response = await fetch('/api/budgets');
                const result = await response.json();

                if (result.budgets) {
                    budgets = result.budgets;
                }
            } catch (error) {
                console.error('Error loading budgets:', error);
            }
        }

        // Refresh Budget Data (comprehensive refresh after budget changes)
        async function refreshBudgetData() {
            try {
                console.log('Starting budget data refresh...');

                // Load budgets first
                await loadBudgets();
                console.log('Budgets loaded');

                // Longer delay to ensure Firebase data is fully saved and propagated
                await new Promise(resolve => setTimeout(resolve, 300));
                console.log('Delay completed, updating UI...');

                // Update expense stats (which includes budget remaining calculation)
                await updateExpenseStats();
                console.log('Expense stats updated');

                // Additional delay before budget breakdown
                await new Promise(resolve => setTimeout(resolve, 100));

                // Update budget breakdown display
                await displayBudgetBreakdown();
                console.log('Budget breakdown updated');

                // Double-check: if budget breakdown is still empty, try one more time
                const breakdownGrid = document.getElementById('budgetBreakdownGrid');
                if (breakdownGrid && breakdownGrid.innerHTML.includes('No budgets set')) {
                    console.log('Budget breakdown still empty, retrying...');
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await displayBudgetBreakdown();
                }

                console.log('Budget data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing budget data:', error);
            }
        }

        // Refresh Expense Display (pie chart or grid based on current filter)
        async function refreshExpenseDisplay() {
            try {
                console.log('Refreshing expense display...');

                // Reload expenses to get latest data
                await loadExpenses();

                // Check current filter state and display accordingly
                const categoryFilter = document.getElementById('filterCategory').value;

                if (!categoryFilter) {
                    // Show pie chart for "All Categories"
                    showPieChart(expenses);
                    console.log('Pie chart refreshed');
                } else {
                    // Apply current filters and show grid
                    filterExpenses();
                    console.log('Expense grid refreshed');
                }
            } catch (error) {
                console.error('Error refreshing expense display:', error);
            }
        }

        // Update Expense Stats
        async function updateExpenseStats() {
            try {
                const response = await fetch('/api/expense-stats');
                const result = await response.json();

                if (result) {
                    console.log('Expense stats received:', result); // Debug log

                    // Update stat cards
                    document.getElementById('totalExpensesValue').textContent = `₹${result.total_expenses.toFixed(2)}`;
                    document.getElementById('expenseCountValue').textContent = expenses.length;

                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const monthlyTotal = result.monthly_totals[currentMonth] || {};
                    const monthlySum = Object.values(monthlyTotal).reduce((sum, val) => sum + val, 0);
                    document.getElementById('monthlyExpensesValue').textContent = `₹${monthlySum.toFixed(2)}`;

                    const budgetRemaining = result.total_budget - monthlySum;
                    const budgetRemainingValue = Math.max(0, budgetRemaining);

                    console.log(`Budget calculation: Total Budget: ₹${result.total_budget}, Monthly Spent: ₹${monthlySum}, Remaining: ₹${budgetRemainingValue}`); // Debug log

                    document.getElementById('budgetRemainingValue').textContent = `₹${budgetRemainingValue.toFixed(2)}`;

                    // Display budget alerts
                    displayBudgetAlerts(result.alerts);
                } else {
                    console.error('No result received from expense stats API');
                }
            } catch (error) {
                console.error('Error updating expense stats:', error);
            }
        }

        // Display Budget Alerts
        function displayBudgetAlerts(alerts) {
            const alertsContainer = document.getElementById('budgetAlertsContainer');
            const alertsSection = document.getElementById('budgetAlertsSection');

            if (alerts && alerts.length > 0) {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="budget-alert ${alert.type}">
                        <i class="fas fa-${alert.type === 'danger' ? 'exclamation-triangle' : 'warning'}"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('');
                alertsSection.style.display = 'block';
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // Display Budget Breakdown
        async function displayBudgetBreakdown() {
            try {
                console.log('Fetching budget breakdown...');
                const response = await fetch('/api/budget-breakdown');
                const result = await response.json();
                console.log('Budget breakdown response:', result);

                if (result.breakdown) {
                    const breakdownGrid = document.getElementById('budgetBreakdownGrid');
                    const breakdown = result.breakdown;
                    console.log('Processing breakdown data:', breakdown);

                    if (Object.keys(breakdown).length === 0) {
                        breakdownGrid.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">🎯</div>
                                <h3>No budgets set</h3>
                                <p>Set your first budget to see the breakdown here!</p>
                            </div>
                        `;
                        return;
                    }

                    // Cache the breakdown data for sorting later
                    cachedBudgetBreakdown = breakdown;

                    // Render the breakdown with current sorting
                    renderBudgetBreakdown(breakdown);
                }
            } catch (error) {
                console.error('Error loading budget breakdown:', error);
                const breakdownGrid = document.getElementById('budgetBreakdownGrid');
                if (breakdownGrid) {
                    breakdownGrid.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">⚠️</div>
                            <h3>Error loading budget breakdown</h3>
                            <p>Please try again later</p>
                        </div>
                    `;
                }
            }
        }

        // Sort budget data based on current sorting preferences
        function sortBudgetData(breakdown) {
            const breakdownArray = Object.entries(breakdown)
                .map(([category, data]) => {
                    const percentage = data.limit > 0 ? (data.spent / data.limit) * 100 : 0;
                    const remaining = Math.max(0, data.limit - data.spent);
                    return { category, data, percentage, remaining };
                });

            // Sort based on current criteria
            breakdownArray.sort((a, b) => {
                let comparison = 0;

                switch (budgetSortBy) {
                    case 'percentage':
                        comparison = a.percentage - b.percentage;
                        break;
                    case 'amount':
                        comparison = a.data.spent - b.data.spent;
                        break;
                    case 'remaining':
                        comparison = a.remaining - b.remaining;
                        break;
                    case 'category':
                        comparison = a.category.localeCompare(b.category);
                        break;
                    default:
                        comparison = a.percentage - b.percentage;
                }

                return budgetSortOrder === 'desc' ? -comparison : comparison;
            });

            return breakdownArray;
        }

        // Sort budget breakdown based on dropdown selection
        function sortBudgetBreakdown() {
            const sortSelect = document.getElementById('budgetSortBy');
            budgetSortBy = sortSelect.value;

            if (cachedBudgetBreakdown) {
                renderBudgetBreakdown(cachedBudgetBreakdown);
            }
        }

        // Toggle sort order (ascending/descending)
        function toggleSortOrder() {
            budgetSortOrder = budgetSortOrder === 'desc' ? 'asc' : 'desc';

            const sortOrderBtn = document.getElementById('sortOrderBtn');
            const icon = sortOrderBtn.querySelector('i');

            if (budgetSortOrder === 'desc') {
                icon.className = 'fas fa-sort-amount-down';
                sortOrderBtn.title = 'Sorted: High to Low';
            } else {
                icon.className = 'fas fa-sort-amount-up';
                sortOrderBtn.title = 'Sorted: Low to High';
            }

            if (cachedBudgetBreakdown) {
                renderBudgetBreakdown(cachedBudgetBreakdown);
            }
        }

        // Render budget breakdown with current sorting
        function renderBudgetBreakdown(breakdown) {
            const breakdownGrid = document.getElementById('budgetBreakdownGrid');
            const sortedBreakdown = sortBudgetData(breakdown);

            breakdownGrid.innerHTML = sortedBreakdown.map(({ category, data, percentage, remaining }, index) => {
                let status = 'safe';
                let statusText = 'On Track';

                if (percentage >= 100) {
                    status = 'danger';
                    statusText = 'Over Budget';
                } else if (percentage >= 80) {
                    status = 'warning';
                    statusText = 'Near Limit';
                }

                const categoryIcon = getCategoryIcon(category);

                return `
                    <div class="budget-breakdown-card">
                        <div class="budget-card-header">
                            <div class="budget-category">
                                ${categoryIcon} ${category.charAt(0).toUpperCase() + category.slice(1)}
                            </div>
                            <div class="budget-status ${status}">${statusText}</div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar">
                                <div class="budget-progress-fill ${status}" style="width: ${Math.min(100, percentage)}%"></div>
                            </div>
                        </div>
                        <div class="budget-amounts">
                            <div class="budget-spent">Spent: ₹${data.spent.toFixed(2)}</div>
                            <div class="budget-limit">Limit: ₹${data.limit.toFixed(2)}</div>
                        </div>
                        <div class="budget-amounts">
                            <div class="budget-remaining" style="color: ${remaining > 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                Remaining: ₹${remaining.toFixed(2)}
                            </div>
                            <div class="percentage-used">
                                ${percentage.toFixed(1)}% used
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display Expenses
        function displayExpenses(expensesToShow) {
            const categoryFilter = document.getElementById('filterCategory').value;

            // If no category filter, show pie chart; otherwise show grid
            if (!categoryFilter) {
                showPieChart(expensesToShow || expenses);
                return;
            }

            const expensesGrid = document.getElementById('expensesGrid');
            const chartContainer = document.getElementById('expenseChartContainer');

            // Show grid, hide chart
            if (chartContainer) chartContainer.style.display = 'none';
            if (expensesGrid) expensesGrid.style.display = 'grid';

            if (!expensesToShow || expensesToShow.length === 0) {
                expensesGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💰</div>
                        <h3>No expenses found</h3>
                        <p>Start tracking your expenses by adding your first entry above!</p>
                    </div>
                `;
                return;
            }

            // Sort expenses by date (newest first)
            const sortedExpenses = expensesToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            expensesGrid.innerHTML = sortedExpenses.map(expense => {
                const date = new Date(expense.date).toLocaleDateString();
                const categoryIcon = getCategoryIcon(expense.category);

                return `
                    <div class="expense-item ${expense.category}">
                        <div class="expense-header-row">
                            <div class="expense-amount">₹${expense.amount.toFixed(2)}</div>
                            <div class="expense-category-badge ${expense.category}">
                                ${categoryIcon} ${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}
                            </div>
                        </div>
                        <div class="expense-description">${expense.description}</div>
                        <div class="expense-footer">
                            <div class="expense-date">
                                <i class="fas fa-calendar"></i> ${date}
                            </div>
                            <div class="expense-actions">
                                <button class="expense-action-btn" onclick="editExpense('${expense.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="expense-action-btn delete" onclick="deleteExpense('${expense.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get Category Icon
        function getCategoryIcon(category) {
            const icons = {
                food: '🍕',
                transport: '🚗',
                education: '📚',
                entertainment: '🎬',
                shopping: '🛍️',
                health: '🏥',
                bills: '💡',
                other: '📦'
            };
            return icons[category] || '📦';
        }

        // Filter Expenses
        function filterExpenses() {
            const categoryFilter = document.getElementById('filterCategory').value;
            const monthFilter = document.getElementById('filterMonth').value;
            const yearFilter = document.getElementById('filterYear').value;

            let filteredExpenses = expenses;

            if (categoryFilter) {
                filteredExpenses = filteredExpenses.filter(expense => expense.category === categoryFilter);
            }

            if (monthFilter) {
                filteredExpenses = filteredExpenses.filter(expense => {
                    const expenseMonth = expense.date.slice(0, 7);
                    return expenseMonth === monthFilter;
                });
            }

            if (yearFilter) {
                filteredExpenses = filteredExpenses.filter(expense => {
                    const expenseYear = new Date(expense.date).getFullYear().toString();
                    return expenseYear === yearFilter;
                });
            }

            // Show pie chart if "All Categories" is selected, otherwise show grid
            if (!categoryFilter) {
                showPieChart(filteredExpenses);
            } else {
                showExpenseGrid(filteredExpenses);
            }
        }

        // Clear Expense Filters
        function clearExpenseFilters() {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            showPieChart(expenses); // Show pie chart when all filters are cleared
        }

        // Clear Expense Form
        function clearExpenseForm() {
            document.getElementById('addExpenseForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }

        // Show Pie Chart
        function showPieChart(expenseData) {
            const chartContainer = document.getElementById('expenseChartContainer');
            const gridContainer = document.getElementById('expensesGrid');

            if (!chartContainer || !gridContainer) return;

            // Hide grid, show chart
            gridContainer.style.display = 'none';
            chartContainer.style.display = 'block';

            // Calculate category totals
            const categoryTotals = {};
            expenseData.forEach(expense => {
                const category = expense.category;
                categoryTotals[category] = (categoryTotals[category] || 0) + parseFloat(expense.amount);
            });

            // Prepare chart data
            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
            ];

            // Create or update chart
            const ctx = document.getElementById('expensePieChart').getContext('2d');

            // Destroy existing chart if it exists
            if (window.expenseChart) {
                window.expenseChart.destroy();
            }

            window.expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories.map(cat => cat.charAt(0).toUpperCase() + cat.slice(1)),
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false // We'll create custom legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = amounts.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ₹${context.parsed.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Create custom legend
            createChartLegend(categories, amounts, colors);
        }

        // Create Chart Legend
        function createChartLegend(categories, amounts, colors) {
            const legendContainer = document.getElementById('chartLegend');
            if (!legendContainer) return;

            const total = amounts.reduce((a, b) => a + b, 0);

            legendContainer.innerHTML = categories.map((category, index) => {
                const percentage = ((amounts[index] / total) * 100).toFixed(1);
                const icon = getCategoryIcon(category);

                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[index]}"></div>
                        <div class="legend-details">
                            <div class="legend-text">${icon} ${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            <div class="legend-amount">₹${amounts[index].toFixed(2)}</div>
                            <div class="legend-percentage">${percentage}% of total</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show Expense Grid
        function showExpenseGrid(expenseData) {
            const chartContainer = document.getElementById('expenseChartContainer');
            const gridContainer = document.getElementById('expensesGrid');

            if (!chartContainer || !gridContainer) return;

            // Hide chart, show grid
            chartContainer.style.display = 'none';
            gridContainer.style.display = 'grid';

            // Display expenses in grid format
            displayExpenses(expenseData);
        }

        // Delete Expense
        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    await loadExpenses();
                    await updateExpenseStats();
                    await refreshExpenseDisplay(); // Refresh pie chart or grid
                    await displayBudgetBreakdown(); // Update budget breakdown
                    showNotification('Expense deleted successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to delete expense', 'error');
                }
            } catch (error) {
                console.error('Error deleting expense:', error);
                showNotification('Error deleting expense', 'error');
            }
        }

        // Edit Expense (placeholder for future implementation)
        function editExpense(expenseId) {
            showNotification('Edit functionality coming soon!', 'info');
        }

        // Update Storage Status
        function updateStorageStatus(status) {
            const statusElement = document.getElementById('expenseStorageStatus');
            if (statusElement) {
                statusElement.className = `storage-status ${status}`;
                const statusText = {
                    online: 'Firebase',
                    offline: 'Offline',
                    error: 'Error'
                };
                statusElement.innerHTML = `<i class="fas fa-cloud"></i> ${statusText[status]}`;
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="notification-close">&times;</button>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Friend Request Functions
        let friendRequests = {
            sent: [],
            received: [],
            friends: []
        };

        // Search for friends by username
        async function searchFriend() {
            const searchInput = document.getElementById('friendSearchInput');
            const username = searchInput.value.trim();

            console.log('🔍 Frontend: Starting search for username:', username);

            if (!username) {
                showNotification('Please enter a username to search', 'warning');
                return;
            }

            try {
                const url = `/api/search-user?username=${encodeURIComponent(username)}`;
                console.log('🔍 Frontend: Making request to:', url);

                const response = await fetch(url);
                console.log('🔍 Frontend: Response status:', response.status);

                const result = await response.json();
                console.log('🔍 Frontend: Response data:', result);

                if (result.success && result.user) {
                    console.log('🔍 Frontend: User found, displaying result');
                    displaySearchResult(result.user);
                } else {
                    console.log('🔍 Frontend: User not found, showing error');
                    displaySearchResult(null, result.message || 'User not found');
                }
            } catch (error) {
                console.error('🔍 Frontend: Error searching for user:', error);
                showNotification('Error searching for user', 'error');
            }
        }

        // Display search result
        function displaySearchResult(user, errorMessage = null) {
            const resultsContainer = document.getElementById('searchResults');

            if (!user) {
                resultsContainer.innerHTML = `
                    <div class="user-result">
                        <div class="user-info">
                            <div class="user-avatar">❌</div>
                            <div class="user-details">
                                <h5>User not found</h5>
                                <p>${errorMessage}</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Check if already friends or request exists
            const currentUser = '{{ session.username }}';
            const isSelf = user.username === currentUser;
            const isAlreadyFriend = friendRequests.friends.some(f => f.username === user.username);
            const hasPendingRequest = friendRequests.sent.some(r => r.to_username === user.username);

            let actionButton = '';
            if (isSelf) {
                actionButton = '<span class="status-badge">That\'s you!</span>';
            } else if (isAlreadyFriend) {
                actionButton = '<span class="status-badge status-accepted">Already friends</span>';
            } else if (hasPendingRequest) {
                actionButton = '<span class="status-badge status-pending">Request sent</span>';
            } else {
                actionButton = `
                    <button class="action-btn send-btn" onclick="sendFriendRequest('${user.username}')" style="background: linear-gradient(135deg, #667eea, #764ba2) !important; color: white !important; padding: 8px 16px !important; border: none !important; border-radius: 8px !important; cursor: pointer !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important; transition: all 0.3s ease !important; font-size: 13px !important; white-space: nowrap !important; min-width: 120px !important;">
                        ➕ Send
                    </button>
                `;
            }

            console.log('🔍 DEBUG: Action button HTML:', actionButton);
            console.log('🔍 DEBUG: User data:', user);
            console.log('🔍 DEBUG: User course:', user.course);
            console.log('🔍 DEBUG: User college:', user.college);
            console.log('🔍 DEBUG: User student_name:', user.student_name);
            console.log('🔍 DEBUG: Current user:', currentUser);
            console.log('🔍 DEBUG: Is self:', isSelf);
            console.log('🔍 DEBUG: Is already friend:', isAlreadyFriend);
            console.log('🔍 DEBUG: Has pending request:', hasPendingRequest);

            resultsContainer.innerHTML = `
                <div class="user-result">
                    <div class="user-info">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <h5>${user.username}</h5>
                            <p style="color: #6c757d; font-size: 13px; margin: 2px 0; font-weight: 500;">${user.student_name || user.name || 'Student Name'}</p>
                            <p style="color: #9ca3af; font-size: 12px; margin: 0; line-height: 1.4;">
                                ${user.course || user.program || user.degree || 'Course not specified'}<br>
                                <span style="color: #adb5bd;">${(user.college || user.university || user.institution) ? ((user.college || user.university || user.institution).length > 30 ? (user.college || user.university || user.institution).substring(0, 30) + '...' : (user.college || user.university || user.institution)) : 'College not specified'}</span>
                            </p>
                        </div>
                    </div>
                    <div class="request-actions">
                        ${actionButton}
                    </div>
                </div>
            `;

            console.log('🔍 DEBUG: Final HTML:', resultsContainer.innerHTML);
        }

        // Send friend request
        async function sendFriendRequest(toUsername) {
            console.log('🚀 DEBUG: sendFriendRequest called with username:', toUsername);
            try {
                console.log('🚀 DEBUG: Making friend request API call...');
                console.log('🚀 DEBUG: About to make fetch request to /api/send-friend-request');
                const response = await fetch('/api/send-friend-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to_username: toUsername
                    })
                });
                console.log('🚀 DEBUG: Fetch response received:', response);

                const result = await response.json();

                if (result.success) {
                    showNotification('Friend request sent!', 'success');
                    loadFriendRequests(); // Refresh the requests

                    // Update search result to show "Request sent"
                    const searchInput = document.getElementById('friendSearchInput');
                    if (searchInput.value.trim() === toUsername) {
                        searchFriend(); // Re-search to update the display
                    }
                } else {
                    showNotification(result.message || 'Failed to send friend request', 'error');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Error sending friend request', 'error');
            }
        }

        // Accept friend request
        async function acceptFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friend-request/${requestId}/accept`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Friend request accepted!', 'success');
                    loadFriendRequests(); // Refresh the requests
                } else {
                    showNotification(result.message || 'Failed to accept friend request', 'error');
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
                showNotification('Error accepting friend request', 'error');
            }
        }

        // Decline friend request
        async function declineFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friend-request/${requestId}/decline`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Friend request declined', 'info');
                    loadFriendRequests(); // Refresh the requests
                } else {
                    showNotification(result.message || 'Failed to decline friend request', 'error');
                }
            } catch (error) {
                console.error('Error declining friend request:', error);
                showNotification('Error declining friend request', 'error');
            }
        }

        // Cancel sent friend request
        async function cancelFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friend-request/${requestId}/cancel`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Friend request cancelled', 'info');
                    loadFriendRequests(); // Refresh the requests
                } else {
                    showNotification(result.message || 'Failed to cancel friend request', 'error');
                }
            } catch (error) {
                console.error('Error cancelling friend request:', error);
                showNotification('Error cancelling friend request', 'error');
            }
        }

        // Load friend requests
        async function loadFriendRequests() {
            try {
                const response = await fetch('/api/friend-requests');
                const result = await response.json();

                if (result.success) {
                    friendRequests = result.data;
                    displayFriendRequests();
                } else {
                    console.error('Failed to load friend requests:', result.message);
                }
            } catch (error) {
                console.error('Error loading friend requests:', error);
            }
        }

        // Display friend requests
        function displayFriendRequests() {
            displaySentRequests();
            displayReceivedRequests();
            displayFriends();
            updateRequestCounts();
        }

        // Display sent requests
        function displaySentRequests() {
            const container = document.getElementById('sentRequestsList');
            const friendReqs = friendRequests.sent || [];
            const teamInvitations = friendRequests.sent_team_invitations || [];

            // Filter out accepted invitations - only show pending and declined
            const filteredTeamInvitations = teamInvitations.filter(invitation =>
                invitation.status === 'pending' || invitation.status === 'declined'
            );

            // Combine friend requests and filtered team invitations
            const allSentRequests = [
                ...friendReqs,
                ...filteredTeamInvitations
            ];

            if (allSentRequests.length === 0) {
                container.innerHTML = '<div class="empty-state-small"><p>No pending requests</p></div>';
                return;
            }

            // Sort by created date (newest first)
            allSentRequests.sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });

            container.innerHTML = allSentRequests.map(request => {
                if (request.type === 'team_invitation') {
                    // Team invitation
                    return `
                        <div class="request-item">
                            <div class="user-info">
                                <div class="user-avatar" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                    <i class="fas fa-users" style="font-size: 0.8rem;"></i>
                                </div>
                                <div class="user-details">
                                    <h5>Team: ${request.team_name}</h5>
                                    <p>Invited: ${request.to_name || request.to_username}</p>
                                    <p style="font-size: 0.8rem; color: #6c757d;">Sent ${new Date(request.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="request-actions">
                                ${request.status === 'declined' ?
                                    `<button class="btn btn-outline btn-sm" onclick="deleteTeamInvitation('${request.id}')" title="Delete" style="margin-right: 8px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <span class="status-badge status-declined" style="background: linear-gradient(135deg, #dc3545, #c82333) !important; color: white !important; padding: 6px 12px !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 600 !important;">
                                        ❌ Declined
                                    </span>` :
                                    `<span class="status-badge status-pending" style="background: linear-gradient(135deg, #ffc107, #fd7e14) !important; color: white !important; padding: 6px 12px !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 600 !important;">
                                        ⏳ Pending
                                    </span>`
                                }
                            </div>
                        </div>
                    `;
                } else {
                    // Friend request
                    return `
                        <div class="request-item">
                            <div class="user-info">
                                <div class="user-avatar">${request.to_username.charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h5>${request.to_username}</h5>
                                    <p>Sent ${new Date(request.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="request-actions">
                                <span class="status-badge status-pending" style="background: linear-gradient(135deg, #ffc107, #fd7e14) !important; color: white !important; padding: 6px 12px !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 600 !important; margin-right: 8px !important;">⏳ Pending</span>
                                <button class="action-btn cancel-btn" onclick="cancelFriendRequest('${request.id}')" style="background: linear-gradient(135deg, #6c757d, #495057) !important; color: white !important; padding: 8px 10px !important; border: none !important; border-radius: 6px !important; font-size: 14px !important; font-weight: 600 !important; cursor: pointer !important; min-width: 36px !important;" title="Cancel Request">
                                    ❌
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Display received requests
        function displayReceivedRequests() {
            const container = document.getElementById('receivedRequestsList');
            const friendReqs = friendRequests.received || [];
            const teamInvitations = friendRequests.received_team_invitations || [];

            // Combine friend requests and team invitations
            const allReceivedRequests = [
                ...friendReqs,
                ...teamInvitations
            ];

            if (allReceivedRequests.length === 0) {
                container.innerHTML = '<div class="empty-state-small"><p>No incoming requests</p></div>';
                return;
            }

            // Sort by created date (newest first)
            allReceivedRequests.sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });

            container.innerHTML = allReceivedRequests.map(request => {
                if (request.type === 'team_invitation') {
                    // Team invitation
                    return `
                        <div class="request-item">
                            <div class="user-info">
                                <div class="user-avatar" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                    <i class="fas fa-users" style="font-size: 0.8rem;"></i>
                                </div>
                                <div class="user-details">
                                    <h5>Team: ${request.team_name}</h5>
                                    <p style="color: #6c757d; font-size: 13px; margin: 2px 0;">From: ${request.from_name || request.from_username}</p>
                                    <p style="color: #9ca3af; font-size: 12px; margin: 0;">Received ${new Date(request.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="request-actions">
                                <button class="action-btn accept-btn" onclick="respondToTeamInvitation('${request.id}', 'accept')" style="background: linear-gradient(135deg, #28a745, #20c997) !important; color: white !important; margin-right: 10px !important; padding: 10px 12px !important; border-radius: 8px !important; border: none !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important; transition: all 0.3s ease !important; font-size: 16px !important; min-width: 44px !important;" title="Accept Team Invitation">
                                    ✅
                                </button>
                                <button class="action-btn decline-btn" onclick="respondToTeamInvitation('${request.id}', 'decline')" style="background: linear-gradient(135deg, #dc3545, #e74c3c) !important; color: white !important; padding: 10px 12px !important; border-radius: 8px !important; border: none !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important; transition: all 0.3s ease !important; font-size: 16px !important; min-width: 44px !important;" title="Decline Team Invitation">
                                    ❌
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Friend request
                    return `
                        <div class="request-item">
                            <div class="user-info">
                                <div class="user-avatar">${request.from_username.charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h5>${request.from_username}</h5>
                                    <p style="color: #6c757d; font-size: 13px; margin: 2px 0;">${request.from_student_name || 'Student'}</p>
                                    <p style="color: #9ca3af; font-size: 12px; margin: 0;">Received ${new Date(request.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="request-actions">
                                <button class="action-btn accept-btn" onclick="acceptFriendRequest('${request.id}')" style="background: linear-gradient(135deg, #28a745, #20c997) !important; color: white !important; margin-right: 10px !important; padding: 10px 12px !important; border-radius: 8px !important; border: none !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important; transition: all 0.3s ease !important; font-size: 16px !important; min-width: 44px !important;" title="Accept Request">
                                    ✅
                                </button>
                                <button class="action-btn decline-btn" onclick="declineFriendRequest('${request.id}')" style="background: linear-gradient(135deg, #dc3545, #e74c3c) !important; color: white !important; padding: 10px 12px !important; border-radius: 8px !important; border: none !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important; transition: all 0.3s ease !important; font-size: 16px !important; min-width: 44px !important;" title="Decline Request">
                                    ❌
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Display friends
        function displayFriends() {
            const container = document.getElementById('friendsList');
            const friends = friendRequests.friends || [];

            if (friends.length === 0) {
                container.innerHTML = '<div class="empty-state-small"><p>No friends yet</p></div>';
                return;
            }

            container.innerHTML = friends.map(friend => `
                <div class="request-item">
                    <div class="user-info">
                        <div class="user-avatar">${friend.username.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <h5>${friend.username}</h5>
                            <p style="color: #6c757d; font-size: 13px; margin: 2px 0;">${friend.student_name || 'Student'}</p>
                            <p style="color: #9ca3af; font-size: 12px; margin: 0;">Friends since ${new Date(friend.accepted_at || friend.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="request-actions">
                        <span class="status-badge status-accepted" style="background: linear-gradient(135deg, #28a745, #20c997) !important; color: white !important; padding: 6px 12px !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 600 !important;">✨ Friends</span>
                    </div>
                </div>
            `).join('');
        }

        // Update request counts
        function updateRequestCounts() {
            const sentCount = (friendRequests.sent || []).length + (friendRequests.sent_team_invitations || []).length;
            const receivedCount = (friendRequests.received || []).length + (friendRequests.received_team_invitations || []).length;

            document.getElementById('sentRequestsCount').textContent = sentCount;
            document.getElementById('receivedRequestsCount').textContent = receivedCount;
            document.getElementById('friendsCount').textContent = (friendRequests.friends || []).length;
        }

        // Open add friend modal (alternative to inline search)
        function openAddFriendModal() {
            const searchInput = document.getElementById('friendSearchInput');
            searchInput.focus();
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ===== MESSAGING FUNCTIONS =====

        // Global variables for messaging
        let currentConversationPartner = null;
        let lastMessageTimestamp = null;
        let messagePollingInterval = null;

        // Open new message modal
        function openNewMessageModal(preSelectedRecipient = null) {
            loadFriendsForMessaging();
            document.getElementById('newMessageModal').style.display = 'flex';

            // Pre-select recipient if provided
            if (preSelectedRecipient) {
                setTimeout(() => {
                    const recipientSelect = document.getElementById('messageRecipient');
                    if (recipientSelect) {
                        recipientSelect.value = preSelectedRecipient;
                    }
                }, 500); // Wait for friends to load
            }
        }

        // Close new message modal
        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
            document.getElementById('newMessageForm').reset();
        }

        // Load friends list for messaging
        async function loadFriendsForMessaging() {
            try {
                const response = await fetch('/api/friend-requests');
                const result = await response.json();

                if (result.success) {
                    const friends = result.data.friends || [];
                    const select = document.getElementById('messageRecipient');

                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Select a friend...</option>';

                    if (friends.length === 0) {
                        select.innerHTML = '<option value="">No friends available</option>';
                        return;
                    }

                    friends.forEach(friend => {
                        const option = document.createElement('option');
                        option.value = friend.username;
                        option.textContent = `${friend.username} (${friend.student_name || 'Student'})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load friends:', result.message);
                }
            } catch (error) {
                console.error('Error loading friends for messaging:', error);
            }
        }

        // Handle new message form submission
        document.getElementById('newMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const recipient = document.getElementById('messageRecipient').value;
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;

            if (!recipient || !content.trim()) {
                showNotification('Please select a recipient and enter a message', 'error');
                return;
            }

            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to_username: recipient,
                        subject: subject,
                        content: content.trim()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Message sent successfully!', 'success');
                    closeNewMessageModal();

                    // Check if we're currently viewing a conversation with the recipient
                    if (currentConversationPartner === recipient) {
                        // Refresh the current conversation
                        openConversation(recipient);
                    } else {
                        // Go back to conversations list
                        loadDirectMessages(true);
                    }

                    // Update messaging tab
                    updateMessagingTab();
                } else {
                    showNotification(result.message || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        });

        // Load direct messages (now conversations)
        async function loadDirectMessages(forceConversationsList = false) {
            try {
                // If we're in a conversation and not forcing conversation list, stay in that view
                if (currentConversationPartner && !forceConversationsList) {
                    openConversation(currentConversationPartner);
                    return;
                }

                // Reset current conversation partner and polling state
                currentConversationPartner = null;
                lastMessageTimestamp = null;

                const response = await fetch('/api/conversations');
                const result = await response.json();

                if (result.success) {
                    displayConversations(result.data);

                    // Continue polling for conversations list updates
                    startMessagePolling();
                } else {
                    console.error('Failed to load conversations:', result.message);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // Display conversations
        function displayConversations(conversations) {
            const container = document.querySelector('#direct-messages .chat-content');

            if (!conversations || conversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💬</div>
                        <h3>No Direct Messages</h3>
                        <p>Start a conversation with your classmates and teachers!</p>
                        <button class="btn btn-primary" type="button" onclick="openNewMessageModal()">
                            <i class="fas fa-plus"></i> Start New Chat
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="conversations-list">
                    ${conversations.map(conversation => `
                        <div class="conversation-item" onclick="openConversation('${conversation.partner_username}')">
                            <div class="conversation-header">
                                <div class="conversation-sender">
                                    <div class="user-avatar">${conversation.partner_username.charAt(0).toUpperCase()}</div>
                                    <div class="sender-info">
                                        <h5>${conversation.partner_username}</h5>
                                        <span class="message-time">${conversation.last_message_time ? new Date(conversation.last_message_time).toLocaleString() : ''}</span>
                                    </div>
                                </div>
                                ${conversation.unread_count > 0 ? `<div class="unread-badge">${conversation.unread_count}</div>` : ''}
                            </div>
                            <div class="last-message">
                                ${conversation.last_message_content || 'No messages yet'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Open conversation with a specific user
        async function openConversation(partnerUsername) {
            try {
                // Reset last message timestamp
                lastMessageTimestamp = null;

                // Set current conversation partner
                currentConversationPartner = partnerUsername;

                // Mark messages as read
                await fetch(`/api/messages/mark-read/${partnerUsername}`, {
                    method: 'POST'
                });

                // Load conversation messages
                const response = await fetch(`/api/messages/${partnerUsername}`);
                const result = await response.json();

                if (result.success) {
                    displayConversationMessages(partnerUsername, result.data);

                    // Start polling for new messages
                    startMessagePolling();
                } else {
                    console.error('Failed to load conversation messages:', result.message);
                }
            } catch (error) {
                console.error('Error opening conversation:', error);
            }
        }

        // Display messages in a conversation
        function displayConversationMessages(partnerUsername, messages) {
            const container = document.querySelector('#direct-messages .chat-content');
            const currentUser = '{{ session.username if session.username else "" }}'; // Get current user from session

            // Update last message timestamp for polling
            if (messages && messages.length > 0) {
                const sortedMessages = [...messages].sort((a, b) =>
                    new Date(a.created_at) - new Date(b.created_at)
                );
                lastMessageTimestamp = sortedMessages[sortedMessages.length - 1].created_at;
            }

            // Format date for better display
            const formatMessageTime = (dateString) => {
                const date = new Date(dateString);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                // Check if date is today
                if (date.toDateString() === today.toDateString()) {
                    return `Today at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
                // Check if date is yesterday
                else if (date.toDateString() === yesterday.toDateString()) {
                    return `Yesterday at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
                // Otherwise show full date
                else {
                    return date.toLocaleString([], {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            };

            // Group messages by date
            const groupMessagesByDate = (messages) => {
                const groups = {};

                messages.forEach(message => {
                    const date = new Date(message.created_at);
                    const dateString = date.toDateString();

                    if (!groups[dateString]) {
                        groups[dateString] = [];
                    }

                    groups[dateString].push(message);
                });

                return groups;
            };

            // Get avatar for user
            const getAvatarHtml = (username) => {
                return `<div class="user-avatar">${username.charAt(0).toUpperCase()}</div>`;
            };

            container.innerHTML = `
                <div class="conversation-view">
                    <div class="conversation-header-bar">
                        <button class="btn btn-outline" onclick="loadDirectMessages(true)">
                            <i class="fas fa-arrow-left"></i> Back to Conversations
                        </button>
                        <h4>
                            <i class="fas fa-user-circle"></i>
                            ${partnerUsername}
                        </h4>
                        <button class="btn btn-primary" onclick="openNewMessageModal('${partnerUsername}')">
                            <i class="fas fa-paper-plane"></i> Reply
                        </button>
                    </div>
                    <div class="messages-container">
                        ${messages.length === 0 ?
                            `<div class="empty-conversation">
                                <i class="fas fa-comments"></i>
                                <h3>No messages yet</h3>
                                <p>Start a conversation with ${partnerUsername}</p>
                                <button class="btn btn-primary" onclick="openNewMessageModal('${partnerUsername}')">
                                    <i class="fas fa-paper-plane"></i> Send Message
                                </button>
                            </div>` :
                            Object.entries(groupMessagesByDate(messages)).map(([dateString, dateMessages]) => `
                                <div class="message-date-divider">
                                    <span>${new Date(dateString).toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric'})}</span>
                                </div>
                                ${dateMessages.map(message => `
                                    <div class="message-bubble ${message.from_username === currentUser ? 'sent' : 'received'}">
                                        <div class="message-info">
                                            ${message.from_username === currentUser ?
                                                `<span class="time">${formatMessageTime(message.created_at)}</span>
                                                 <span class="sender">You</span>` :
                                                `<span class="sender">${message.from_username}</span>
                                                 <span class="time">${formatMessageTime(message.created_at)}</span>`
                                            }
                                        </div>
                                        ${message.subject ? `<div class="message-subject">${message.subject}</div>` : ''}
                                        <div class="message-text">${message.content}</div>
                                    </div>
                                `).join('')}
                            `).join('')
                        }
                    </div>
                </div>
            `;

            // Scroll to bottom of messages
            const messagesContainer = container.querySelector('.messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Update messaging tab unread count without refreshing the view
            updateMessagingTab();
        }

        // Add enter key support for search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('friendSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchFriend();
                    }
                });
            }
        });
    </script>

    <!-- Messaging initialization script -->
    <script>
        // Load messages when Direct Messages tab is accessed
        function initializeMessaging() {
            // Check if we're on the direct-messages tab and load messages
            const directMessagesTab = document.getElementById('direct-messages');
            if (directMessagesTab && directMessagesTab.classList.contains('active')) {
                loadDirectMessages();
            }
        }

        // Update messaging tab with unread count
        async function updateMessagingTab() {
            try {
                const response = await fetch('/api/conversations');
                const result = await response.json();

                if (result.success) {
                    // Calculate total unread messages
                    const totalUnread = result.data.reduce((total, conv) => total + conv.unread_count, 0);

                    // Update the messaging tab with unread count
                    const messagingTab = document.querySelector('.tab-btn[data-tab="direct-messages"]');
                    if (messagingTab) {
                        if (totalUnread > 0) {
                            messagingTab.innerHTML = `<i class="fas fa-comment"></i> Messages <span class="unread-badge">${totalUnread}</span>`;
                        } else {
                            messagingTab.innerHTML = `<i class="fas fa-comment"></i> Messages`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating messaging tab:', error);
            }
        }

        // Start polling for new messages in current conversation
        function startMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }

            messagePollingInterval = setInterval(async () => {
                if (currentConversationPartner) {
                    await checkForNewMessages();
                } else {
                    // If not in a conversation, just update the conversations list
                    const directMessagesTab = document.getElementById('direct-messages');
                    if (directMessagesTab && directMessagesTab.classList.contains('active')) {
                        const conversationView = document.querySelector('.conversation-view');
                        if (!conversationView) {
                            // We're in conversations list, refresh it
                            loadDirectMessages(true);
                        }
                    }
                }
                // Always update the messaging tab
                updateMessagingTab();
            }, 3000); // Check every 3 seconds
        }

        // Stop polling for messages
        function stopMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
        }

        // Check for new messages in current conversation
        async function checkForNewMessages() {
            if (!currentConversationPartner) return;

            try {
                const response = await fetch(`/api/messages/${currentConversationPartner}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    const messages = result.data;
                    const latestMessage = messages[messages.length - 1];
                    const latestTimestamp = latestMessage.created_at;

                    // If we have a new message (timestamp is newer than last known)
                    if (!lastMessageTimestamp || latestTimestamp > lastMessageTimestamp) {
                        lastMessageTimestamp = latestTimestamp;

                        // Only refresh if we actually have new messages
                        if (lastMessageTimestamp !== latestMessage.created_at || messages.length > 0) {
                            displayConversationMessages(currentConversationPartner, messages);

                            // Mark new messages as read
                            await fetch(`/api/messages/mark-read/${currentConversationPartner}`, {
                                method: 'POST'
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking for new messages:', error);
            }
        }

        // Initialize messaging when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure all other scripts have loaded
            setTimeout(() => {
                initializeMessaging();
                updateMessagingTab();

                // Start message polling
                startMessagePolling();

                // Handle tab switching to ensure polling continues
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        if (tabId === 'direct-messages') {
                            // Restart polling when switching to messages tab
                            startMessagePolling();
                        }
                    });
                });

                // Handle page visibility changes
                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible') {
                        // Restart polling when page becomes visible
                        startMessagePolling();
                    } else {
                        // Stop polling when page is hidden to save resources
                        stopMessagePolling();
                    }
                });
            }, 500);
        });
    </script>

    <!-- Team Management JavaScript -->
    <script>
        // Team Management Functions
        let currentTeamForInvitation = null;

        // Show create team modal
        function showCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'flex';
        }

        // Close create team modal
        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'none';
            document.getElementById('createTeamForm').reset();
        }

        // Handle create team form submission
        document.getElementById('createTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const teamName = document.getElementById('teamName').value.trim();
            const teamDescription = document.getElementById('teamDescription').value.trim();

            if (!teamName) {
                showNotification('Team name is required', 'error');
                return;
            }

            try {
                const response = await fetch('/api/teams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: teamName,
                        description: teamDescription
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Team created successfully!', 'success');
                    closeCreateTeamModal();
                    loadTeams(); // Refresh teams list
                } else {
                    showNotification(result.message || 'Failed to create team', 'error');
                }
            } catch (error) {
                console.error('Error creating team:', error);
                showNotification('Error creating team', 'error');
            }
        });

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const result = await response.json();

                if (result.success) {
                    displayTeams(result.teams);
                    loadTeamInvitations(); // Also load invitations
                } else {
                    console.error('Failed to load teams:', result.message);
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        // Display teams
        function displayTeams(teams) {
            const teamContent = document.getElementById('teamContent');
            const emptyState = document.getElementById('teamEmptyState');
            const teamsList = document.getElementById('teamsList');

            if (teams.length === 0) {
                emptyState.style.display = 'block';
                teamsList.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                teamsList.style.display = 'block';

                teamsList.innerHTML = teams.map(team => `
                    <div class="team-card">
                        <div class="team-header">
                            <h4 class="team-name">${team.name}</h4>
                            <span class="team-role ${team.role}">
                                ${team.role === 'owner' ? '👑 Owner' :
                                  team.role === 'star' ? '⭐ Star' :
                                  '👤 Member'}
                            </span>
                        </div>
                        ${team.description ? `<p class="team-description">${team.description}</p>` : ''}
                        <div class="team-members">
                            <i class="fas fa-users"></i>
                            <span class="team-member-count">${team.members ? team.members.length : 0} members</span>
                        </div>
                        <div class="team-actions">
                            ${team.role === 'owner' || team.role === 'star' ? `
                                <button class="btn btn-primary btn-sm" onclick="showTeamInvitationModal('${team.id}', '${team.name}')">
                                    <i class="fas fa-user-plus"></i> Invite Friends
                                </button>
                            ` : ''}
                            <button class="btn btn-success btn-sm" onclick="openTeamChat('${team.id}', '${team.name}')">
                                <i class="fas fa-comments"></i> Team Chat
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="viewTeamDetails('${team.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Show team invitation modal
        function showTeamInvitationModal(teamId, teamName) {
            currentTeamForInvitation = teamId;
            document.getElementById('inviteTeamName').textContent = teamName;
            loadFriendsForTeamInvitation();
            document.getElementById('teamInvitationModal').style.display = 'flex';
        }

        // Close team invitation modal
        function closeTeamInvitationModal() {
            document.getElementById('teamInvitationModal').style.display = 'none';
            currentTeamForInvitation = null;
        }

        // Load friends for team invitation
        async function loadFriendsForTeamInvitation() {
            try {
                const response = await fetch('/api/friend-requests');
                const result = await response.json();

                if (result.success && result.data.friends) {
                    displayFriendsForInvitation(result.data.friends);
                } else {
                    document.getElementById('friendsInviteList').innerHTML = `
                        <div class="empty-state">
                            <p>No friends available to invite</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading friends:', error);
                document.getElementById('friendsInviteList').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading friends</p>
                    </div>
                `;
            }
        }

        // Display friends for invitation
        function displayFriendsForInvitation(friends) {
            const container = document.getElementById('friendsInviteList');

            if (friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No friends available to invite</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.map(friend => `
                <div class="friend-invite-item">
                    <input type="checkbox" class="friend-invite-checkbox" value="${friend.username}" id="invite-${friend.username}">
                    <div class="friend-invite-avatar">${friend.username.charAt(0).toUpperCase()}</div>
                    <div class="friend-invite-details">
                        <p class="friend-invite-name">${friend.student_name || friend.username}</p>
                        <p class="friend-invite-username">@${friend.username}</p>
                    </div>
                </div>
            `).join('');
        }

        // Send team invitations
        async function sendTeamInvitations() {
            if (!currentTeamForInvitation) {
                showNotification('No team selected', 'error');
                return;
            }

            const selectedFriends = Array.from(document.querySelectorAll('.friend-invite-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (selectedFriends.length === 0) {
                showNotification('Please select at least one friend to invite', 'error');
                return;
            }

            try {
                const response = await fetch('/api/team-invitations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        team_id: currentTeamForInvitation,
                        friends: selectedFriends
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show detailed success message
                    let message = `✅ Sent ${result.successful.length} team invitation${result.successful.length > 1 ? 's' : ''} successfully!`;
                    if (result.failed.length > 0) {
                        message += `\n⚠️ ${result.failed.length} invitation${result.failed.length > 1 ? 's' : ''} failed to send.`;
                        result.failed.forEach(failed => {
                            console.log(`Failed to invite ${failed.username}: ${failed.reason}`);
                        });
                    }
                    showNotification(message, 'success');
                    closeTeamInvitationModal();

                    // Refresh friend requests to show sent invitations
                    if (typeof loadFriendRequests === 'function') {
                        loadFriendRequests();
                    }
                } else {
                    showNotification(result.message || 'Failed to send invitations', 'error');
                }
            } catch (error) {
                console.error('Error sending invitations:', error);
                showNotification('Error sending invitations', 'error');
            }
        }

        // Load team invitations
        async function loadTeamInvitations() {
            try {
                const response = await fetch('/api/team-invitations');
                const result = await response.json();

                if (result.success) {
                    displayTeamInvitations(result.invitations);
                } else {
                    console.error('Failed to load team invitations:', result.message);
                }
            } catch (error) {
                console.error('Error loading team invitations:', error);
            }
        }

        // Display team invitations
        function displayTeamInvitations(invitations) {
            const container = document.getElementById('teamInvitationsContainer');
            const content = document.getElementById('teamInvitationsContent');

            if (invitations.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            content.innerHTML = invitations.map(invitation => `
                <div class="team-invitation-card">
                    <div class="invitation-header">
                        <div class="invitation-info">
                            <h4>Team Invitation: ${invitation.team_name}</h4>
                            <p>From: ${invitation.from_name} (@${invitation.from_username})</p>
                            <p style="font-size: 0.8rem; color: #999;">
                                Received: ${new Date(invitation.created_at).toLocaleDateString()}
                            </p>
                        </div>
                        <div class="invitation-actions">
                            <button class="btn btn-success btn-sm" onclick="respondToTeamInvitation('${invitation.id}', 'accept')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="respondToTeamInvitation('${invitation.id}', 'decline')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Respond to team invitation
        async function respondToTeamInvitation(invitationId, action) {
            try {
                const response = await fetch(`/api/team-invitations/${invitationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    loadTeamInvitations(); // Refresh invitations
                    loadTeams(); // Refresh teams list
                    loadFriendRequests(); // Refresh friend requests to update sent list
                } else {
                    showNotification(result.message || 'Failed to respond to invitation', 'error');
                }
            } catch (error) {
                console.error('Error responding to invitation:', error);
                showNotification('Error responding to invitation', 'error');
            }
        }

        // Delete team invitation (for declined invitations)
        async function deleteTeamInvitation(invitationId) {
            if (!confirm('Are you sure you want to delete this invitation?')) {
                return;
            }

            try {
                const response = await fetch(`/api/team-invitations/${invitationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Invitation deleted successfully', 'success');
                    loadFriendRequests(); // Refresh to remove from sent list
                } else {
                    showNotification(result.message || 'Failed to delete invitation', 'error');
                }
            } catch (error) {
                console.error('Error deleting invitation:', error);
                showNotification('Error deleting invitation', 'error');
            }
        }

        // Toggle star member status
        async function toggleStarMember(teamId, username, currentlyStarred) {
            const action = currentlyStarred ? 'remove' : 'add';
            const actionText = currentlyStarred ? 'remove star from' : 'make star member';

            if (!confirm(`Are you sure you want to ${actionText} ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/teams/${teamId}/star-member`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        action: action
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    loadTeams(); // Refresh teams list
                    // Close and reopen team details to refresh
                    closeTeamDetailsModal();
                } else {
                    showNotification(result.message || 'Failed to update member status', 'error');
                }
            } catch (error) {
                console.error('Error updating member status:', error);
                showNotification('Error updating member status', 'error');
            }
        }

        // Remove member from team
        async function removeMemberFromTeam(teamId, username) {
            if (!confirm(`Are you sure you want to remove ${username} from the team?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/teams/${teamId}/remove-member`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    loadTeams(); // Refresh teams list
                    // Close and reopen team details to refresh
                    closeTeamDetailsModal();
                } else {
                    showNotification(result.message || 'Failed to remove member', 'error');
                }
            } catch (error) {
                console.error('Error removing member:', error);
                showNotification('Error removing member', 'error');
            }
        }

        // Confirm team dismantling
        function confirmDismantleTeam(teamId, teamName) {
            const confirmation = prompt(`To dismantle the team "${teamName}", type "DELETE" to confirm:`);
            if (confirmation === 'DELETE') {
                dismantleTeam(teamId);
            } else if (confirmation !== null) {
                showNotification('Team dismantling cancelled - incorrect confirmation', 'info');
            }
        }

        // Dismantle team
        async function dismantleTeam(teamId) {
            try {
                const response = await fetch(`/api/teams/${teamId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Team dismantled successfully', 'success');
                    loadTeams(); // Refresh teams list
                    closeTeamDetailsModal();
                } else {
                    showNotification(result.message || 'Failed to dismantle team', 'error');
                }
            } catch (error) {
                console.error('Error dismantling team:', error);
                showNotification('Error dismantling team', 'error');
            }
        }

        // View team details
        async function viewTeamDetails(teamId) {
            try {
                const response = await fetch('/api/teams');
                const result = await response.json();

                if (result.success) {
                    const team = result.teams.find(t => t.id === teamId);
                    if (team) {
                        showTeamDetailsModal(team);
                    } else {
                        showNotification('Team not found', 'error');
                    }
                } else {
                    showNotification('Failed to load team details', 'error');
                }
            } catch (error) {
                console.error('Error loading team details:', error);
                showNotification('Error loading team details', 'error');
            }
        }

        // Show team details modal
        function showTeamDetailsModal(team) {
            const membersList = team.member_details ?
                Object.entries(team.member_details).map(([username, details]) => {
                    const isOwner = username === team.owner;
                    const isStar = details.role === 'star';
                    const isCurrentUser = username === currentUsername;
                    const canManageStars = team.owner === currentUsername;

                    // Check if current user is star member
                    const currentUserIsStar = team.member_details &&
                                            team.member_details[currentUsername] &&
                                            team.member_details[currentUsername].role === 'star';

                    return `
                        <div class="member-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center;">
                                <div class="member-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">
                                    ${username.charAt(0).toUpperCase()}
                                </div>
                                <div class="member-info">
                                    <h5 style="margin: 0; font-size: 14px; color: #333;">${details.name || username}</h5>
                                    <p style="margin: 2px 0; font-size: 12px; color: #666;">@${username}</p>
                                    <p style="margin: 0; font-size: 11px; color: #999;">
                                        ${isOwner ? '👑 Owner' : isStar ? '⭐ Star Member' : '👤 Member'} •
                                        Joined ${new Date(details.joined_at).toLocaleDateString()}
                                    </p>
                                </div>
                            </div>
                            <div class="member-actions" style="display: flex; align-items: center; gap: 8px;">
                                ${canManageStars && !isOwner ? `
                                    <button class="btn btn-sm ${isStar ? 'btn-warning' : 'btn-outline'}"
                                            onclick="toggleStarMember('${team.id}', '${username}', ${isStar})"
                                            title="${isStar ? 'Remove Star' : 'Make Star Member'}"
                                            style="padding: 4px 8px; font-size: 12px;">
                                        <i class="fas fa-star"></i>
                                    </button>
                                ` : ''}
                                ${(canManageStars || currentUserIsStar) && !isOwner && !isCurrentUser ? `
                                    <button class="btn btn-outline btn-sm"
                                            onclick="removeMemberFromTeam('${team.id}', '${username}')"
                                            title="Remove Member"
                                            style="padding: 4px 8px; font-size: 12px; color: #dc3545; border-color: #dc3545;">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('') : '<p>No member details available</p>';

            const modalContent = `
                <div class="modal" id="teamDetailsModal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>👥 ${team.name}</h3>
                            <button class="modal-close" onclick="closeTeamDetailsModal()" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="team-info">
                                <p><strong>Description:</strong> ${team.description || 'No description provided'}</p>
                                <p><strong>Owner:</strong> ${team.owner_name || team.owner}</p>
                                <p><strong>Created:</strong> ${new Date(team.created_at).toLocaleDateString()}</p>
                                <p><strong>Members:</strong> ${team.members ? team.members.length : 0}</p>
                            </div>
                            <div class="team-members-list">
                                <h4>Team Members:</h4>
                                <div class="members-container">
                                    ${membersList}
                                </div>
                                ${team.owner === currentUsername ? `
                                    <div class="team-management" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                                        <h5 style="color: #333; margin-bottom: 12px;">Team Management</h5>
                                        <button class="btn btn-danger btn-sm" onclick="confirmDismantleTeam('${team.id}', '${team.name}')" style="margin-right: 8px;">
                                            <i class="fas fa-trash"></i> Dismantle Team
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('teamDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // Close team details modal
        function closeTeamDetailsModal() {
            const modal = document.getElementById('teamDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open team chat
        function openTeamChat(teamId, teamName) {
            currentTeamChatId = teamId;
            currentTeamChatName = teamName;
            showTeamChatModal(teamId, teamName);
            loadTeamMessages(teamId);
        }

        // Global variables for team chat
        let currentTeamChatId = null;
        let currentTeamChatName = null;
        let teamChatRefreshInterval = null;
        let currentlyEditingMessageId = null;
        let currentUsername = null;

        // Fresh scroll system variables
        let isUserScrolling = false;
        let shouldAutoScroll = true;

        // Function to resume auto-refresh
        function resumeAutoRefresh() {
            if (currentTeamChatId && !teamChatRefreshInterval) {
                teamChatRefreshInterval = setInterval(() => {
                    if (currentTeamChatId && !currentlyEditingMessageId) {
                        loadTeamMessages(currentTeamChatId, false);
                    }
                }, 3000);
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fresh scroll system - simple and reliable
        function scrollToBottom() {
            const container = document.getElementById('teamChatMessages');
            if (container) {
                container.scrollTop = container.scrollHeight;
                shouldAutoScroll = true;
            }
        }

        function isAtBottom() {
            const container = document.getElementById('teamChatMessages');
            if (!container) return true;

            const threshold = 50; // 50px from bottom
            return container.scrollHeight - container.scrollTop - container.clientHeight <= threshold;
        }

        function setupFreshScrollDetection() {
            const container = document.getElementById('teamChatMessages');
            if (!container) return;

            container.addEventListener('scroll', () => {
                // Simple logic: if user scrolls up from bottom, disable auto-scroll
                if (isAtBottom()) {
                    shouldAutoScroll = true;
                } else {
                    shouldAutoScroll = false;
                }
            });
        }

        // Show team chat modal
        function showTeamChatModal(teamId, teamName) {
            const modalContent = `
                <div class="modal" id="teamChatModal" style="display: flex;">
                    <div class="modal-content" style="width: 90%; max-width: 800px; height: 80vh;">
                        <div class="modal-header">
                            <h3>💬 ${teamName} - Team Chat</h3>
                            <button class="modal-close" onclick="closeTeamChatModal()" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="display: flex; flex-direction: column; height: calc(100% - 60px);">
                            <div class="team-chat-messages" id="teamChatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: #f8f9fa; border-radius: 8px; margin-bottom: 16px;">
                                <div class="loading-messages">
                                    <i class="fas fa-spinner fa-spin"></i> Loading messages...
                                </div>
                            </div>
                            <div class="team-chat-input-container">
                                <div class="chat-input-row">
                                    <button type="button" class="chat-action-btn" onclick="triggerFileUpload('image')" title="Upload Image">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button type="button" class="chat-action-btn" onclick="triggerFileUpload('pdf')" title="Upload PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <input type="text" id="teamChatInput" class="chat-input-field" placeholder="Type your message..." onkeypress="handleTeamChatKeyPress(event)" autocomplete="off">
                                    <button type="button" class="chat-send-btn" onclick="sendTeamMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden file inputs -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'image')">
                <input type="file" id="pdfUpload" accept=".pdf" style="display: none;" onchange="handleFileUpload(this, 'pdf')">
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('teamChatModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalContent);

            // Setup fresh scroll detection
            setTimeout(() => {
                setupFreshScrollDetection();
                shouldAutoScroll = true; // Always start with auto-scroll enabled
            }, 100);

            // Start auto-refresh for messages
            teamChatRefreshInterval = setInterval(() => {
                if (currentTeamChatId && !currentlyEditingMessageId) {
                    loadTeamMessages(currentTeamChatId, false); // false = don't show loading
                }
            }, 3000); // Refresh every 3 seconds
        }

        // Close team chat modal
        function closeTeamChatModal() {
            const modal = document.getElementById('teamChatModal');
            if (modal) {
                modal.remove();
            }

            // Clear refresh interval
            if (teamChatRefreshInterval) {
                clearInterval(teamChatRefreshInterval);
                teamChatRefreshInterval = null;
            }

            currentTeamChatId = null;
            currentTeamChatName = null;
        }

        // Load team messages
        async function loadTeamMessages(teamId, showLoading = true) {
            try {
                const response = await fetch(`/api/team-messages/${teamId}`);
                const result = await response.json();

                if (result.success) {
                    displayTeamMessages(result.messages, showLoading);
                } else {
                    if (showLoading) {
                        document.getElementById('teamChatMessages').innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-triangle"></i> ${result.message || 'Failed to load messages'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading team messages:', error);
                if (showLoading) {
                    document.getElementById('teamChatMessages').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i> Error loading messages
                        </div>
                    `;
                }
            }
        }

        // Display team messages
        function displayTeamMessages(messages, showLoading = true) {
            const container = document.getElementById('teamChatMessages');
            if (!container) return;

            // Fresh scroll approach - simple check
            const wasAtBottom = isAtBottom();

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-chat">
                        <i class="fas fa-comments"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            const currentUser = '{{ session.get("username", "") }}';

            container.innerHTML = messages.map(message => {
                const isOwnMessage = message.from_username === currentUser;
                const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                let messageContent = '';

                if (message.type === 'text') {
                    messageContent = `<p class="message-text" data-original="${escapeHtml(message.content)}">${escapeHtml(message.content)}</p>`;
                } else if (message.type === 'image') {
                    messageContent = `
                        <div class="message-image">
                            <img src="${message.file_url}" alt="${message.file_name}" onclick="openImageModal('${message.file_url}', '${message.file_name}')" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;">
                            <div class="file-actions">
                                <button class="download-btn" onclick="downloadFile('${message.file_url}', '${message.file_name || 'image.jpg'}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            ${message.content ? `<p class="file-caption">${escapeHtml(message.content)}</p>` : ''}
                        </div>
                    `;
                } else if (message.type === 'pdf') {
                    messageContent = `
                        <div class="message-file">
                            <div class="file-icon">
                                <i class="fas fa-file-pdf" style="color: #dc3545;"></i>
                            </div>
                            <div class="file-info">
                                <a href="${message.file_url}" target="_blank" class="file-link">${message.file_name}</a>
                                <div class="file-actions">
                                    <button class="download-btn" onclick="downloadFile('${message.file_url}', '${message.file_name || 'document.pdf'}')" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                ${message.content ? `<p class="file-caption">${escapeHtml(message.content)}</p>` : ''}
                            </div>
                        </div>
                    `;

                }

                // Add edit/delete buttons for current user's messages
                const messageActions = isOwnMessage ? `
                    <div class="message-actions">
                        ${message.type === 'text' ? `<button onclick="event.stopPropagation(); console.log('Edit button clicked for message:', '${message.id}'); editMessage('${message.id}')" title="Edit" style="width: 28px; height: 28px; background: #007bff; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 4px;">
                            ✏️
                        </button>` : ''}
                        <button onclick="event.stopPropagation(); deleteMessage('${message.id}')" title="Delete" style="width: 28px; height: 28px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 4px;">
                            🗑️
                        </button>
                    </div>
                ` : '';

                return `
                    <div class="chat-message ${isOwnMessage ? 'own-message' : 'other-message'}" data-message-id="${message.id}">
                        <div class="message-header">
                            <span class="sender-name">${isOwnMessage ? 'You' : message.from_name}</span>
                            <span class="message-time">${messageTime}</span>
                            ${messageActions}
                        </div>
                        <div class="message-content">
                            ${messageContent}
                        </div>
                    </div>
                `;
            }).join('');

            // Fresh scroll logic - simple and reliable
            if (shouldAutoScroll || showLoading) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 10);
            }
        }

        // Send team message
        async function sendTeamMessage(messageType = 'text', fileUrl = '', fileName = '') {
            const input = document.getElementById('teamChatInput');
            const content = input.value.trim();

            if (!content && messageType === 'text') {
                return;
            }

            if (!currentTeamChatId) {
                showNotification('No team selected', 'error');
                return;
            }

            try {
                const response = await fetch('/api/team-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        team_id: currentTeamChatId,
                        content: content || (messageType !== 'text' ? fileName : ''),
                        type: messageType,
                        file_url: fileUrl,
                        file_name: fileName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    input.value = '';
                    loadTeamMessages(currentTeamChatId, false);
                } else {
                    showNotification(result.message || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending team message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        // Handle enter key press in team chat
        function handleTeamChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendTeamMessage();
            }
        }

        // Trigger file upload
        function triggerFileUpload(type) {
            if (type === 'image') {
                document.getElementById('imageUpload').click();
            } else if (type === 'pdf') {
                document.getElementById('pdfUpload').click();
            }
        }

        // Handle file upload
        async function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            if (!currentTeamChatId) {
                showNotification('No team selected', 'error');
                return;
            }

            // Show uploading message
            showNotification('Uploading file...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('team_id', currentTeamChatId);

                const response = await fetch('/api/team-file-upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Send message with file
                    await sendTeamMessage(result.message_type, result.file_url, result.file_name);
                    showNotification('File uploaded successfully!', 'success');
                } else {
                    showNotification(result.message || 'Failed to upload file', 'error');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                showNotification('Error uploading file', 'error');
            }

            // Reset input
            input.value = '';
        }

        // Voice recording feature removed

        // Download file function
        async function downloadFile(fileUrl, fileName) {
            try {
                const response = await fetch(fileUrl);
                const blob = await response.blob();

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification('File downloaded successfully', 'success');
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('Failed to download file', 'error');
            }
        }

        // Edit message function
        function editMessage(messageId) {
            console.log('=== EDIT MESSAGE START ===');
            console.log('Edit message called for ID:', messageId);
            console.log('Current editing state:', currentlyEditingMessageId);

            // Prevent multiple edits
            if (currentlyEditingMessageId) {
                console.log('Already editing message:', currentlyEditingMessageId, '- aborting new edit');
                return;
            }

            // Check if already editing this message
            const existingContainer = document.querySelector('.edit-message-container');
            if (existingContainer) {
                console.log('Edit container already exists, aborting');
                return;
            }

            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.log('ERROR: Message element not found for ID:', messageId);
                return;
            }
            console.log('✓ Message element found:', messageElement);

            const messageTextElement = messageElement.querySelector('.message-text');
            if (!messageTextElement) {
                console.log('ERROR: Message text element not found');
                return;
            }
            console.log('✓ Message text element found:', messageTextElement);

            // Set editing state and pause auto-refresh
            currentlyEditingMessageId = messageId;
            console.log('✓ Setting edit state for message:', messageId);

            // Pause auto-refresh while editing
            if (teamChatRefreshInterval) {
                console.log('✓ Pausing auto-refresh during edit');
                clearInterval(teamChatRefreshInterval);
                teamChatRefreshInterval = null;
            }

            const originalText = messageTextElement.getAttribute('data-original');
            const currentText = messageTextElement.textContent;

            // Create edit container to wrap everything
            const editContainer = document.createElement('div');
            editContainer.className = 'edit-message-container';
            editContainer.style.cssText = `
                background: white;
                border: 2px solid #007bff;
                border-radius: 8px;
                padding: 12px;
                margin: 4px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;

            // Create edit input
            const editInput = document.createElement('input');
            editInput.type = 'text';
            editInput.value = currentText;
            editInput.className = 'edit-message-input';
            editInput.style.cssText = `
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                background: white;
                color: #333;
                outline: none;
                margin-bottom: 8px;
            `;

            // Create action buttons
            const actionButtons = document.createElement('div');
            actionButtons.className = 'edit-actions';
            actionButtons.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end;';

            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '✓ Save';
            saveBtn.className = 'btn btn-sm btn-success';
            saveBtn.style.cssText = 'padding: 6px 12px; font-size: 12px;';
            saveBtn.onclick = (e) => {
                e.stopPropagation();
                e.preventDefault();
                saveMessageEdit(messageId, editInput.value);
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = '✕ Cancel';
            cancelBtn.className = 'btn btn-sm btn-secondary';
            cancelBtn.style.cssText = 'padding: 6px 12px; font-size: 12px;';
            cancelBtn.onclick = (e) => {
                e.stopPropagation();
                e.preventDefault();
                cancelMessageEdit(messageId, originalText);
            };

            actionButtons.appendChild(saveBtn);
            actionButtons.appendChild(cancelBtn);

            // Add input and buttons to container
            editContainer.appendChild(editInput);
            editContainer.appendChild(actionButtons);

            // Replace text with edit container
            messageTextElement.style.display = 'none';
            messageTextElement.parentNode.insertBefore(editContainer, messageTextElement.nextSibling);

            editInput.focus();
            editInput.select();

            // Handle Enter and Escape keys only
            editInput.addEventListener('keydown', (e) => {
                e.stopPropagation(); // Prevent any parent handlers
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveMessageEdit(messageId, editInput.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelMessageEdit(messageId, originalText);
                }
            });

            // Prevent ALL click events from bubbling up from the edit container
            editContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
            });

            // Prevent any other events that might close the edit interface
            editContainer.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });

            editContainer.addEventListener('mouseup', (e) => {
                e.stopPropagation();
            });

            // Focus protection - prevent losing focus accidentally
            editInput.addEventListener('blur', (e) => {
                // Only allow blur if clicking on save/cancel buttons
                const relatedTarget = e.relatedTarget;
                if (!relatedTarget || (!relatedTarget.closest('.edit-actions'))) {
                    setTimeout(() => {
                        if (document.querySelector('.edit-message-input')) {
                            editInput.focus();
                        }
                    }, 10);
                }
            });
        }

        // Save message edit
        async function saveMessageEdit(messageId, newContent) {
            console.log('Saving edit for message:', messageId, 'Content:', newContent);

            if (!newContent.trim()) {
                showNotification('Message cannot be empty', 'error');
                return;
            }

            // Clear editing state immediately
            currentlyEditingMessageId = null;

            // Immediately close the edit interface to prevent double-clicking
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const editContainer = messageElement?.querySelector('.edit-message-container');
            const messageTextElement = messageElement?.querySelector('.message-text');

            if (editContainer) {
                console.log('Removing edit container after save');
                editContainer.remove();
            }

            if (messageTextElement) {
                messageTextElement.style.display = '';
                messageTextElement.textContent = newContent.trim(); // Show new content immediately
                console.log('Updated text to:', newContent.trim());
            }

            try {
                const response = await fetch(`/api/team-messages/${messageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: newContent.trim()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Message updated successfully', 'success');
                    // Resume auto-refresh
                    resumeAutoRefresh();
                    // Refresh messages to get the updated version
                    setTimeout(() => {
                        loadTeamMessages(currentTeamChatId, false);
                    }, 500);
                } else {
                    showNotification(result.message || 'Failed to update message', 'error');
                    // Revert the text if save failed
                    if (messageTextElement) {
                        messageTextElement.textContent = messageTextElement.getAttribute('data-original');
                    }
                    // Resume auto-refresh even on failure
                    resumeAutoRefresh();
                }
            } catch (error) {
                console.error('Error updating message:', error);
                showNotification('Failed to update message', 'error');
                // Revert the text if save failed
                if (messageTextElement) {
                    messageTextElement.textContent = messageTextElement.getAttribute('data-original');
                }
                // Resume auto-refresh even on error
                resumeAutoRefresh();
            }
        }

        // Cancel message edit
        function cancelMessageEdit(messageId, originalText) {
            console.log('Canceling edit for message:', messageId);

            // Clear editing state
            currentlyEditingMessageId = null;

            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.log('Message element not found during cancel');
                return;
            }

            const editContainer = messageElement.querySelector('.edit-message-container');
            const messageTextElement = messageElement.querySelector('.message-text');

            if (editContainer) {
                console.log('Removing edit container');
                editContainer.remove();
            }

            if (messageTextElement) {
                messageTextElement.style.display = '';
                messageTextElement.textContent = originalText;
                console.log('Restored original text:', originalText);
            }

            console.log('Edit canceled successfully');

            // Resume auto-refresh
            resumeAutoRefresh();
        }

        // Delete message function
        async function deleteMessage(messageId) {
            console.log('Delete message called for ID:', messageId);
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const response = await fetch(`/api/team-messages/${messageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Message deleted successfully', 'success');
                    loadTeamMessages(currentTeamChatId, false);
                } else {
                    showNotification(result.message || 'Failed to delete message', 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Failed to delete message', 'error');
            }
        }



        // Open image in modal
        function openImageModal(imageUrl, imageName) {
            const modalContent = `
                <div class="modal" id="imageModal" style="display: flex; background: rgba(0,0,0,0.8);">
                    <div class="modal-content" style="background: transparent; border: none; box-shadow: none; max-width: 90%; max-height: 90%;">
                        <div class="modal-header" style="background: rgba(0,0,0,0.7); color: white;">
                            <h3>${imageName}</h3>
                            <button class="modal-close" onclick="closeImageModal()" type="button" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 0;">
                            <img src="${imageUrl}" alt="${imageName}" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // Load teams when team tab is accessed
        document.addEventListener('DOMContentLoaded', function() {
            const teamTab = document.querySelector('[data-tab="team"]');
            if (teamTab) {
                teamTab.addEventListener('click', function() {
                    setTimeout(() => {
                        loadTeams();
                    }, 100);
                });
            }
        });
    </script>

    <!-- Load external JavaScript file -->
    <script src="{{ url_for('static', filename='js/script.js') }}?v=6.2"></script>


</body>
</html>







</body>
</html>
